<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Authentication Migration Tool</title>
    <style>
        :root {
            --bg-canvas: #0d1117;
            --bg-default: #161b22;
            --bg-overlay: #21262d;
            --bg-subtle: #30363d;
            --border-default: #30363d;
            --border-muted: #21262d;
            --fg-default: #f0f6fc;
            --fg-muted: #8b949e;
            --fg-subtle: #6e7681;
            --accent-fg: #58a6ff;
            --accent-emphasis: #1f6feb;
            --success-fg: #3fb950;
            --danger-fg: #f85149;
            --attention-fg: #d29922;
            --btn-primary-bg: #238636;
            --btn-primary-hover-bg: #2ea043;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-canvas);
            color: var(--fg-default);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            line-height: 1.5;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-default);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-default);
        }

        .header h1 {
            color: var(--accent-fg);
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            color: var(--fg-muted);
            font-size: 16px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 12px;
        }

        .status-indicator.ready {
            background: rgba(63, 185, 80, 0.1);
            color: var(--success-fg);
            border: 1px solid var(--success-fg);
        }

        .status-indicator.not-ready {
            background: rgba(248, 81, 73, 0.1);
            color: var(--danger-fg);
            border: 1px solid var(--danger-fg);
        }

        .info-box {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid var(--accent-fg);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .info-title {
            color: var(--accent-fg);
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checklist {
            margin-left: 20px;
            color: var(--fg-muted);
        }

        .checklist li {
            margin: 8px 0;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .checklist li::before {
            content: '‚ñ°';
            color: var(--fg-subtle);
            font-weight: 600;
            margin-top: -2px;
        }

        .checklist li.checked::before {
            content: '‚úì';
            color: var(--success-fg);
        }

        .warning {
            background: rgba(210, 153, 34, 0.1);
            border: 1px solid var(--attention-fg);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .warning-title {
            color: var(--attention-fg);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warning ul {
            margin: 12px 0 0 20px;
            color: var(--fg-muted);
        }

        .warning ul li {
            margin: 4px 0;
        }

        .form-section {
            background: var(--bg-subtle);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--fg-default);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            background: var(--bg-canvas);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 12px;
            color: var(--fg-default);
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-emphasis);
            box-shadow: 0 0 0 2px rgba(31, 111, 235, 0.1);
        }

        .form-group small {
            color: var(--fg-muted);
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        .btn {
            background: var(--btn-primary-bg);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover:not(:disabled) {
            background: var(--btn-primary-hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            background: var(--fg-subtle);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--fg-default);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-overlay);
            border-color: var(--accent-emphasis);
        }

        .btn-danger {
            background: var(--danger-fg);
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success-fg);
        }

        .btn-success:hover:not(:disabled) {
            background: #2d7d32;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .test-results {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-canvas);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            display: none;
        }

        .test-results h3 {
            color: var(--accent-fg);
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 600;
        }

        .test-item {
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg-default);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .test-item:last-child {
            margin-bottom: 0;
        }

        .test-icon {
            font-size: 18px;
        }

        .test-content {
            flex: 1;
        }

        .test-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .test-detail {
            font-size: 12px;
            color: var(--fg-muted);
        }

        .test-pass {
            color: var(--success-fg);
        }

        .test-fail {
            color: var(--danger-fg);
        }

        .test-summary {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-default);
            border-radius: 6px;
            text-align: center;
        }

        .status {
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-weight: 500;
        }

        .status.success {
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid var(--success-fg);
            color: var(--success-fg);
        }

        .status.error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--danger-fg);
            color: var(--danger-fg);
        }

        .status.info {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid var(--accent-fg);
            color: var(--accent-fg);
        }

        .output {
            background: #000;
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
        }

        .output::-webkit-scrollbar {
            width: 8px;
        }

        .output::-webkit-scrollbar-track {
            background: var(--bg-subtle);
        }

        .output::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-default);
        }

        .output-title {
            color: var(--accent-fg);
            font-weight: 600;
        }

        .success {
            color: var(--success-fg);
        }

        .error {
            color: var(--danger-fg);
        }

        .info {
            color: var(--accent-fg);
        }

        .warning-text {
            color: var(--attention-fg);
        }

        .footer-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-default);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-subtle);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-fg);
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Secure Authentication Migration Tool</h1>
            <p>Upgrade your user database to industry-standard security</p>
            <div class="status-indicator not-ready" id="statusIndicator">
                <span>‚óè</span>
                <span>Not Connected</span>
            </div>
        </div>

        <div class="info-box">
            <div class="info-title">
                <span>üìã</span>
                <span>Pre-Migration Checklist</span>
            </div>
            <ul class="checklist">
                <li id="check-env">Set MIGRATION_KEY environment variable in Netlify</li>
                <li id="check-deploy">Deploy the migrate-to-secure-auth.js function</li>
                <li id="check-backup">Ensure you have a manual backup (automatic backups will be created)</li>
                <li id="check-test">Run connection test to verify setup</li>
                <li id="check-ready">Review migration warnings and confirm readiness</li>
            </ul>
        </div>

        <div class="warning">
            <div class="warning-title">
                <span>‚ö†Ô∏è</span>
                <span>Critical Information - Please Read</span>
            </div>
            <ul>
                <li><strong>This migration is PERMANENT and IRREVERSIBLE</strong></li>
                <li>All passwords will be converted from plain text to bcrypt hashes</li>
                <li>Users will use their SAME passwords after migration</li>
                <li>The migration creates automatic backups with prefix: backup_migration_</li>
                <li>Only run this migration ONCE - it detects already migrated users</li>
                <li>After migration, all authentication will use the secure system</li>
            </ul>
        </div>

        <div class="form-section">
            <form id="migrationForm">
                <div class="form-group">
                    <label for="migrationKey">Migration Security Key</label>
                    <input 
                        type="password" 
                        id="migrationKey" 
                        required 
                        placeholder="Enter your migration key"
                        autocomplete="off"
                    >
                    <small>This must match the MIGRATION_KEY environment variable set in your Netlify dashboard</small>
                </div>

                <div class="form-group">
                    <label for="apiEndpoint">Migration API Endpoint</label>
                    <input 
                        type="url" 
                        id="apiEndpoint" 
                        value="https://f.afsapp.lol/.netlify/functions/migrate-to-secure-auth" 
                        required
                    >
                    <small>The URL to your deployed migration function</small>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="testConnection()">
                        <span>üîç</span>
                        <span>Test Connection</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="performDryRun()">
                        <span>üß™</span>
                        <span>Dry Run</span>
                    </button>
                    <button type="submit" class="btn btn-danger" id="runMigrationBtn" disabled>
                        <span>üöÄ</span>
                        <span>Run Migration</span>
                    </button>
                </div>
            </form>

            <div class="progress-bar" id="progressBar">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
        </div>

        <div class="test-results" id="testResults"></div>
        <div class="status" id="status"></div>
        
        <div class="output" id="output">
            <div class="output-header">
                <span class="output-title">Migration Log</span>
                <button class="btn btn-secondary" onclick="clearOutput()" style="padding: 6px 12px; font-size: 12px;">
                    Clear
                </button>
            </div>
            <div id="outputContent"></div>
        </div>

        <div class="footer-actions">
            <button type="button" class="btn btn-secondary" onclick="downloadLog()">
                <span>üì•</span>
                <span>Download Log</span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetTool()">
                <span>üîÑ</span>
                <span>Reset Tool</span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="showHelp()">
                <span>‚ùì</span>
                <span>Help</span>
            </button>
        </div>
    </div>

    <script>
        // Global variables
        const form = document.getElementById('migrationForm');
        const output = document.getElementById('output');
        const outputContent = document.getElementById('outputContent');
        const status = document.getElementById('status');
        const runBtn = document.getElementById('runMigrationBtn');
        const testResults = document.getElementById('testResults');
        const statusIndicator = document.getElementById('statusIndicator');
        const progressBar = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');
        
        let logContent = '';
        let testsPassed = false;

        // Form submission handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!testsPassed) {
                showStatus('error', 'Please run and pass the connection test first');
                return;
            }
            
            const confirmed = confirm(
                'FINAL CONFIRMATION\n\n' +
                'You are about to permanently migrate all user passwords to secure hashes.\n\n' +
                'This process is IRREVERSIBLE.\n\n' +
                'Have you:\n' +
                '‚úì Backed up your data?\n' +
                '‚úì Tested the connection?\n' +
                '‚úì Reviewed the warnings?\n\n' +
                'Click OK to proceed with migration, or Cancel to abort.'
            );
            
            if (!confirmed) {
                log('info', 'Migration cancelled by user');
                return;
            }
            
            await runMigration();
        });

        // Test connection function
        async function testConnection() {
            const apiEndpoint = document.getElementById('apiEndpoint').value;
            const migrationKey = document.getElementById('migrationKey').value;
            
            if (!migrationKey) {
                showStatus('error', 'Please enter your migration key first');
                return;
            }
            
            testResults.style.display = 'block';
            testResults.innerHTML = '<h3 class="loading">Testing Connection...</h3>';
            
            const tests = [];
            
            // Test 1: Endpoint reachability
            try {
                const response = await fetch(apiEndpoint, { 
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                
                if (response.ok || response.status === 405) {
                    tests.push({ 
                        name: 'Endpoint Reachability', 
                        pass: true,
                        detail: 'Migration function is accessible'
                    });
                } else {
                    tests.push({ 
                        name: 'Endpoint Reachability', 
                        pass: false, 
                        detail: `HTTP ${response.status} - Check your URL`
                    });
                }
            } catch (error) {
                tests.push({ 
                    name: 'Endpoint Reachability', 
                    pass: false, 
                    detail: 'Network error - Check URL and deployment'
                });
            }
            
            // Test 2: Function type verification
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.status === 405) {
                    tests.push({ 
                        name: 'Function Type', 
                        pass: true,
                        detail: 'Correct migration function detected'
                    });
                } else {
                    tests.push({ 
                        name: 'Function Type', 
                        pass: false, 
                        detail: 'Not a migration function'
                    });
                }
            } catch (error) {
                tests.push({ 
                    name: 'Function Type', 
                    pass: false, 
                    detail: error.message 
                });
            }
            
            // Test 3: Authentication check
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ migrationKey: 'intentionally-wrong-key-for-test' })
                });
                
                const data = await response.json();
                
                if (response.status === 401 && data.error === 'Invalid migration key') {
                    tests.push({ 
                        name: 'Authentication System', 
                        pass: true,
                        detail: 'Security validation working correctly'
                    });
                } else {
                    tests.push({ 
                        name: 'Authentication System', 
                        pass: false, 
                        detail: 'Unexpected authentication response'
                    });
                }
            } catch (error) {
                tests.push({ 
                    name: 'Authentication System', 
                    pass: false, 
                    detail: error.message 
                });
            }
            
            // Test 4: Verify correct key
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ migrationKey: migrationKey })
                });
                
                if (response.status === 401) {
                    tests.push({ 
                        name: 'Migration Key Validation', 
                        pass: false,
                        detail: 'Invalid key - check MIGRATION_KEY in Netlify'
                    });
                } else if (response.ok) {
                    // Key is valid but we don't want to run migration yet
                    tests.push({ 
                        name: 'Migration Key Validation', 
                        pass: true,
                        detail: 'Key validated successfully'
                    });
                }
            } catch (error) {
                tests.push({ 
                    name: 'Migration Key Validation', 
                    pass: false, 
                    detail: error.message 
                });
            }
            
            // Display results
            let html = '<h3>Connection Test Results</h3>';
            
            tests.forEach(test => {
                html += `
                    <div class="test-item">
                        <span class="test-icon ${test.pass ? 'test-pass' : 'test-fail'}">
                            ${test.pass ? '‚úÖ' : '‚ùå'}
                        </span>
                        <div class="test-content">
                            <div class="test-name ${test.pass ? 'test-pass' : 'test-fail'}">
                                ${test.name}
                            </div>
                            <div class="test-detail">
                                ${test.detail}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const allPassed = tests.every(t => t.pass);
            testsPassed = allPassed;
            
            // Update checklist
            if (allPassed) {
                document.getElementById('check-test').classList.add('checked');
                runBtn.disabled = false;
                statusIndicator.className = 'status-indicator ready';
                statusIndicator.innerHTML = '<span>‚óè</span><span>Ready to Migrate</span>';
            } else {
                runBtn.disabled = true;
                statusIndicator.className = 'status-indicator not-ready';
                statusIndicator.innerHTML = '<span>‚óè</span><span>Tests Failed</span>';
            }
            
            html += `
                <div class="test-summary ${allPassed ? 'success' : 'error'}">
                    <strong class="${allPassed ? 'test-pass' : 'test-fail'}">
                        ${allPassed ? 
                            '‚úÖ All tests passed! System is ready for migration.' : 
                            '‚ùå Some tests failed. Please fix the issues above before proceeding.'}
                    </strong>
                </div>
            `;
            
            testResults.innerHTML = html;
        }

        // Dry run function
        async function performDryRun() {
            showStatus('info', 'Dry run feature coming soon - will simulate migration without making changes');
            log('info', 'Dry run requested - this feature will be implemented to preview changes');
        }

        // Main migration function
        async function runMigration() {
            const migrationKey = document.getElementById('migrationKey').value;
            const apiEndpoint = document.getElementById('apiEndpoint').value;

            if (!migrationKey) {
                showStatus('error', 'Migration key is required');
                return;
            }

            // Reset UI
            clearOutput();
            runBtn.disabled = true;
            runBtn.textContent = '‚è≥ Migration in Progress...';
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';
            logContent = '';

            try {
                log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                log('info', '   SECURE AUTHENTICATION MIGRATION');
                log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                log('info', `Date: ${new Date().toLocaleDateString()}`);
                log('info', `Time: ${new Date().toLocaleTimeString()}`);
                log('info', `Endpoint: ${apiEndpoint}`);
                log('info', '');
                
                progressBarFill.style.width = '10%';
                log('info', 'üîÑ Initializing migration process...');
                log('info', 'üîë Authenticating with migration key...');
                
                progressBarFill.style.width = '20%';
                log('info', 'üì° Sending migration request to server...');

                const startTime = Date.now();

                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        migrationKey: migrationKey
                    })
                });

                progressBarFill.style.width = '50%';
                const responseTime = Date.now() - startTime;
                log('info', `üì• Response received in ${responseTime}ms`);
                log('info', `üìä Status: ${response.status} ${response.statusText}`);

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                progressBarFill.style.width = '90%';
                
                if (result.success) {
                    progressBarFill.style.width = '100%';
                    
                    log('success', '');
                    log('success', '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                    log('success', '‚ïë   ‚úÖ MIGRATION COMPLETED SUCCESSFULLY   ‚ïë');
                    log('success', '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                    log('success', '');
                    
                    log('info', 'üìä MIGRATION STATISTICS:');
                    log('info', '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                    log('success', `‚úì Migration ID: ${result.results.migrationId}`);
                    log('success', `‚úì Users Migrated: ${result.results.usersProcessed}`);
                    log('success', `‚úì Pending Users: ${result.results.pendingUsersProcessed}`);
                    log('success', `‚úì Sessions Cleaned: ${result.results.sessionsCleaned}`);
                    log('success', `‚úì Backups Created: ${result.results.backupsCreated}`);
                    log('info', `‚úì Duration: ${result.results.duration}ms`);
                    
                    if (result.results.errors && result.results.errors.length > 0) {
                        log('warning-text', '');
                        log('warning-text', '‚ö†Ô∏è WARNINGS:');
                        log('warning-text', '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                        result.results.errors.forEach(error => {
                            log('warning-text', `‚Ä¢ ${error}`);
                        });
                    } else {
                        log('success', '');
                        log('success', '‚ú® No errors encountered!');
                    }

                    log('info', '');
                    log('info', 'üìã NEXT STEPS:');
                    log('info', '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                    log('info', '1. Test login with a known user account');
                    log('info', '2. Verify admin users can still access admin panel');
                    log('info', '3. Test new user registration');
                    log('info', '4. Monitor authentication logs for issues');
                    log('info', '5. Keep this migration log for your records');
                    log('info', '');
                    log('success', 'üéâ Your authentication system is now secure!');
                    log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

                    showStatus('success', 
                        'Migration completed successfully! ' +
                        'All users can now log in with their existing passwords using the secure system.'
                    );
                    
                    // Update UI
                    document.getElementById('check-ready').classList.add('checked');
                    runBtn.textContent = '‚úÖ Migration Complete';
                    runBtn.className = 'btn btn-success';
                    
                } else {
                    progressBarFill.style.width = '0%';
                    log('error', '');
                    log('error', '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                    log('error', '‚ïë     ‚ùå MIGRATION FAILED                 ‚ïë');
                    log('error', '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                    log('error', '');
                    log('error', result.error || 'Unknown error occurred');
                    if (result.details) {
                        log('error', `Details: ${result.details}`);
                    }
                    showStatus('error', result.error || 'Migration failed');
                }

            } catch (error) {
                progressBarFill.style.width = '0%';
                log('error', '');
                log('error', '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                log('error', '‚ïë   ‚ùå MIGRATION REQUEST FAILED           ‚ïë');
                log('error', '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                log('error', '');
                log('error', `Error: ${error.message}`);
                log('error', 'Please check your connection and try again');
                showStatus('error', `Migration failed: ${error.message}`);
                
            } finally {
                if (!runBtn.textContent.includes('Complete')) {
                    runBtn.disabled = false;
                    runBtn.textContent = 'üöÄ Run Migration';
                }
                
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 2000);
                
                log('info', '');
                log('info', `Log saved at: ${new Date().toISOString()}`);
                log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            }
        }

        // Utility functions
        function log(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : 
                          type === 'error' ? '‚ùå' : 
                          type === 'warning-text' ? '‚ö†Ô∏è' :
                          type === 'info' ? '‚ÑπÔ∏è' : '';
            
            output.style.display = 'block';
            const logLine = `[${timestamp}] ${prefix} ${message}`;
            outputContent.innerHTML += `<span class="${type}">${logLine}</span>\n`;
            output.scrollTop = output.scrollHeight;
            
            // Add to log content for download
            logContent += logLine + '\n';
        }

        function showStatus(type, message) {
            status.className = `status ${type}`;
            status.innerHTML = message;
            status.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 10000);
            }
        }

        function clearOutput() {
            outputContent.innerHTML = '';
            output.style.display = 'none';
            status.style.display = 'none';
            testResults.style.display = 'none';
            progressBar.style.display = 'none';
            logContent = '';
        }

        function downloadLog() {
            if (!logContent) {
                alert('No log content to download');
                return;
            }
            
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `migration-log-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('success', 'Log file downloaded successfully');
        }

        function resetTool() {
            if (confirm('This will clear all forms and logs. Continue?')) {
                clearOutput();
                form.reset();
                testsPassed = false;
                runBtn.disabled = true;
                runBtn.textContent = 'üöÄ Run Migration';
                runBtn.className = 'btn btn-danger';
                statusIndicator.className = 'status-indicator not-ready';
                statusIndicator.innerHTML = '<span>‚óè</span><span>Not Connected</span>';
                
                // Reset checklist
                document.querySelectorAll('.checklist li').forEach(item => {
                    item.classList.remove('checked');
                });
                
                showStatus('info', 'Tool has been reset');
            }
        }

        function showHelp() {
            alert(
                'MIGRATION HELP\n\n' +
                '1. SETUP NETLIFY:\n' +
                '   ‚Ä¢ Go to Netlify Dashboard ‚Üí Settings ‚Üí Environment Variables\n' +
                '   ‚Ä¢ Add MIGRATION_KEY with a secure value\n' +
                '   ‚Ä¢ Deploy the migrate-to-secure-auth.js function\n\n' +
                '2. TEST CONNECTION:\n' +
                '   ‚Ä¢ Enter your migration key (same as Netlify env var)\n' +
                '   ‚Ä¢ Click "Test Connection" to verify setup\n' +
                '   ‚Ä¢ All tests must pass before migration\n\n' +
                '3. RUN MIGRATION:\n' +
                '   ‚Ä¢ Click "Run Migration" after tests pass\n' +
                '   ‚Ä¢ Confirm the security prompt\n' +
                '   ‚Ä¢ Wait for completion (may take a few minutes)\n\n' +
                '4. POST-MIGRATION:\n' +
                '   ‚Ä¢ Download the log for your records\n' +
                '   ‚Ä¢ Test user login immediately\n' +
                '   ‚Ä¢ Users keep their same passwords\n\n' +
                'For support, check the migration log for errors.'
            );
        }

        // Check connection on page load
        window.addEventListener('load', async () => {
            const endpoint = document.getElementById('apiEndpoint').value;
            log('info', 'Migration tool initialized');
            log('info', 'Checking endpoint availability...');
            
            try {
                const response = await fetch(endpoint, { method: 'OPTIONS' });
                if (response.ok || response.status === 405) {
                    log('success', 'Migration endpoint is available');
                    log('info', 'Enter your migration key and run "Test Connection" to begin');
                    document.getElementById('check-deploy').classList.add('checked');
                } else {
                    log('error', `Migration endpoint returned status ${response.status}`);
                    log('info', 'Please ensure migrate-to-secure-auth.js is deployed to Netlify');
                }
            } catch (error) {
                log('error', 'Could not reach migration endpoint');
                log('info', 'Check your network connection and endpoint URL');
            }
        });
    </script>
</body>
</html>
