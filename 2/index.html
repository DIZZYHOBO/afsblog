<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PieFed Mobile Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1f;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #2a2a30;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3a3a40;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-buttons {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .refresh-btn, .home-btn {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        .menu-btn, .user-btn {
            background: #3a3a40;
            border: none;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Tab Navigation */
        .tab-nav {
            background: #2a2a30;
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #3a3a40;
        }

        .tab-btn {
            padding: 8px 20px;
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            border-radius: 20px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #f56565;
            color: white;
        }

        /* Sort Dropdown */
        .sort-container {
            background: #2a2a30;
            padding: 8px 16px;
            border-bottom: 1px solid #3a3a40;
        }

        .sort-dropdown {
            background: #3a3a40;
            border: 1px solid #4a4a50;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            max-width: 200px;
            cursor: pointer;
        }

        /* Community Header */
        .community-header {
            background: #2a2a30;
            padding: 16px;
            border-bottom: 1px solid #3a3a40;
            display: none;
        }

        .community-info {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .community-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #4a4a50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .community-details h1 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .community-details .instance {
            color: #888;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .community-description {
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .community-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .community-stats span {
            color: #888;
        }

        .community-stats strong {
            color: #e0e0e0;
        }

        .community-actions {
            display: flex;
            gap: 12px;
        }

        .subscribe-btn, .new-post-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .subscribe-btn {
            background: #4a4a50;
            color: #e0e0e0;
        }

        .subscribe-btn.subscribed {
            background: #f56565;
            color: white;
        }

        .new-post-btn {
            background: #3a3a40;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 60px;
        }

        /* Post Card */
        .post-card {
            background: #2a2a30;
            border-bottom: 1px solid #3a3a40;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .post-card:hover {
            background: #323238;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #888;
        }

        .community-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background: #4a4a50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .post-meta {
            display: flex;
            flex-direction: column;
        }

        .community-name {
            color: #e0e0e0;
            font-weight: 500;
        }

        .post-author {
            font-size: 12px;
        }

        .post-title {
            font-size: 16px;
            font-weight: 500;
            color: #e0e0e0;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .post-content {
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 8px;
            max-height: 200px;
            overflow: hidden;
        }

        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .post-link {
            display: inline-block;
            color: #6b9bd1;
            text-decoration: none;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 8px;
        }

        .vote-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vote-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
            transition: color 0.2s;
        }

        .vote-btn.upvoted {
            color: #f56565;
        }

        .vote-btn.downvoted {
            color: #6b9bd1;
        }

        .vote-count {
            color: #e0e0e0;
            font-weight: 500;
            min-width: 30px;
            text-align: center;
        }

        .action-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 4px 8px;
            transition: color 0.2s;
        }

        .action-btn:hover {
            color: #e0e0e0;
        }

        /* Comment Section */
        .comments-section {
            background: #1a1a1f;
            display: none;
        }

        .comments-header {
            padding: 12px 16px;
            background: #2a2a30;
            border-bottom: 1px solid #3a3a40;
            font-weight: 500;
        }

        .comment {
            padding: 12px 16px;
            border-bottom: 1px solid #3a3a40;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #888;
        }

        .comment-author {
            color: #e0e0e0;
            font-weight: 500;
        }

        .comment-content {
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .reply-btn {
            color: #6b9bd1;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }

        /* Create Post Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a30;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #3a3a40;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #ccc;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #3a3a40;
            border: 1px solid #4a4a50;
            color: #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid #3a3a40;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-cancel {
            background: #3a3a40;
            color: #e0e0e0;
        }

        .btn-submit {
            background: #f56565;
            color: white;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #3a3a40;
            border-top-color: #f56565;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Form */
        .login-form {
            padding: 16px;
            background: #2a2a30;
            border-radius: 8px;
            max-width: 400px;
            margin: 20px auto;
        }

        .login-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        /* Error/Success Messages */
        .error-message {
            background: #4a2020;
            color: #ff8888;
            padding: 12px;
            border-radius: 6px;
            margin: 16px;
            display: none;
        }

        .success-message {
            background: #204a20;
            color: #88ff88;
            padding: 12px;
            border-radius: 6px;
            margin: 16px;
            display: none;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2a2a30;
            border-top: 1px solid #3a3a40;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 100;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 11px;
            transition: color 0.2s;
        }

        .bottom-nav-item.active {
            color: #f56565;
        }

        .bottom-nav-item svg {
            width: 24px;
            height: 24px;
        }

        /* Menu Drawer */
        .menu-drawer {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: #2a2a30;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
            transition: right 0.3s;
            z-index: 1001;
            overflow-y: auto;
        }

        .menu-drawer.active {
            right: 0;
        }

        .menu-item {
            padding: 14px 16px;
            border-bottom: 1px solid #3a3a40;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item:hover {
            background: #323238;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="nav-buttons">
            <button class="refresh-btn" onclick="app.refresh()">↻</button>
            <button class="home-btn" onclick="app.goHome()">Home</button>
        </div>
        <div class="nav-buttons">
            <button class="menu-btn" onclick="app.toggleMenu()">Menu</button>
            <button class="user-btn" onclick="app.toggleUserMenu()">👤</button>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="statusBar" style="background: #3a3a50; color: #e0e0e0; padding: 8px 16px; font-size: 13px; border-bottom: 1px solid #4a4a50;">
        ⚡ Connecting to PieFed...
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-feed="all" onclick="app.switchFeed('all')">All</button>
        <button class="tab-btn" data-feed="local" onclick="app.switchFeed('local')">Local</button>
        <button class="tab-btn" data-feed="subscribed" onclick="app.switchFeed('subscribed')">Subscribed</button>
    </div>

    <!-- Sort Dropdown -->
    <div class="sort-container">
        <select class="sort-dropdown" onchange="app.changeSort(this.value)">
            <option value="hot">Hot</option>
            <option value="new">New</option>
            <option value="top">Top</option>
            <option value="active">Active</option>
        </select>
    </div>

    <!-- Community Header -->
    <div class="community-header" id="communityHeader">
        <div class="community-info">
            <div class="community-avatar" id="communityAvatar">🌐</div>
            <div class="community-details">
                <h1 id="communityName">Community Name</h1>
                <div class="instance" id="communityInstance">instance.com</div>
                <div class="community-description" id="communityDescription">Loading...</div>
            </div>
        </div>
        <div class="community-stats">
            <div><strong id="communitySubscribers">0</strong> <span>subscribers</span></div>
            <div><strong id="communityPosts">0</strong> <span>posts</span></div>
        </div>
        <div class="community-actions">
            <button class="subscribe-btn" id="subscribeBtn" onclick="app.toggleSubscribe()">Subscribe</button>
            <button class="new-post-btn" onclick="app.showCreatePost()">✏️ New Post</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content" id="content">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading posts...</p>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section" id="commentsSection">
        <div class="comments-header">Comments</div>
        <div id="commentsList"></div>
    </div>

    <!-- Error/Success Messages -->
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <!-- Login Form -->
    <div class="login-form" id="loginForm" style="display: none;">
        <h2>Connect to PieFed</h2>
        <div class="form-group">
            <label>Instance URL</label>
            <select id="instanceSelect" onchange="app.selectInstance(this.value)">
                <option value="https://piefed.social">piefed.social</option>
                <option value="https://feddit.online">feddit.online</option>
                <option value="https://dubvee.org">dubvee.org</option>
                <option value="custom">Custom Instance...</option>
            </select>
            <input type="text" id="customInstance" placeholder="https://your-instance.com" style="display: none; margin-top: 8px;">
        </div>
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="loginUsername" placeholder="Your username">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Your password">
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="app.hideLogin()">Cancel</button>
            <button class="btn btn-submit" onclick="app.doLogin()">Connect</button>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div class="modal" id="createPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Post</h2>
                <button class="close-modal" onclick="app.hideCreatePost()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Community</label>
                    <input type="text" id="postCommunity" placeholder="e.g., technology">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="postTitle" placeholder="Post title">
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea id="postBody" placeholder="Post content (optional)"></textarea>
                </div>
                <div class="form-group">
                    <label>Link (optional)</label>
                    <input type="text" id="postUrl" placeholder="https://example.com">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="app.hideCreatePost()">Cancel</button>
                <button class="btn btn-submit" onclick="app.submitPost()">Post</button>
            </div>
        </div>
    </div>

    <!-- Menu Drawer -->
    <div class="menu-drawer" id="menuDrawer">
        <div class="menu-item" onclick="app.showCreatePost()">✏️ New Post</div>
        <div class="menu-item" onclick="app.showCommunities()">🌐 Browse Communities</div>
        <div class="menu-item" onclick="app.showLogin()">🔑 Login / Switch Instance</div>
        <div class="menu-item" onclick="app.logout()">🚪 Logout</div>
        <div style="padding: 12px 16px; color: #888; font-size: 12px; border-top: 1px solid #3a3a40; margin-top: 20px;">
            PieFed Mobile Client<br>
            Deployed on Netlify
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-item active" onclick="app.showFeed()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Home</span>
        </button>
        <button class="bottom-nav-item" onclick="app.showCommunities()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <span>Communities</span>
        </button>
        <button class="bottom-nav-item" onclick="app.refresh()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            <span>Refresh</span>
        </button>
    </div>

    <script>
        // PieFed Mobile Client - Netlify Version
        const app = {
            // Configuration
            baseUrl: localStorage.getItem('piefed_instance') || 'https://piefed.social',
            session: localStorage.getItem('piefed_session') || null,
            currentFeed: 'all',
            currentSort: 'hot',
            currentCommunity: null,
            currentPost: null,
            posts: [],
            communities: [],
            comments: [],

            // Initialize
            init() {
                this.updateStatus('Loading content from ' + this.baseUrl + '...');
                this.loadPosts();
                this.loadCommunities();
                this.setupEventListeners();
            },

            // Setup event listeners
            setupEventListeners() {
                // Close modals on outside click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });

                // Close menu on outside click
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('menuDrawer');
                    if (!menu.contains(e.target) && !e.target.closest('.menu-btn')) {
                        menu.classList.remove('active');
                    }
                });
            },

            // Call Netlify Function
            async callFunction(functionName, data = {}) {
                try {
                    const response = await fetch(`/.netlify/functions/${functionName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...data,
                            instance: this.baseUrl,
                            session: this.session
                        })
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || `Function error: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`Function ${functionName} failed:`, error);
                    this.showError(error.message);
                    return null;
                }
            },

            // Load posts
            async loadPosts() {
                this.showLoading();
                
                const data = await this.callFunction('piefed-posts', {
                    feed: this.currentFeed,
                    sort: this.currentSort,
                    community: this.currentCommunity
                });

                if (data && data.posts) {
                    this.posts = data.posts;
                    this.renderPosts();
                    this.updateStatus('✅ Connected to ' + this.baseUrl);
                } else {
                    this.updateStatus('⚠️ Unable to load posts. Check your connection.');
                }
            },

            // Load communities
            async loadCommunities() {
                const data = await this.callFunction('piefed-communities');
                if (data && data.communities) {
                    this.communities = data.communities;
                }
            },

            // Render posts
            renderPosts() {
                const content = document.getElementById('content');
                content.innerHTML = '';

                if (this.posts.length === 0) {
                    content.innerHTML = '<div class="loading">No posts found</div>';
                    return;
                }

                this.posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    postCard.innerHTML = `
                        <div class="post-header">
                            <div class="community-icon">🌐</div>
                            <div class="post-meta">
                                <span class="community-name">${post.community || 'piefed'}</span>
                                <span class="post-author">by ${post.author || 'anonymous'} · ${this.timeAgo(post.published)}</span>
                            </div>
                        </div>
                        <div class="post-title">${this.escapeHtml(post.title)}</div>
                        ${post.body ? `<div class="post-content">${this.escapeHtml(post.body).substring(0, 300)}...</div>` : ''}
                        ${post.url ? `<a href="${post.url}" class="post-link" target="_blank">${new URL(post.url).hostname}</a>` : ''}
                        ${post.thumbnail_url ? `<img src="${post.thumbnail_url}" class="post-image" alt="">` : ''}
                        <div class="post-actions">
                            <div class="vote-controls">
                                <button class="vote-btn" onclick="app.vote('${post.id}', 1)">▲</button>
                                <span class="vote-count">${post.score || 0}</span>
                                <button class="vote-btn" onclick="app.vote('${post.id}', -1)">▼</button>
                            </div>
                            <button class="action-btn" onclick="app.showComments('${post.id}')">
                                💬 ${post.comments || 0}
                            </button>
                            <button class="action-btn" onclick="app.share('${post.id}')">
                                🔗 Share
                            </button>
                        </div>
                    `;
                    
                    postCard.onclick = (e) => {
                        if (!e.target.closest('button') && !e.target.closest('a')) {
                            this.showPost(post.id);
                        }
                    };
                    
                    content.appendChild(postCard);
                });
            },

            // Show post details
            async showPost(postId) {
                this.currentPost = postId;
                const post = this.posts.find(p => p.id === postId);
                if (!post) return;

                // Load comments
                const data = await this.callFunction('piefed-comments', { postId: postId });
                if (data && data.comments) {
                    this.comments = data.comments;
                    this.renderComments();
                }

                document.getElementById('commentsSection').style.display = 'block';
            },

            // Render comments
            renderComments() {
                const commentsList = document.getElementById('commentsList');
                commentsList.innerHTML = '';

                if (this.session) {
                    commentsList.innerHTML = `
                        <div style="padding: 12px; background: #3a3a40; border-radius: 6px; margin: 12px;">
                            <textarea id="newComment" placeholder="Write a comment..." style="width: 100%; padding: 8px; background: #2a2a30; border: 1px solid #4a4a50; color: #e0e0e0; border-radius: 4px; min-height: 80px;"></textarea>
                            <button onclick="app.submitComment()" style="margin-top: 8px; padding: 8px 16px; background: #f56565; color: white; border: none; border-radius: 4px; cursor: pointer;">Post Comment</button>
                        </div>
                    `;
                }

                this.comments.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'comment';
                    commentDiv.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-author">${comment.author || 'anonymous'}</span>
                            <span>· ${this.timeAgo(comment.published)}</span>
                        </div>
                        <div class="comment-content">${this.escapeHtml(comment.content)}</div>
                        <div class="comment-actions">
                            <div class="vote-controls">
                                <button class="vote-btn">▲</button>
                                <span class="vote-count">${comment.score || 0}</span>
                                <button class="vote-btn">▼</button>
                            </div>
                            <button class="reply-btn">Reply</button>
                        </div>
                    `;
                    commentsList.appendChild(commentDiv);
                });

                if (this.comments.length === 0) {
                    commentsList.innerHTML += '<div class="comment">No comments yet</div>';
                }
            },

            // Login
            async doLogin() {
                const instance = document.getElementById('instanceSelect').value;
                const customInstance = document.getElementById('customInstance').value;
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;

                if (!username || !password) {
                    this.showError('Please enter username and password');
                    return;
                }

                this.baseUrl = instance === 'custom' ? customInstance : instance;
                localStorage.setItem('piefed_instance', this.baseUrl);

                this.showLoading();
                
                const data = await this.callFunction('piefed-login', {
                    username: username,
                    password: password
                });

                if (data && data.success) {
                    this.session = data.session;
                    localStorage.setItem('piefed_session', this.session);
                    this.hideLogin();
                    this.showSuccess('Connected successfully!');
                    this.loadPosts();
                } else {
                    this.showError(data?.error || 'Login failed');
                }
            },

            // Submit post
            async submitPost() {
                const community = document.getElementById('postCommunity').value;
                const title = document.getElementById('postTitle').value;
                const body = document.getElementById('postBody').value;
                const url = document.getElementById('postUrl').value;

                if (!community || !title) {
                    this.showError('Please fill in required fields');
                    return;
                }

                if (!this.session) {
                    this.showError('Please login first');
                    this.showLogin();
                    return;
                }

                const data = await this.callFunction('piefed-create-post', {
                    community: community,
                    title: title,
                    body: body,
                    url: url
                });

                if (data && data.success) {
                    this.hideCreatePost();
                    this.showSuccess('Post created!');
                    this.loadPosts();
                } else {
                    this.showError(data?.error || 'Failed to create post');
                }
            },

            // Submit comment
            async submitComment() {
                const content = document.getElementById('newComment').value;
                if (!content.trim()) return;

                if (!this.session) {
                    this.showError('Please login first');
                    return;
                }

                const data = await this.callFunction('piefed-create-comment', {
                    postId: this.currentPost,
                    content: content
                });

                if (data && data.success) {
                    document.getElementById('newComment').value = '';
                    this.showSuccess('Comment posted!');
                    this.showPost(this.currentPost); // Reload comments
                } else {
                    this.showError(data?.error || 'Failed to post comment');
                }
            },

            // Vote
            async vote(targetId, score) {
                if (!this.session) {
                    this.showError('Please login to vote');
                    return;
                }

                const data = await this.callFunction('piefed-vote', {
                    targetId: targetId,
                    score: score
                });

                if (data && data.success) {
                    this.showSuccess('Vote recorded!');
                } else {
                    this.showError('Failed to vote');
                }
            },

            // UI Helper methods
            selectInstance(value) {
                const customInput = document.getElementById('customInstance');
                if (value === 'custom') {
                    customInput.style.display = 'block';
                } else {
                    customInput.style.display = 'none';
                }
            },

            switchFeed(feed) {
                this.currentFeed = feed;
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.feed === feed);
                });
                this.loadPosts();
            },

            changeSort(sort) {
                this.currentSort = sort;
                this.loadPosts();
            },

            showCommunities() {
                const content = document.getElementById('content');
                content.innerHTML = '<h2 style="padding: 16px;">Communities</h2>';
                
                this.communities.forEach(community => {
                    const item = document.createElement('div');
                    item.className = 'post-card';
                    item.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="community-icon">🌐</div>
                            <div>
                                <div style="font-weight: 500;">${community.name}</div>
                                <div style="font-size: 13px; color: #888;">${community.subscribers || 0} subscribers</div>
                            </div>
                        </div>
                    `;
                    item.onclick = () => {
                        this.currentCommunity = community.name;
                        document.getElementById('communityHeader').style.display = 'block';
                        document.getElementById('communityName').textContent = community.name;
                        document.getElementById('communityDescription').textContent = community.description || '';
                        document.getElementById('communitySubscribers').textContent = community.subscribers || 0;
                        document.getElementById('communityPosts').textContent = community.posts || 0;
                        this.loadPosts();
                    };
                    content.appendChild(item);
                });
                
                this.closeMenu();
            },

            showFeed() {
                this.currentCommunity = null;
                document.getElementById('communityHeader').style.display = 'none';
                document.getElementById('commentsSection').style.display = 'none';
                this.loadPosts();
            },

            showLogin() {
                document.getElementById('loginForm').style.display = 'block';
            },

            hideLogin() {
                document.getElementById('loginForm').style.display = 'none';
            },

            showCreatePost() {
                if (!this.session) {
                    this.showError('Please login first');
                    this.showLogin();
                    return;
                }
                document.getElementById('createPostModal').classList.add('active');
            },

            hideCreatePost() {
                document.getElementById('createPostModal').classList.remove('active');
            },

            toggleMenu() {
                document.getElementById('menuDrawer').classList.toggle('active');
            },

            closeMenu() {
                document.getElementById('menuDrawer').classList.remove('active');
            },

            toggleUserMenu() {
                if (this.session) {
                    this.toggleMenu();
                } else {
                    this.showLogin();
                }
            },

            goHome() {
                this.showFeed();
            },

            refresh() {
                this.loadPosts();
            },

            logout() {
                this.session = null;
                localStorage.removeItem('piefed_session');
                this.showSuccess('Logged out');
                this.closeMenu();
                this.loadPosts();
            },

            share(postId) {
                const post = this.posts.find(p => p.id === postId);
                if (post && post.postUrl) {
                    if (navigator.share) {
                        navigator.share({
                            title: post.title,
                            url: post.postUrl
                        });
                    } else {
                        navigator.clipboard.writeText(post.postUrl);
                        this.showSuccess('Link copied!');
                    }
                }
            },

            toggleSubscribe() {
                const btn = document.getElementById('subscribeBtn');
                const isSubscribed = btn.classList.contains('subscribed');
                btn.classList.toggle('subscribed');
                btn.textContent = isSubscribed ? 'Subscribe' : 'Unsubscribe';
                this.showSuccess(isSubscribed ? 'Unsubscribed!' : 'Subscribed!');
            },

            updateStatus(message) {
                document.getElementById('statusBar').innerHTML = message;
            },

            showLoading() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading...</p>
                    </div>
                `;
            },

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            },

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            },

            timeAgo(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);

                if (seconds < 60) return 'just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
                return `${Math.floor(seconds / 604800)}w`;
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
