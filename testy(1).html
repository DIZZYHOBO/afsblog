<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lemmy Mobile</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêÄ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --reddit-orange: #FF4500;
            --reddit-blue: #0079D3;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F6F7F8;
            --bg-tertiary: #DAE0E6;
            --text-primary: #1C1C1C;
            --text-secondary: #7C7C7C;
            --border-color: #EDEFF1;
            --upvote: #FF4500;
            --downvote: #7193FF;
            --card-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1A1A1B;
            --bg-secondary: #272729;
            --bg-tertiary: #000000;
            --text-primary: #D7DADC;
            --text-secondary: #818384;
            --border-color: #343536;
            --card-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            height: 48px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-btn, .user-avatar-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 20px;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: var(--reddit-orange);
        }

        .search-bar {
            flex: 1;
            margin: 0 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 6px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-bar input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 14px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--reddit-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            transition: color 0.2s;
        }

        .nav-tab.active {
            color: var(--text-primary);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--reddit-blue);
        }

        /* Sort Bar */
        .sort-bar {
            background: var(--bg-primary);
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .sort-bar::-webkit-scrollbar {
            display: none;
        }

        .sort-pill {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .sort-pill.active {
            background: var(--reddit-blue);
            color: white;
            border-color: var(--reddit-blue);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding-bottom: 56px;
        }

        /* Post Card */
        .post-card {
            background: var(--bg-primary);
            margin-bottom: 8px;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .post-card:active {
            background: var(--bg-secondary);
        }

        .post-content {
            padding: 12px 16px;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .community-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--reddit-blue);
            flex-shrink: 0;
        }

        .post-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .post-body {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
            overflow: hidden;
            word-break: break-word;
        }

        .post-image {
            width: 100%;
            margin: 8px 0;
            border-radius: 8px;
            display: block;
        }

        .post-footer {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 16px;
            flex-wrap: wrap;
        }

        .vote-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vote-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
            font-size: 16px;
        }

        .vote-btn.upvoted {
            color: var(--upvote);
        }

        .vote-btn.downvoted {
            color: var(--downvote);
        }

        .vote-count {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-primary);
            min-width: 40px;
            text-align: center;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            background: none;
            border: none;
            padding: 4px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--text-primary);
        }

        .nav-item-icon {
            font-size: 20px;
        }

        .nav-item-label {
            font-size: 10px;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--reddit-orange);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-body {
            padding: 16px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus {
            border-color: var(--reddit-blue);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: var(--reddit-orange);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Drawer Menu */
        .drawer {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--bg-primary);
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            transition: left 0.3s;
            z-index: 2001;
            overflow-y: auto;
        }

        .drawer.active {
            left: 0;
        }

        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 2000;
        }

        .drawer-overlay.active {
            display: block;
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .drawer-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .drawer-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--reddit-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .drawer-username {
            font-size: 16px;
            font-weight: 600;
        }

        .drawer-karma {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .drawer-menu {
            padding: 8px 0;
        }

        .drawer-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .drawer-item:hover {
            background: var(--bg-secondary);
        }

        .drawer-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }

        /* Post Detail */
        .post-detail {
            background: var(--bg-primary);
            min-height: 100vh;
        }

        .post-detail-content {
            padding: 16px;
        }

        .post-detail-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .post-detail-body {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 16px;
            word-break: break-word;
        }

        /* Comments */
        .comments-section {
            padding: 0 16px 16px;
        }

        .comment-box {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .comment-input {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            outline: none;
        }

        .comment-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 8px;
        }

        .comment-btn {
            padding: 6px 16px;
            background: var(--reddit-orange);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .comments-title {
            font-size: 16px;
            font-weight: 600;
        }

        .comment {
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 2px solid var(--border-color);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-author {
            font-weight: 500;
            color: var(--text-primary);
        }

        .comment-body {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 8px;
            word-break: break-word;
        }

        .comment-footer {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Markdown Content */
        .markdown-content {
            line-height: 1.6;
            word-wrap: break-word;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
            display: block;
        }

        .markdown-content a {
            color: var(--reddit-blue);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content pre {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .markdown-content code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .markdown-content blockquote {
            border-left: 3px solid var(--border-color);
            padding-left: 16px;
            margin: 8px 0;
            color: var(--text-secondary);
        }

        /* Create Post Button */
        .create-post-btn {
            position: fixed;
            bottom: 70px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--reddit-orange);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 24px;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .create-post-btn:active {
            transform: scale(0.95);
        }

        /* Error Message */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin: 16px;
            font-size: 14px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-message {
            font-size: 14px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 14px;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Community List */
        .community-list {
            padding: 8px 0;
        }

        .community-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .community-item:hover {
            background: var(--bg-secondary);
        }

        .community-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--reddit-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .community-info {
            flex: 1;
        }

        .community-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .community-members {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
                margin: 0 auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="menu-btn" onclick="app.toggleDrawer()">‚ò∞</button>
                    <div class="logo">Lemmy</div>
                </div>
                <div class="search-bar">
                    <span>üîç</span>
                    <input type="text" placeholder="Search Lemmy" id="searchInput">
                </div>
                <button class="user-avatar-btn" onclick="app.toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">?</div>
                </button>
            </div>
        </header>

        <!-- Feed Tabs - No Home tab -->
        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" data-feed="Local">Local</button>
            <button class="nav-tab" data-feed="All">All</button>
            <button class="nav-tab" data-feed="Subscribed">Subscribed</button>
        </div>

        <!-- Sort Options -->
        <div class="sort-bar" id="sortBar">
            <button class="sort-pill active" data-sort="Hot">üî• Hot</button>
            <button class="sort-pill" data-sort="Active">‚ö° Active</button>
            <button class="sort-pill" data-sort="New">üÜï New</button>
            <button class="sort-pill" data-sort="TopDay">üìà Top Day</button>
            <button class="sort-pill" data-sort="TopWeek">üìä Top Week</button>
            <button class="sort-pill" data-sort="TopMonth">üìâ Top Month</button>
        </div>

        <!-- Main Content -->
        <main class="content" id="content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </main>

        <!-- Create Post Button -->
        <button class="create-post-btn" onclick="app.showCreatePost()">+</button>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="feed">
                <span class="nav-item-icon">üè†</span>
                <span class="nav-item-label">Feed</span>
            </button>
            <button class="nav-item" data-page="communities">
                <span class="nav-item-icon">üë•</span>
                <span class="nav-item-label">Communities</span>
            </button>
            <button class="nav-item" data-page="create">
                <span class="nav-item-icon">‚ûï</span>
                <span class="nav-item-label">Create</span>
            </button>
            <button class="nav-item" data-page="inbox">
                <span class="nav-item-icon">üí¨</span>
                <span class="nav-item-label">Inbox</span>
            </button>
            <button class="nav-item" data-page="profile">
                <span class="nav-item-icon">üë§</span>
                <span class="nav-item-label">Profile</span>
            </button>
        </nav>

        <!-- Drawer Menu -->
        <div class="drawer-overlay" id="drawerOverlay" onclick="app.toggleDrawer()"></div>
        <div class="drawer" id="drawer">
            <div class="drawer-header">
                <div class="drawer-user" id="drawerUser">
                    <div class="drawer-user-avatar">?</div>
                    <div>
                        <div class="drawer-username">Guest</div>
                        <div class="drawer-karma">Not logged in</div>
                    </div>
                </div>
            </div>
            <div class="drawer-menu">
                <button class="drawer-item" onclick="app.navigateTo('profile')">
                    üë§ My Profile
                </button>
                <button class="drawer-item" onclick="app.navigateTo('saved')">
                    üîñ Saved Posts
                </button>
                <button class="drawer-item" onclick="app.navigateTo('settings')">
                    ‚öôÔ∏è Settings
                </button>
                <div class="drawer-divider"></div>
                <button class="drawer-item" onclick="app.toggleTheme()">
                    üåô Dark Mode
                </button>
                <button class="drawer-item" onclick="app.showInstancePicker()">
                    üåê Change Instance
                </button>
                <div class="drawer-divider"></div>
                <button class="drawer-item" id="authBtn" onclick="app.handleAuth()">
                    üîë Login
                </button>
            </div>
        </div>

        <!-- Login Modal -->
        <div class="modal" id="loginModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Login to Lemmy</h2>
                    <button class="modal-close" onclick="app.closeModal('loginModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Instance</label>
                        <input type="text" class="form-input" id="instanceInput" placeholder="lemmy.world" value="lemmy.world">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username or Email</label>
                        <input type="text" class="form-input" id="usernameInput" placeholder="Enter username or email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="passwordInput" placeholder="Enter password">
                    </div>
                    <button class="btn" onclick="app.login()">Login</button>
                </div>
            </div>
        </div>

        <!-- Create Post Modal -->
        <div class="modal" id="createPostModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Post</h2>
                    <button class="modal-close" onclick="app.closeModal('createPostModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Community</label>
                        <select class="form-input" id="postCommunity">
                            <option value="">Select a community</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="postTitle" placeholder="Enter post title">
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL (optional)</label>
                        <input type="url" class="form-input" id="postUrl" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Body (optional - Markdown supported)</label>
                        <textarea class="form-textarea" id="postBody" placeholder="Write your post content here..."></textarea>
                    </div>
                    <button class="btn" onclick="app.createPost()">Submit Post</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // Lemmy API Client - Based on official Lemmy JS Client v0.19 docs
        class LemmyClient {
            constructor(instanceUrl = 'https://lemmy.world') {
                this.baseUrl = instanceUrl;
                this.auth = null;
                this.site = null;
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}/api/v3${endpoint}`;
                
                try {
                    let fetchOptions = {
                        method: options.method || 'GET',
                        headers: {}
                    };

                    // Add body for POST/PUT requests
                    if (options.body && (fetchOptions.method === 'POST' || fetchOptions.method === 'PUT')) {
                        fetchOptions.headers['Content-Type'] = 'application/json';
                        
                        // Add auth to body if available
                        if (this.auth) {
                            const bodyData = typeof options.body === 'string' ? 
                                JSON.parse(options.body) : options.body;
                            bodyData.auth = this.auth;
                            fetchOptions.body = JSON.stringify(bodyData);
                        } else {
                            fetchOptions.body = typeof options.body === 'string' ? 
                                options.body : JSON.stringify(options.body);
                        }
                    }

                    const response = await fetch(url, fetchOptions);
                    
                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || `HTTP ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    this.showToast('Failed to create post');
                }
            }

            toggleDrawer() {
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('drawerOverlay');
                
                drawer.classList.toggle('active');
                overlay.classList.toggle('active');
            }

            toggleTheme() {
                const isDark = document.body.dataset.theme === 'dark';
                document.body.dataset.theme = isDark ? '' : 'dark';
                localStorage.setItem('theme', isDark ? 'light' : 'dark');
                this.showToast(`Switched to ${isDark ? 'light' : 'dark'} mode`);
            }

            showLogin() {
                document.getElementById('loginModal').classList.add('active');
            }

            async login() {
                const instance = document.getElementById('instanceInput').value.trim();
                const username = document.getElementById('usernameInput').value.trim();
                const password = document.getElementById('passwordInput').value;

                if (!username || !password) {
                    this.showToast('Please enter username and password');
                    return;
                }

                try {
                    this.client.baseUrl = `https://${instance}`;
                    await this.client.login(username, password);
                    
                    this.closeModal('loginModal');
                    this.showToast('Logged in successfully!');
                    
                    await this.loadUserInfo();
                    this.currentPage = 1;
                    this.loadPosts();
                } catch (error) {
                    this.showToast('Login failed. Please check your credentials.');
                }
            }

            async logout() {
                await this.client.logout();
                this.myUser = null;
                this.updateUserUI();
                this.showToast('Logged out');
                this.currentPage = 1;
                this.loadPosts();
            }

            handleAuth() {
                if (this.client.auth) {
                    this.logout();
                } else {
                    this.showLogin();
                }
            }

            updateUserUI() {
                const avatar = document.getElementById('userAvatar');
                const drawerUser = document.getElementById('drawerUser');
                const authBtn = document.getElementById('authBtn');

                if (this.myUser && this.myUser.local_user_view) {
                    const user = this.myUser.local_user_view.person;
                    
                    avatar.textContent = user.name[0].toUpperCase();
                    
                    drawerUser.innerHTML = `
                        <div class="drawer-user-avatar">${user.name[0].toUpperCase()}</div>
                        <div>
                            <div class="drawer-username">u/${user.name}</div>
                            <div class="drawer-karma">Karma: ${this.formatCount(user.comment_score + user.post_score)}</div>
                        </div>
                    `;
                    
                    authBtn.innerHTML = 'üö™ Logout';
                } else {
                    avatar.textContent = '?';
                    
                    drawerUser.innerHTML = `
                        <div class="drawer-user-avatar">?</div>
                        <div>
                            <div class="drawer-username">Guest</div>
                            <div class="drawer-karma">Not logged in</div>
                        </div>
                    `;
                    
                    authBtn.innerHTML = 'üîë Login';
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                
                // Clear form inputs
                if (modalId === 'createPostModal') {
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postUrl').value = '';
                    document.getElementById('postBody').value = '';
                }
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            showInstancePicker() {
                this.showToast('Instance picker coming soon');
            }

            toggleUserMenu() {
                this.toggleDrawer();
            }

            search(query) {
                this.showToast(`Searching for: ${query}`);
                // TODO: Implement search
            }

            // Utility functions
            parseMarkdown(text) {
                if (!text) return '';
                
                // Escape HTML
                let html = this.escapeHtml(text);
                
                // Images
                html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, 
                    '<img src="$2" alt="$1" style="max-width: 100%; height: auto;">');
                
                // Links
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, 
                    '<a href="$2" target="_blank" rel="noopener">$1</a>');
                
                // Bold
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                
                // Italic
                html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
                
                // Code blocks
                html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                
                // Inline code
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // Blockquotes
                html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
                
                // Headers
                html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
                html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
                html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
                
                // Line breaks
                html = html.replace(/\n\n/g, '</p><p>');
                html = html.replace(/\n/g, '<br>');
                
                // Wrap in paragraph if needed
                if (!html.startsWith('<')) {
                    html = '<p>' + html + '</p>';
                }
                
                return html;
            }

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000);
                
                if (diff < 60) return 'just now';
                if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
                if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
                
                return date.toLocaleDateString();
            }

            formatCount(count) {
                if (!count) return '0';
                if (count >= 1000000) return `${(count / 1000000).toFixed(1)}M`;
                if (count >= 1000) return `${(count / 1000).toFixed(1)}k`;
                return count.toString();
            }
        }

        // Initialize the app
        const app = new LemmyApp();

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.dataset.theme = 'dark';
        }

        // Handle back button for post detail view
        window.addEventListener('popstate', () => {
            app.currentPage = 1;
            app.loadPosts();
        });
    </script>
</body>
</html>
                    console.error('API Error:', error);
                    throw error;
                }
            }

            // Authentication
            async login(username_or_email, password) {
                const response = await this.request('/user/login', {
                    method: 'POST',
                    body: { username_or_email, password }
                });

                if (response.jwt) {
                    this.auth = response.jwt;
                    localStorage.setItem('lemmy_jwt', this.auth);
                    localStorage.setItem('lemmy_instance', this.baseUrl);
                }

                return response;
            }

            async logout() {
                this.auth = null;
                localStorage.removeItem('lemmy_jwt');
                localStorage.removeItem('lemmy_instance');
            }

            loadAuth() {
                const jwt = localStorage.getItem('lemmy_jwt');
                const instance = localStorage.getItem('lemmy_instance');
                
                if (jwt) {
                    this.auth = jwt;
                    if (instance) this.baseUrl = instance;
                    return true;
                }
                return false;
            }

            // Posts - Using correct ListingType enum values from API docs
            async getPosts(options = {}) {
                const params = new URLSearchParams({
                    type_: options.type_ || 'Local',
                    sort: options.sort || 'Hot',
                    page: options.page || 1,
                    limit: options.limit || 20
                });

                if (this.auth) {
                    params.append('auth', this.auth);
                }

                return await this.request(`/post/list?${params}`);
            }

            async getPost(id) {
                const params = new URLSearchParams({ id });
                if (this.auth) params.append('auth', this.auth);
                return await this.request(`/post?${params}`);
            }

            async createPost(community_id, name, body, url) {
                return await this.request('/post', {
                    method: 'POST',
                    body: { community_id, name, body, url }
                });
            }

            async likePost(post_id, score) {
                return await this.request('/post/like', {
                    method: 'POST',
                    body: { post_id, score }
                });
            }

            async savePost(post_id, save) {
                return await this.request('/post/save', {
                    method: 'PUT',
                    body: { post_id, save }
                });
            }

            // Comments
            async getComments(post_id, options = {}) {
                const params = new URLSearchParams({
                    post_id,
                    type_: options.type_ || 'All',
                    sort: options.sort || 'Hot',
                    max_depth: options.max_depth || 8,
                    page: options.page || 1,
                    limit: options.limit || 50
                });

                if (this.auth) params.append('auth', this.auth);
                return await this.request(`/comment/list?${params}`);
            }

            async createComment(post_id, content, parent_id) {
                return await this.request('/comment', {
                    method: 'POST',
                    body: { post_id, content, parent_id }
                });
            }

            async likeComment(comment_id, score) {
                return await this.request('/comment/like', {
                    method: 'POST',
                    body: { comment_id, score }
                });
            }

            // Communities
            async getCommunities(options = {}) {
                const params = new URLSearchParams({
                    type_: options.type_ || 'Local',
                    sort: options.sort || 'Hot',
                    page: options.page || 1,
                    limit: options.limit || 50
                });

                if (this.auth) params.append('auth', this.auth);
                return await this.request(`/community/list?${params}`);
            }

            // Site
            async getSite() {
                const params = new URLSearchParams();
                if (this.auth) params.append('auth', this.auth);
                return await this.request(`/site?${params}`);
            }
        }

        // Main Application
        class LemmyApp {
            constructor() {
                this.client = new LemmyClient();
                this.currentFeed = 'Local'; // ListingType enum value
                this.currentSort = 'Hot';   // SortType enum value
                this.currentPage = 1;
                this.posts = [];
                this.communities = [];
                this.currentPost = null;
                this.isLoading = false;
                this.currentView = 'feed';
                this.myUser = null;
                
                this.init();
            }

            async init() {
                // Check for saved auth
                if (this.client.loadAuth()) {
                    await this.loadUserInfo();
                }

                // Setup event listeners
                this.setupEventListeners();

                // Load initial posts
                await this.loadPosts();
            }

            setupEventListeners() {
                // Feed tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentFeed = e.target.dataset.feed;
                        this.currentPage = 1;
                        this.loadPosts();
                    });
                });

                // Sort options
                document.querySelectorAll('.sort-pill').forEach(pill => {
                    pill.addEventListener('click', (e) => {
                        document.querySelectorAll('.sort-pill').forEach(p => p.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentSort = e.target.dataset.sort;
                        this.currentPage = 1;
                        this.loadPosts();
                    });
                });

                // Bottom navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        this.navigateTo(page);
                    });
                });

                // Infinite scroll
                window.addEventListener('scroll', () => {
                    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                        if (!this.isLoading && this.currentView === 'feed') {
                            this.loadMorePosts();
                        }
                    }
                });

                // Search
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.target.value.trim()) {
                        this.search(e.target.value);
                    }
                });
            }

            async loadUserInfo() {
                try {
                    const site = await this.client.getSite();
                    if (site.my_user) {
                        this.myUser = site.my_user;
                        this.updateUserUI();
                    }
                } catch (error) {
                    console.error('Failed to load user info:', error);
                }
            }

            async loadPosts() {
                if (this.isLoading) return;
                this.isLoading = true;

                const content = document.getElementById('content');
                if (this.currentPage === 1) {
                    content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                }

                try {
                    const response = await this.client.getPosts({
                        type_: this.currentFeed,
                        sort: this.currentSort,
                        page: this.currentPage
                    });

                    if (this.currentPage === 1) {
                        this.posts = response.posts || [];
                    } else {
                        this.posts = [...this.posts, ...(response.posts || [])];
                    }

                    this.renderPosts();
                } catch (error) {
                    if (this.currentPage === 1) {
                        content.innerHTML = '<div class="error-message">Failed to load posts. Please try again.</div>';
                    }
                    this.showToast('Failed to load posts');
                } finally {
                    this.isLoading = false;
                }
            }

            async loadMorePosts() {
                this.currentPage++;
                await this.loadPosts();
            }

            renderPosts() {
                const content = document.getElementById('content');
                
                if (this.posts.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-title">No posts yet</div>
                            <div class="empty-message">Be the first to post!</div>
                        </div>
                    `;
                    return;
                }

                const html = this.posts.map(postView => {
                    const post = postView.post;
                    const creator = postView.creator;
                    const community = postView.community;
                    const counts = postView.counts;

                    // Parse body for preview
                    let bodyPreview = '';
                    if (post.body) {
                        bodyPreview = this.parseMarkdown(post.body.substring(0, 200));
                        if (post.body.length > 200) bodyPreview += '...';
                    }

                    // Handle images
                    let imageHtml = '';
                    if (post.thumbnail_url) {
                        imageHtml = `<img class="post-image" src="${post.thumbnail_url}" alt="" loading="lazy">`;
                    } else if (post.url && /\.(jpg|jpeg|png|gif|webp)$/i.test(post.url)) {
                        imageHtml = `<img class="post-image" src="${post.url}" alt="" loading="lazy">`;
                    }

                    return `
                        <div class="post-card" onclick="app.viewPost(${post.id})">
                            <div class="post-content">
                                <div class="post-header">
                                    <div class="community-icon"></div>
                                    <span>c/${community.name}</span>
                                    <span>‚Ä¢</span>
                                    <span>u/${creator.name}</span>
                                    <span>‚Ä¢</span>
                                    <span>${this.formatTime(post.published)}</span>
                                </div>
                                <h3 class="post-title">${this.escapeHtml(post.name)}</h3>
                                ${bodyPreview ? `<div class="post-body markdown-content">${bodyPreview}</div>` : ''}
                                ${imageHtml}
                            </div>
                            <div class="post-footer">
                                <div class="vote-buttons">
                                    <button class="vote-btn ${postView.my_vote === 1 ? 'upvoted' : ''}" 
                                        onclick="event.stopPropagation(); app.votePost(${post.id}, ${postView.my_vote === 1 ? 0 : 1})">
                                        ‚ñ≤
                                    </button>
                                    <span class="vote-count">${this.formatCount(counts.score)}</span>
                                    <button class="vote-btn ${postView.my_vote === -1 ? 'downvoted' : ''}" 
                                        onclick="event.stopPropagation(); app.votePost(${post.id}, ${postView.my_vote === -1 ? 0 : -1})">
                                        ‚ñº
                                    </button>
                                </div>
                                <button class="post-action" onclick="event.stopPropagation(); app.viewPost(${post.id})">
                                    üí¨ ${this.formatCount(counts.comments)}
                                </button>
                                <button class="post-action" onclick="event.stopPropagation(); app.sharePost(${post.id})">
                                    üîó Share
                                </button>
                                <button class="post-action" onclick="event.stopPropagation(); app.savePost(${post.id}, ${!postView.saved})">
                                    ${postView.saved ? 'üîñ' : 'üìå'} Save
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                if (this.currentPage === 1) {
                    content.innerHTML = html;
                } else {
                    content.insertAdjacentHTML('beforeend', html);
                }
            }

            async viewPost(postId) {
                const content = document.getElementById('content');
                content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                try {
                    const [postRes, commentsRes] = await Promise.all([
                        this.client.getPost(postId),
                        this.client.getComments(postId)
                    ]);

                    this.currentPost = postRes.post_view;
                    this.renderPostDetail(postRes.post_view, commentsRes.comments);
                } catch (error) {
                    content.innerHTML = '<div class="error-message">Failed to load post</div>';
                }
            }

            renderPostDetail(postView, comments) {
                const post = postView.post;
                const creator = postView.creator;
                const community = postView.community;
                const counts = postView.counts;

                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="post-detail">
                        <div class="post-detail-content">
                            <div class="post-header">
                                <div class="community-icon"></div>
                                <span>c/${community.name}</span>
                                <span>‚Ä¢</span>
                                <span>u/${creator.name}</span>
                                <span>‚Ä¢</span>
                                <span>${this.formatTime(post.published)}</span>
                            </div>
                            <h1 class="post-detail-title">${this.escapeHtml(post.name)}</h1>
                            ${post.body ? `<div class="post-detail-body markdown-content">${this.parseMarkdown(post.body)}</div>` : ''}
                            ${post.url ? `<a href="${post.url}" target="_blank" style="color: var(--reddit-blue)">üîó ${post.url}</a>` : ''}
                            
                            <div class="post-footer" style="margin-top: 16px;">
                                <div class="vote-buttons">
                                    <button class="vote-btn ${postView.my_vote === 1 ? 'upvoted' : ''}" 
                                        onclick="app.votePost(${post.id}, ${postView.my_vote === 1 ? 0 : 1})">
                                        ‚ñ≤
                                    </button>
                                    <span class="vote-count">${this.formatCount(counts.score)}</span>
                                    <button class="vote-btn ${postView.my_vote === -1 ? 'downvoted' : ''}" 
                                        onclick="app.votePost(${post.id}, ${postView.my_vote === -1 ? 0 : -1})">
                                        ‚ñº
                                    </button>
                                </div>
                                <button class="post-action" onclick="app.sharePost(${post.id})">
                                    üîó Share
                                </button>
                                <button class="post-action" onclick="app.savePost(${post.id}, ${!postView.saved})">
                                    ${postView.saved ? 'üîñ' : 'üìå'} Save
                                </button>
                            </div>
                        </div>

                        <div class="comments-section">
                            <div class="comment-box">
                                <textarea class="comment-input" id="commentInput" placeholder="Add a comment..."></textarea>
                                <div class="comment-actions">
                                    <button class="comment-btn" onclick="app.postComment(${post.id})">Comment</button>
                                </div>
                            </div>

                            <div class="comments-header">
                                <h2 class="comments-title">Comments (${counts.comments})</h2>
                            </div>
                            
                            <div id="commentsContainer">
                                ${this.renderComments(comments)}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderComments(comments, parentId = null, depth = 0) {
                return comments
                    .filter(c => c.comment.path.split('.').length === depth + 2)
                    .map(commentView => {
                        const comment = commentView.comment;
                        const creator = commentView.creator;
                        const counts = commentView.counts;

                        const childComments = comments.filter(c => 
                            c.comment.path.startsWith(comment.path + '.'));

                        return `
                            <div class="comment" style="margin-left: ${Math.min(depth * 20, 60)}px">
                                <div class="comment-header">
                                    <span class="comment-author">u/${creator.name}</span>
                                    <span>‚Ä¢</span>
                                    <span>${this.formatTime(comment.published)}</span>
                                </div>
                                <div class="comment-body markdown-content">
                                    ${this.parseMarkdown(comment.content)}
                                </div>
                                <div class="comment-footer">
                                    <div class="vote-buttons">
                                        <button class="vote-btn ${commentView.my_vote === 1 ? 'upvoted' : ''}" 
                                            onclick="app.voteComment(${comment.id}, ${commentView.my_vote === 1 ? 0 : 1})">
                                            ‚ñ≤
                                        </button>
                                        <span class="vote-count">${counts.score}</span>
                                        <button class="vote-btn ${commentView.my_vote === -1 ? 'downvoted' : ''}" 
                                            onclick="app.voteComment(${comment.id}, ${commentView.my_vote === -1 ? 0 : -1})">
                                            ‚ñº
                                        </button>
                                    </div>
                                    <button class="post-action" onclick="app.replyToComment(${comment.id}, ${comment.post_id})">
                                        ‚Ü©Ô∏è Reply
                                    </button>
                                </div>
                                <div id="reply-${comment.id}"></div>
                                ${childComments.length > 0 ? this.renderComments(comments, comment.id, depth + 1) : ''}
                            </div>
                        `;
                    }).join('');
            }

            async postComment(postId, parentId = null) {
                const input = parentId ? 
                    document.getElementById(`reply-input-${parentId}`) : 
                    document.getElementById('commentInput');
                    
                const content = input?.value.trim();
                
                if (!content) {
                    this.showToast('Please enter a comment');
                    return;
                }

                if (!this.client.auth) {
                    this.showToast('Please login to comment');
                    return;
                }

                try {
                    await this.client.createComment(postId, content, parentId);
                    input.value = '';
                    this.showToast('Comment posted!');
                    
                    // Reload comments
                    const commentsRes = await this.client.getComments(postId);
                    document.getElementById('commentsContainer').innerHTML = 
                        this.renderComments(commentsRes.comments);
                        
                    // Remove reply box if it was a reply
                    if (parentId) {
                        document.getElementById(`reply-${parentId}`).innerHTML = '';
                    }
                } catch (error) {
                    this.showToast('Failed to post comment');
                }
            }

            replyToComment(commentId, postId) {
                const replyDiv = document.getElementById(`reply-${commentId}`);
                
                if (replyDiv.innerHTML) {
                    replyDiv.innerHTML = '';
                    return;
                }

                replyDiv.innerHTML = `
                    <div class="comment-box" style="margin: 8px 0;">
                        <textarea class="comment-input" id="reply-input-${commentId}" 
                            placeholder="Write a reply..." style="min-height: 60px;"></textarea>
                        <div class="comment-actions">
                            <button class="comment-btn" onclick="app.postComment(${postId}, ${commentId})">
                                Reply
                            </button>
                            <button class="comment-btn" style="background: var(--bg-secondary); color: var(--text-primary)"
                                onclick="document.getElementById('reply-${commentId}').innerHTML = ''">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById(`reply-input-${commentId}`).focus();
            }

            async votePost(postId, score) {
                if (!this.client.auth) {
                    this.showToast('Please login to vote');
                    return;
                }

                try {
                    await this.client.likePost(postId, score);
                    
                    // Update UI
                    const post = this.posts.find(p => p.post.id === postId);
                    if (post) {
                        const oldVote = post.my_vote || 0;
                        post.my_vote = score;
                        post.counts.score += score - oldVote;
                        this.renderPosts();
                    }
                } catch (error) {
                    this.showToast('Failed to vote');
                }
            }

            async voteComment(commentId, score) {
                if (!this.client.auth) {
                    this.showToast('Please login to vote');
                    return;
                }

                try {
                    await this.client.likeComment(commentId, score);
                    this.showToast('Vote recorded');
                } catch (error) {
                    this.showToast('Failed to vote');
                }
            }

            async savePost(postId, save) {
                if (!this.client.auth) {
                    this.showToast('Please login to save');
                    return;
                }

                try {
                    await this.client.savePost(postId, save);
                    this.showToast(save ? 'Post saved' : 'Post unsaved');
                    
                    // Update UI
                    const post = this.posts.find(p => p.post.id === postId);
                    if (post) {
                        post.saved = save;
                        this.renderPosts();
                    }
                } catch (error) {
                    this.showToast('Failed to save post');
                }
            }

            sharePost(postId) {
                const post = this.posts.find(p => p.post.id === postId) || this.currentPost;
                if (!post) return;

                const url = `${window.location.origin}/#/post/${postId}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: post.post.name,
                        url: url
                    }).catch(() => {});
                } else {
                    navigator.clipboard.writeText(url);
                    this.showToast('Link copied!');
                }
            }

            async loadCommunities() {
                const content = document.getElementById('content');
                content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                try {
                    const response = await this.client.getCommunities({ limit: 100 });
                    this.communities = response.communities || [];
                    
                    const html = this.communities.map(c => `
                        <div class="community-item" onclick="app.viewCommunity(${c.community.id})">
                            <div class="community-avatar">${c.community.name[0].toUpperCase()}</div>
                            <div class="community-info">
                                <div class="community-name">c/${c.community.name}</div>
                                <div class="community-members">${this.formatCount(c.counts.subscribers)} members</div>
                            </div>
                        </div>
                    `).join('');

                    content.innerHTML = `<div class="community-list">${html}</div>`;
                } catch (error) {
                    content.innerHTML = '<div class="error-message">Failed to load communities</div>';
                }
            }

            viewCommunity(communityId) {
                this.showToast('Community view coming soon');
            }

            navigateTo(page) {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`[data-page="${page}"]`)?.classList.add('active');

                this.currentView = page;

                switch(page) {
                    case 'feed':
                        this.loadPosts();
                        break;
                    case 'communities':
                        this.loadCommunities();
                        break;
                    case 'create':
                        this.showCreatePost();
                        break;
                    case 'inbox':
                        this.showInbox();
                        break;
                    case 'profile':
                        this.showProfile();
                        break;
                }
            }

            showInbox() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¨</div>
                        <div class="empty-title">No messages</div>
                        <div class="empty-message">Your inbox is empty</div>
                    </div>
                `;
            }

            showProfile() {
                const content = document.getElementById('content');
                
                if (this.myUser) {
                    const user = this.myUser.local_user_view.person;
                    content.innerHTML = `
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                                <div class="user-avatar" style="width: 60px; height: 60px; font-size: 24px;">
                                    ${user.name[0].toUpperCase()}
                                </div>
                                <div>
                                    <h2 style="margin: 0;">u/${user.name}</h2>
                                    <div style="color: var(--text-secondary); font-size: 14px;">
                                        Joined ${this.formatTime(user.published)}
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="app.logout()">Logout</button>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üë§</div>
                            <div class="empty-title">Not logged in</div>
                            <div class="empty-message">Login to view your profile</div>
                            <button class="btn" style="max-width: 200px; margin: 20px auto;" 
                                onclick="app.showLogin()">Login</button>
                        </div>
                    `;
                }
            }

            showCreatePost() {
                if (!this.client.auth) {
                    this.showToast('Please login to create posts');
                    return;
                }

                document.getElementById('createPostModal').classList.add('active');
                
                // Load communities for dropdown
                this.client.getCommunities({ limit: 100 }).then(response => {
                    const select = document.getElementById('postCommunity');
                    select.innerHTML = '<option value="">Select a community</option>' +
                        response.communities.map(c => 
                            `<option value="${c.community.id}">c/${c.community.name}</option>`
                        ).join('');
                });
            }

            async createPost() {
                const community_id = parseInt(document.getElementById('postCommunity').value);
                const name = document.getElementById('postTitle').value.trim();
                const url = document.getElementById('postUrl').value.trim();
                const body = document.getElementById('postBody').value.trim();

                if (!community_id || !name) {
                    this.showToast('Please select a community and enter a title');
                    return;
                }

                try {
                    await this.client.createPost(
                        community_id, 
                        name, 
                        body || undefined, 
                        url || undefined
                    );
                    
                    this.closeModal('createPostModal');
                    this.showToast('Post created!');
                    this.currentPage = 1;
                    this.loadPosts();
                } catch (error) {
