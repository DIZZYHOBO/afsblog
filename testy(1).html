<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lemmy - Dive into anything</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --reddit-orange: #FF4500;
            --reddit-blue: #0079D3;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F6F7F8;
            --bg-tertiary: #DAE0E6;
            --text-primary: #1C1C1C;
            --text-secondary: #7C7C7C;
            --border-color: #EDEFF1;
            --upvote: #FF4500;
            --downvote: #7193FF;
            --card-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1A1A1B;
            --bg-secondary: #272729;
            --bg-tertiary: #000000;
            --text-primary: #D7DADC;
            --text-secondary: #818384;
            --border-color: #343536;
            --card-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            height: 48px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-btn, .user-avatar-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: var(--reddit-orange);
        }

        .search-bar {
            flex: 1;
            margin: 0 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 6px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-bar input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 14px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--reddit-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            transition: color 0.2s;
        }

        .nav-tab.active {
            color: var(--text-primary);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--reddit-blue);
        }

        /* Sort Bar */
        .sort-bar {
            background: var(--bg-primary);
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .sort-bar::-webkit-scrollbar {
            display: none;
        }

        .sort-pill {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .sort-pill.active {
            background: var(--reddit-blue);
            color: white;
            border-color: var(--reddit-blue);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding-bottom: 56px;
        }

        /* Post Card */
        .post-card {
            background: var(--bg-primary);
            margin-bottom: 8px;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .post-card:active {
            background: var(--bg-secondary);
        }

        .post-content {
            padding: 12px 16px;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .community-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--reddit-blue);
        }

        .post-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .post-body {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
            max-height: 200px;
            overflow: hidden;
        }

        .post-image {
            width: 100%;
            margin: 8px 0;
            border-radius: 8px;
            max-height: 400px;
            object-fit: cover;
        }

        .post-footer {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 16px;
        }

        .vote-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vote-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .vote-btn.upvoted {
            color: var(--upvote);
        }

        .vote-btn.downvoted {
            color: var(--downvote);
        }

        .vote-count {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-primary);
            min-width: 40px;
            text-align: center;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            background: none;
            border: none;
            padding: 4px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--text-primary);
        }

        .nav-item-icon {
            font-size: 20px;
        }

        .nav-item-label {
            font-size: 10px;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--reddit-orange);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            animation: fadeIn 0.2s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-body {
            padding: 16px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus {
            border-color: var(--reddit-blue);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: var(--reddit-orange);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Drawer Menu */
        .drawer {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--bg-primary);
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            transition: left 0.3s;
            z-index: 2001;
            overflow-y: auto;
        }

        .drawer.active {
            left: 0;
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .drawer-user {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .drawer-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--reddit-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .drawer-username {
            font-size: 16px;
            font-weight: 600;
        }

        .drawer-karma {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .drawer-menu {
            padding: 8px 0;
        }

        .drawer-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            color: var(--text-primary);
            text-decoration: none;
            transition: background 0.2s;
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
        }

        .drawer-item:hover {
            background: var(--bg-secondary);
        }

        .drawer-item-icon {
            font-size: 20px;
            width: 24px;
        }

        .drawer-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }

        /* Community List */
        .community-list {
            padding: 8px 0;
        }

        .community-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .community-item:hover {
            background: var(--bg-secondary);
        }

        .community-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--reddit-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .community-info {
            flex: 1;
        }

        .community-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .community-members {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Post Detail */
        .post-detail {
            background: var(--bg-primary);
            min-height: 100vh;
        }

        .post-detail-content {
            padding: 16px;
        }

        .post-detail-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .post-detail-body {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* Comments */
        .comments-section {
            padding: 16px;
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .comments-title {
            font-size: 16px;
            font-weight: 600;
        }

        .comment-sort {
            display: flex;
            gap: 8px;
        }

        .comment {
            margin-bottom: 16px;
            padding-left: 16px;
            border-left: 2px solid var(--border-color);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-author {
            font-weight: 500;
            color: var(--text-primary);
        }

        .comment-body {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .comment-reply {
            margin-top: 12px;
            margin-left: 16px;
        }

        /* Create Post */
        .create-post-btn {
            position: fixed;
            bottom: 70px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--reddit-orange);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 24px;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .create-post-btn:active {
            transform: scale(0.95);
        }

        /* Error Message */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin: 16px;
            font-size: 14px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-message {
            font-size: 14px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 14px;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
                margin: 0 auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="menu-btn" onclick="app.toggleDrawer()">‚ò∞</button>
                    <div class="logo">Lemmy</div>
                </div>
                <div class="search-bar">
                    <span>üîç</span>
                    <input type="text" placeholder="Search Lemmy" id="searchInput">
                </div>
                <button class="user-avatar-btn" onclick="app.toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">?</div>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" data-feed="home">Home</button>
            <button class="nav-tab" data-feed="local">Local</button>
            <button class="nav-tab" data-feed="all">All</button>
            <button class="nav-tab" data-feed="subscribed">Subscribed</button>
        </div>

        <!-- Sort Bar -->
        <div class="sort-bar" id="sortBar">
            <button class="sort-pill active" data-sort="Hot">üî• Hot</button>
            <button class="sort-pill" data-sort="Active">‚ö° Active</button>
            <button class="sort-pill" data-sort="New">üÜï New</button>
            <button class="sort-pill" data-sort="Top">üìà Top</button>
            <button class="sort-pill" data-sort="MostComments">üí¨ Most Comments</button>
        </div>

        <!-- Main Content -->
        <main class="content" id="content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </main>

        <!-- Create Post Button -->
        <button class="create-post-btn" onclick="app.showCreatePost()">+</button>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home">
                <span class="nav-item-icon">üè†</span>
                <span class="nav-item-label">Home</span>
            </button>
            <button class="nav-item" data-page="communities">
                <span class="nav-item-icon">üë•</span>
                <span class="nav-item-label">Communities</span>
            </button>
            <button class="nav-item" data-page="create">
                <span class="nav-item-icon">‚ûï</span>
                <span class="nav-item-label">Create</span>
            </button>
            <button class="nav-item" data-page="inbox">
                <span class="nav-item-icon">üí¨</span>
                <span class="nav-item-label">Inbox</span>
            </button>
            <button class="nav-item" data-page="profile">
                <span class="nav-item-icon">üë§</span>
                <span class="nav-item-label">Profile</span>
            </button>
        </nav>

        <!-- Drawer Menu -->
        <div class="drawer" id="drawer">
            <div class="drawer-header">
                <div class="drawer-user" id="drawerUser">
                    <div class="drawer-user-avatar">?</div>
                    <div>
                        <div class="drawer-username">Guest</div>
                        <div class="drawer-karma">Login to see karma</div>
                    </div>
                </div>
            </div>
            <div class="drawer-menu">
                <button class="drawer-item" onclick="app.navigateTo('profile')">
                    <span class="drawer-item-icon">üë§</span>
                    <span>My Profile</span>
                </button>
                <button class="drawer-item" onclick="app.navigateTo('saved')">
                    <span class="drawer-item-icon">üîñ</span>
                    <span>Saved</span>
                </button>
                <button class="drawer-item" onclick="app.navigateTo('settings')">
                    <span class="drawer-item-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
                <div class="drawer-divider"></div>
                <button class="drawer-item" onclick="app.toggleTheme()">
                    <span class="drawer-item-icon">üåô</span>
                    <span>Dark Mode</span>
                </button>
                <button class="drawer-item" onclick="app.showInstancePicker()">
                    <span class="drawer-item-icon">üåê</span>
                    <span>Change Instance</span>
                </button>
                <div class="drawer-divider"></div>
                <button class="drawer-item" id="authBtn" onclick="app.handleAuth()">
                    <span class="drawer-item-icon">üîë</span>
                    <span>Login</span>
                </button>
            </div>
        </div>

        <!-- Login Modal -->
        <div class="modal" id="loginModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Login to Lemmy</h2>
                    <button class="modal-close" onclick="app.closeModal('loginModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Instance</label>
                        <input type="text" class="form-input" id="instanceInput" placeholder="lemmy.world" value="lemmy.world">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username or Email</label>
                        <input type="text" class="form-input" id="usernameInput" placeholder="Enter username or email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="passwordInput" placeholder="Enter password">
                    </div>
                    <button class="btn" onclick="app.login()">Login</button>
                    <button class="btn btn-secondary" style="margin-top: 8px" onclick="app.showRegister()">Create Account</button>
                </div>
            </div>
        </div>

        <!-- Create Post Modal -->
        <div class="modal" id="createPostModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create Post</h2>
                    <button class="modal-close" onclick="app.closeModal('createPostModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Community</label>
                        <select class="form-input" id="postCommunity">
                            <option value="">Select a community</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="postTitle" placeholder="Enter post title">
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL (optional)</label>
                        <input type="url" class="form-input" id="postUrl" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Body (optional)</label>
                        <textarea class="form-textarea" id="postBody" placeholder="Enter post content"></textarea>
                    </div>
                    <button class="btn" onclick="app.createPost()">Submit Post</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // Lemmy API Client
        class LemmyClient {
            constructor(instanceUrl = 'https://lemmy.world') {
                this.baseUrl = instanceUrl;
                this.auth = null;
                this.user = null;
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}/api/v3${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (this.auth && options.method !== 'GET') {
                    options.body = options.body ? JSON.parse(options.body) : {};
                    options.body.auth = this.auth;
                    options.body = JSON.stringify(options.body);
                }

                try {
                    const response = await fetch(url, { ...options, headers });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            async login(username_or_email, password) {
                const response = await this.request('/user/login', {
                    method: 'POST',
                    body: JSON.stringify({ username_or_email, password })
                });
                this.auth = response.jwt;
                this.user = response.my_user;
                localStorage.setItem('lemmy_auth', this.auth);
                localStorage.setItem('lemmy_user', JSON.stringify(this.user));
                return response;
            }

            async getPosts(params = {}) {
                const queryParams = new URLSearchParams({
                    type_: params.type || 'Local',
                    sort: params.sort || 'Hot',
                    page: params.page || 1,
                    limit: params.limit || 20
                });
                
                if (this.auth) {
                    queryParams.append('auth', this.auth);
                }

                return await this.request(`/post/list?${queryParams}`);
            }

            async getPost(id) {
                const queryParams = new URLSearchParams({ id });
                if (this.auth) queryParams.append('auth', this.auth);
                return await this.request(`/post?${queryParams}`);
            }

            async getComments(post_id, params = {}) {
                const queryParams = new URLSearchParams({
                    post_id,
                    type_: params.type || 'All',
                    sort: params.sort || 'Hot',
                    page: params.page || 1,
                    limit: params.limit || 50
                });
                
                if (this.auth) queryParams.append('auth', this.auth);
                return await this.request(`/comment/list?${queryParams}`);
            }

            async getCommunities(params = {}) {
                const queryParams = new URLSearchParams({
                    type_: params.type || 'Local',
                    sort: params.sort || 'Hot',
                    page: params.page || 1,
                    limit: params.limit || 50
                });
                
                if (this.auth) queryParams.append('auth', this.auth);
                return await this.request(`/community/list?${queryParams}`);
            }

            async createPost(community_id, name, body, url) {
                return await this.request('/post', {
                    method: 'POST',
                    body: JSON.stringify({ community_id, name, body, url })
                });
            }

            async createComment(post_id, content, parent_id) {
                return await this.request('/comment', {
                    method: 'POST',
                    body: JSON.stringify({ post_id, content, parent_id })
                });
            }

            async vote(post_id, score) {
                return await this.request('/post/like', {
                    method: 'POST',
                    body: JSON.stringify({ post_id, score })
                });
            }

            async voteComment(comment_id, score) {
                return await this.request('/comment/like', {
                    method: 'POST',
                    body: JSON.stringify({ comment_id, score })
                });
            }

            async savePost(post_id, save) {
                return await this.request('/post/save', {
                    method: 'PUT',
                    body: JSON.stringify({ post_id, save })
                });
            }

            async getSite() {
                const queryParams = new URLSearchParams();
                if (this.auth) queryParams.append('auth', this.auth);
                return await this.request(`/site?${queryParams}`);
            }

            loadAuth() {
                const auth = localStorage.getItem('lemmy_auth');
                const user = localStorage.getItem('lemmy_user');
                if (auth && user) {
                    this.auth = auth;
                    this.user = JSON.parse(user);
                    return true;
                }
                return false;
            }

            logout() {
                this.auth = null;
                this.user = null;
                localStorage.removeItem('lemmy_auth');
                localStorage.removeItem('lemmy_user');
            }
        }

        // Main App
        class LemmyApp {
            constructor() {
                this.client = new LemmyClient();
                this.currentView = 'home';
                this.currentFeed = 'local';
                this.currentSort = 'Hot';
                this.posts = [];
                this.communities = [];
                this.currentPost = null;
                this.currentPage = 1;
                this.isLoading = false;
                this.init();
            }

            async init() {
                // Load saved auth
                if (this.client.loadAuth()) {
                    this.updateUserUI();
                }

                // Set up event listeners
                this.setupEventListeners();

                // Load initial content
                await this.loadPosts();
            }

            setupEventListeners() {
                // Navigation tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentFeed = e.target.dataset.feed;
                        this.loadPosts();
                    });
                });

                // Sort pills
                document.querySelectorAll('.sort-pill').forEach(pill => {
                    pill.addEventListener('click', (e) => {
                        document.querySelectorAll('.sort-pill').forEach(p => p.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentSort = e.target.dataset.sort;
                        this.loadPosts();
                    });
                });

                // Bottom navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        this.navigateTo(page);
                    });
                });

                // Search
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.search(e.target.value);
                    }
                });

                // Infinite scroll
                window.addEventListener('scroll', () => {
                    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
                        if (!this.isLoading && this.currentView === 'home') {
                            this.loadMorePosts();
                        }
                    }
                });

                // Close drawer on outside click
                document.addEventListener('click', (e) => {
                    const drawer = document.getElementById('drawer');
                    if (drawer.classList.contains('active') && !drawer.contains(e.target) && !e.target.classList.contains('menu-btn')) {
                        this.toggleDrawer();
                    }
                });
            }

            async loadPosts() {
                if (this.isLoading) return;
                this.isLoading = true;
                this.currentPage = 1;

                const content = document.getElementById('content');
                content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                try {
                    const typeMap = {
                        'home': 'Local',
                        'local': 'Local',
                        'all': 'All',
                        'subscribed': 'Subscribed'
                    };

                    const response = await this.client.getPosts({
                        type: typeMap[this.currentFeed],
                        sort: this.currentSort,
                        page: this.currentPage
                    });

                    this.posts = response.posts;
                    this.renderPosts();
                } catch (error) {
                    content.innerHTML = '<div class="error-message">Failed to load posts. Please try again.</div>';
                } finally {
                    this.isLoading = false;
                }
            }

            async loadMorePosts() {
                if (this.isLoading) return;
                this.isLoading = true;
                this.currentPage++;

                try {
                    const typeMap = {
                        'home': 'Local',
                        'local': 'Local',
                        'all': 'All',
                        'subscribed': 'Subscribed'
                    };

                    const response = await this.client.getPosts({
                        type: typeMap[this.currentFeed],
                        sort: this.currentSort,
                        page: this.currentPage
                    });

                    this.posts = [...this.posts, ...response.posts];
                    this.renderPosts();
                } catch (error) {
                    this.showToast('Failed to load more posts');
                } finally {
                    this.isLoading = false;
                }
            }

            renderPosts() {
                const content = document.getElementById('content');
                
                if (this.posts.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-title">No posts yet</div>
                            <div class="empty-message">Be the first to post in this community!</div>
                        </div>
                    `;
                    return;
                }

                content.innerHTML = this.posts.map(postView => {
                    const post = postView.post;
                    const creator = postView.creator;
                    const community = postView.community;
                    const counts = postView.counts;
                    const my_vote = postView.my_vote;

                    return `
                        <div class="post-card" onclick="app.viewPost(${post.id})">
                            <div class="post-content">
                                <div class="post-header">
                                    <div class="community-icon"></div>
                                    <span>c/${community.name}</span>
                                    <span>‚Ä¢</span>
                                    <span>u/${creator.name}</span>
                                    <span>‚Ä¢</span>
                                    <span>${this.formatTime(post.published)}</span>
                                </div>
                                <h3 class="post-title">${this.escapeHtml(post.name)}</h3>
                                ${post.body ? `<div class="post-body">${this.escapeHtml(post.body.substring(0, 200))}${post.body.length > 200 ? '...' : ''}</div>` : ''}
                                ${post.thumbnail_url ? `<img class="post-image" src="${post.thumbnail_url}" alt="Post thumbnail">` : ''}
                            </div>
                            <div class="post-footer">
                                <div class="vote-buttons">
                                    <button class="vote-btn ${my_vote === 1 ? 'upvoted' : ''}" onclick="event.stopPropagation(); app.vote(${post.id}, 1)">‚ñ≤</button>
                                    <span class="vote-count">${this.formatCount(counts.score)}</span>
                                    <button class="vote-btn ${my_vote === -1 ? 'downvoted' : ''}" onclick="event.stopPropagation(); app.vote(${post.id}, -1)">‚ñº</button>
                                </div>
                                <button class="post-action" onclick="event.stopPropagation(); app.viewPost(${post.id})">
                                    üí¨ ${this.formatCount(counts.comments)}
                                </button>
                                <button class="post-action" onclick="event.stopPropagation(); app.share(${post.id})">
                                    üîó Share
                                </button>
                                <button class="post-action" onclick="event.stopPropagation(); app.save(${post.id})">
                                    üîñ Save
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async viewPost(postId) {
                this.currentView = 'post';
                const content = document.getElementById('content');
                content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                try {
                    const [postResponse, commentsResponse] = await Promise.all([
                        this.client.getPost(postId),
                        this.client.getComments(postId)
                    ]);

                    this.currentPost = postResponse.post_view;
                    this.renderPostDetail(postResponse.post_view, commentsResponse.comments);
                } catch (error) {
                    content.innerHTML = '<div class="error-message">Failed to load post. Please try again.</div>';
                }
            }

            renderPostDetail(postView, comments) {
                const post = postView.post;
                const creator = postView.creator;
                const community = postView.community;
                const counts = postView.counts;

                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="post-detail">
                        <div class="post-detail-content">
                            <div class="post-header">
                                <div class="community-icon"></div>
                                <span>c/${community.name}</span>
                                <span>‚Ä¢</span>
                                <span>u/${creator.name}</span>
                                <span>‚Ä¢</span>
                                <span>${this.formatTime(post.published)}</span>
                            </div>
                            <h1 class="post-detail-title">${this.escapeHtml(post.name)}</h1>
                            ${post.body ? `<div class="post-detail-body">${this.escapeHtml(post.body)}</div>` : ''}
                            ${post.url ? `<a href="${post.url}" target="_blank" class="post-link">üîó ${post.url}</a>` : ''}
                            <div class="post-footer">
                                <div class="vote-buttons">
                                    <button class="vote-btn ${postView.my_vote === 1 ? 'upvoted' : ''}" onclick="app.vote(${post.id}, 1)">‚ñ≤</button>
                                    <span class="vote-count">${this.formatCount(counts.score)}</span>
                                    <button class="vote-btn ${postView.my_vote === -1 ? 'downvoted' : ''}" onclick="app.vote(${post.id}, -1)">‚ñº</button>
                                </div>
                                <button class="post-action" onclick="app.share(${post.id})">
                                    üîó Share
                                </button>
                                <button class="post-action" onclick="app.save(${post.id})">
                                    üîñ Save
                                </button>
                            </div>
                        </div>
                        <div class="comments-section">
                            <div class="comments-header">
                                <h2 class="comments-title">Comments (${counts.comments})</h2>
                            </div>
                            ${this.renderComments(comments)}
                        </div>
                    </div>
                `;
            }

            renderComments(comments, parentId = null, depth = 0) {
                const filtered = comments.filter(c => 
                    (parentId === null && !c.comment.parent_id) || 
                    (c.comment.parent_id === parentId)
                );

                return filtered.map(commentView => {
                    const comment = commentView.comment;
                    const creator = commentView.creator;
                    const counts = commentView.counts;

                    const replies = this.renderComments(comments, comment.id, depth + 1);

                    return `
                        <div class="comment" style="margin-left: ${depth * 16}px">
                            <div class="comment-header">
                                <span class="comment-author">u/${creator.name}</span>
                                <span>‚Ä¢</span>
                                <span>${this.formatTime(comment.published)}</span>
                            </div>
                            <div class="comment-body">${this.escapeHtml(comment.content)}</div>
                            <div class="comment-actions">
                                <div class="vote-buttons">
                                    <button class="vote-btn ${commentView.my_vote === 1 ? 'upvoted' : ''}" onclick="app.voteComment(${comment.id}, 1)">‚ñ≤</button>
                                    <span class="vote-count">${counts.score}</span>
                                    <button class="vote-btn ${commentView.my_vote === -1 ? 'downvoted' : ''}" onclick="app.voteComment(${comment.id}, -1)">‚ñº</button>
                                </div>
                                <button class="post-action" onclick="app.replyToComment(${comment.id})">
                                    ‚Ü©Ô∏è Reply
                                </button>
                            </div>
                            ${replies}
                        </div>
                    `;
                }).join('');
            }

            async loadCommunities() {
                const content = document.getElementById('content');
                content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                try {
                    const response = await this.client.getCommunities({ limit: 100 });
                    this.communities = response.communities;
                    this.renderCommunities();
                } catch (error) {
                    content.innerHTML = '<div class="error-message">Failed to load communities.</div>';
                }
            }

            renderCommunities() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="community-list">
                        ${this.communities.map(communityView => {
                            const community = communityView.community;
                            const counts = communityView.counts;
                            return `
                                <div class="community-item" onclick="app.viewCommunity(${community.id})">
                                    <div class="community-avatar">${community.name[0].toUpperCase()}</div>
                                    <div class="community-info">
                                        <div class="community-name">c/${community.name}</div>
                                        <div class="community-members">${this.formatCount(counts.subscribers)} members</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            async vote(postId, score) {
                if (!this.client.auth) {
                    this.showToast('Please login to vote');
                    return;
                }

                try {
                    await this.client.vote(postId, score);
                    // Update UI
                    const postView = this.posts.find(p => p.post.id === postId);
                    if (postView) {
                        if (postView.my_vote === score) {
                            postView.my_vote = 0;
                            postView.counts.score -= score;
                        } else {
                            if (postView.my_vote) {
                                postView.counts.score -= postView.my_vote;
                            }
                            postView.my_vote = score;
                            postView.counts.score += score;
                        }
                        this.renderPosts();
                    }
                } catch (error) {
                    this.showToast('Failed to vote');
                }
            }

            async voteComment(commentId, score) {
                if (!this.client.auth) {
                    this.showToast('Please login to vote');
                    return;
                }

                try {
                    await this.client.voteComment(commentId, score);
                    this.showToast('Vote recorded');
                } catch (error) {
                    this.showToast('Failed to vote');
                }
            }

            async save(postId) {
                if (!this.client.auth) {
                    this.showToast('Please login to save posts');
                    return;
                }

                try {
                    await this.client.savePost(postId, true);
                    this.showToast('Post saved');
                } catch (error) {
                    this.showToast('Failed to save post');
                }
            }

            share(postId) {
                const post = this.posts.find(p => p.post.id === postId);
                if (post) {
                    const url = `${window.location.origin}/post/${postId}`;
                    if (navigator.share) {
                        navigator.share({
                            title: post.post.name,
                            url: url
                        });
                    } else {
                        navigator.clipboard.writeText(url);
                        this.showToast('Link copied to clipboard');
                    }
                }
            }

            navigateTo(page) {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`[data-page="${page}"]`).classList.add('active');

                switch(page) {
                    case 'home':
                        this.currentView = 'home';
                        this.loadPosts();
                        break;
                    case 'communities':
                        this.currentView = 'communities';
                        this.loadCommunities();
                        break;
                    case 'create':
                        this.showCreatePost();
                        break;
                    case 'inbox':
                        this.showInbox();
                        break;
                    case 'profile':
                        this.showProfile();
                        break;
                }
            }

            showCreatePost() {
                if (!this.client.auth) {
                    this.showToast('Please login to create posts');
                    return;
                }

                document.getElementById('createPostModal').classList.add('active');
                
                // Load communities for dropdown
                this.client.getCommunities({ limit: 100 }).then(response => {
                    const select = document.getElementById('postCommunity');
                    select.innerHTML = '<option value="">Select a community</option>' +
                        response.communities.map(c => 
                            `<option value="${c.community.id}">c/${c.community.name}</option>`
                        ).join('');
                });
            }

            async createPost() {
                const community_id = parseInt(document.getElementById('postCommunity').value);
                const name = document.getElementById('postTitle').value;
                const url = document.getElementById('postUrl').value;
                const body = document.getElementById('postBody').value;

                if (!community_id || !name) {
                    this.showToast('Please select a community and enter a title');
                    return;
                }

                try {
                    await this.client.createPost(community_id, name, body || undefined, url || undefined);
                    this.closeModal('createPostModal');
                    this.showToast('Post created successfully');
                    this.loadPosts();
                } catch (error) {
                    this.showToast('Failed to create post');
                }
            }

            showInbox() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¨</div>
                        <div class="empty-title">No messages</div>
                        <div class="empty-message">Your inbox is empty</div>
                    </div>
                `;
            }

            showProfile() {
                const content = document.getElementById('content');
                if (this.client.user) {
                    let userName = 'User';
                    let userJoined = '';
                    
                    if (this.client.user.local_user_view && this.client.user.local_user_view.person) {
                        const person = this.client.user.local_user_view.person;
                        userName = person.name;
                        userJoined = person.published;
                    } else if (this.client.user.person) {
                        userName = this.client.user.person.name;
                        userJoined = this.client.user.person.published;
                    }
                    
                    content.innerHTML = `
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                                <div class="user-avatar" style="width: 60px; height: 60px; font-size: 24px;">
                                    ${userName[0].toUpperCase()}
                                </div>
                                <div>
                                    <h2 style="margin: 0;">u/${userName}</h2>
                                    <div style="color: var(--text-secondary); font-size: 14px;">
                                        Joined ${userJoined ? this.formatTime(userJoined) : 'recently'}
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="app.logout()">Logout</button>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üë§</div>
                            <div class="empty-title">Not logged in</div>
                            <div class="empty-message">Login to view your profile</div>
                            <button class="btn" style="max-width: 200px; margin: 20px auto;" onclick="app.showLogin()">Login</button>
                        </div>
                    `;
                }
            }

            toggleDrawer() {
                document.getElementById('drawer').classList.toggle('active');
            }

            toggleTheme() {
                document.body.dataset.theme = document.body.dataset.theme === 'dark' ? '' : 'dark';
                localStorage.setItem('theme', document.body.dataset.theme || 'light');
                this.showToast(`Switched to ${document.body.dataset.theme === 'dark' ? 'dark' : 'light'} mode`);
            }

            showLogin() {
                document.getElementById('loginModal').classList.add('active');
            }

            async login() {
                const instance = document.getElementById('instanceInput').value;
                const username = document.getElementById('usernameInput').value;
                const password = document.getElementById('passwordInput').value;

                if (!username || !password) {
                    this.showToast('Please enter username and password');
                    return;
                }

                try {
                    this.client.baseUrl = `https://${instance}`;
                    await this.client.login(username, password);
                    this.closeModal('loginModal');
                    this.showToast('Logged in successfully');
                    this.updateUserUI();
                    this.loadPosts();
                } catch (error) {
                    this.showToast('Login failed. Please check your credentials.');
                }
            }

            logout() {
                this.client.logout();
                this.updateUserUI();
                this.showToast('Logged out');
                this.navigateTo('home');
            }

            updateUserUI() {
                if (this.client.user) {
                    const user = this.client.user.local_user_view.person;
                    document.getElementById('userAvatar').textContent = user.name[0].toUpperCase();
                    document.getElementById('drawerUser').innerHTML = `
                        <div class="drawer-user-avatar">${user.name[0].toUpperCase()}</div>
                        <div>
                            <div class="drawer-username">u/${user.name}</div>
                            <div class="drawer-karma">Member since ${this.formatTime(user.published)}</div>
                        </div>
                    `;
                    document.getElementById('authBtn').innerHTML = `
                        <span class="drawer-item-icon">üö™</span>
                        <span>Logout</span>
                    `;
                } else {
                    document.getElementById('userAvatar').textContent = '?';
                    document.getElementById('drawerUser').innerHTML = `
                        <div class="drawer-user-avatar">?</div>
                        <div>
                            <div class="drawer-username">Guest</div>
                            <div class="drawer-karma">Login to see profile</div>
                        </div>
                    `;
                    document.getElementById('authBtn').innerHTML = `
                        <span class="drawer-item-icon">üîë</span>
                        <span>Login</span>
                    `;
                }
            }

            handleAuth() {
                if (this.client.auth) {
                    this.logout();
                } else {
                    this.showLogin();
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                if (days > 0) return `${days}d ago`;
                if (hours > 0) return `${hours}h ago`;
                if (minutes > 0) return `${minutes}m ago`;
                return 'just now';
            }

            formatCount(count) {
                if (count >= 1000000) return `${(count / 1000000).toFixed(1)}M`;
                if (count >= 1000) return `${(count / 1000).toFixed(1)}k`;
                return count.toString();
            }

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            search(query) {
                // Implement search functionality
                this.showToast(`Searching for: ${query}`);
            }

            viewCommunity(communityId) {
                // Filter posts by community
                this.showToast('Loading community posts...');
            }

            replyToComment(commentId) {
                if (!this.client.auth) {
                    this.showToast('Please login to reply');
                    return;
                }
                // Implement reply functionality
                this.showToast('Reply feature coming soon');
            }

            showInstancePicker() {
                // Implement instance picker
                this.showToast('Instance picker coming soon');
            }

            showRegister() {
                // Implement registration
                this.showToast('Registration coming soon');
            }

            toggleUserMenu() {
                // Show user menu dropdown
                this.toggleDrawer();
            }
        }

        // Initialize app
        const app = new LemmyApp();

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.dataset.theme = 'dark';
        }
    </script>
</body>
</html>
