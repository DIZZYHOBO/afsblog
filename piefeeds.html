<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PieFed Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1f;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #2a2a30;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3a3a40;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-buttons {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .refresh-btn, .home-btn {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        .menu-btn, .user-btn {
            background: #3a3a40;
            border: none;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Tab Navigation */
        .tab-nav {
            background: #2a2a30;
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #3a3a40;
        }

        .tab-btn {
            padding: 8px 20px;
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            border-radius: 20px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #f56565;
            color: white;
        }

        /* Sort Dropdown */
        .sort-container {
            background: #2a2a30;
            padding: 8px 16px;
            border-bottom: 1px solid #3a3a40;
        }

        .sort-dropdown {
            background: #3a3a40;
            border: 1px solid #4a4a50;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            max-width: 200px;
            cursor: pointer;
        }

        /* Community Header */
        .community-header {
            background: #2a2a30;
            padding: 16px;
            border-bottom: 1px solid #3a3a40;
            display: none;
        }

        .community-info {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .community-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #4a4a50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .community-details h1 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .community-details .instance {
            color: #888;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .community-description {
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .community-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .community-stats span {
            color: #888;
        }

        .community-stats strong {
            color: #e0e0e0;
        }

        .community-actions {
            display: flex;
            gap: 12px;
        }

        .subscribe-btn, .new-post-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .subscribe-btn {
            background: #4a4a50;
            color: #e0e0e0;
        }

        .subscribe-btn.subscribed {
            background: #f56565;
            color: white;
        }

        .new-post-btn {
            background: #3a3a40;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 60px;
        }

        /* Post Card */
        .post-card {
            background: #2a2a30;
            border-bottom: 1px solid #3a3a40;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .post-card:hover {
            background: #323238;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #888;
        }

        .community-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background: #4a4a50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .post-meta {
            display: flex;
            flex-direction: column;
        }

        .community-name {
            color: #e0e0e0;
            font-weight: 500;
        }

        .post-author {
            font-size: 12px;
        }

        .post-title {
            font-size: 16px;
            font-weight: 500;
            color: #e0e0e0;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .post-content {
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 8px;
            max-height: 200px;
            overflow: hidden;
        }

        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .post-link {
            display: inline-block;
            color: #6b9bd1;
            text-decoration: none;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 8px;
        }

        .vote-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vote-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
            transition: color 0.2s;
        }

        .vote-btn.upvoted {
            color: #f56565;
        }

        .vote-btn.downvoted {
            color: #6b9bd1;
        }

        .vote-count {
            color: #e0e0e0;
            font-weight: 500;
            min-width: 30px;
            text-align: center;
        }

        .action-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 4px 8px;
            transition: color 0.2s;
        }

        .action-btn:hover {
            color: #e0e0e0;
        }

        /* Comment Section */
        .comments-section {
            background: #1a1a1f;
            display: none;
        }

        .comments-header {
            padding: 12px 16px;
            background: #2a2a30;
            border-bottom: 1px solid #3a3a40;
            font-weight: 500;
        }

        .comment {
            padding: 12px 16px;
            border-bottom: 1px solid #3a3a40;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #888;
        }

        .comment-author {
            color: #e0e0e0;
            font-weight: 500;
        }

        .comment-content {
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .reply-btn {
            color: #6b9bd1;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }

        .child-comments {
            margin-left: 24px;
            border-left: 2px solid #3a3a40;
            margin-top: 12px;
        }

        .child-comments .comment {
            padding-left: 16px;
        }

        /* Create Post Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a30;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #3a3a40;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .post-type-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .post-type-tab {
            flex: 1;
            padding: 10px;
            background: #3a3a40;
            border: 1px solid #4a4a50;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 6px;
            text-align: center;
        }

        .post-type-tab.active {
            background: #4a4a50;
            border-color: #5a5a60;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #ccc;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #3a3a40;
            border: 1px solid #4a4a50;
            color: #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid #3a3a40;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-cancel {
            background: #3a3a40;
            color: #e0e0e0;
        }

        .btn-submit {
            background: #f56565;
            color: white;
        }

        /* Menu Drawer */
        .menu-drawer {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: #2a2a30;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
            transition: right 0.3s;
            z-index: 1001;
            overflow-y: auto;
        }

        .menu-drawer.active {
            right: 0;
        }

        .menu-header {
            padding: 16px;
            border-bottom: 1px solid #3a3a40;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .menu-item {
            padding: 14px 16px;
            border-bottom: 1px solid #3a3a40;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item:hover {
            background: #323238;
        }

        .menu-section {
            padding: 12px 16px;
            color: #888;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid #3a3a40;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #3a3a40;
            border-top-color: #f56565;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Community List */
        .community-list {
            padding: 16px;
        }

        .community-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #3a3a40;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .community-item:hover {
            background: #4a4a50;
        }

        .community-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #5a5a60;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .community-item-info {
            flex: 1;
        }

        .community-item-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .community-item-stats {
            font-size: 12px;
            color: #888;
        }

        /* Search Bar */
        .search-container {
            padding: 16px;
            background: #2a2a30;
            border-bottom: 1px solid #3a3a40;
            display: none;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            background: #3a3a40;
            border: 1px solid #4a4a50;
            color: #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        /* User Profile */
        .profile-section {
            padding: 16px;
            display: none;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #4a4a50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .profile-info h2 {
            margin-bottom: 4px;
        }

        .profile-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .stat-label {
            font-size: 13px;
            color: #888;
        }

        /* Login Form */
        .login-form {
            padding: 16px;
            background: #2a2a30;
            border-radius: 8px;
            max-width: 400px;
            margin: 20px auto;
        }

        .login-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        /* Error Message */
        .error-message {
            background: #4a2020;
            color: #ff8888;
            padding: 12px;
            border-radius: 6px;
            margin: 16px;
            display: none;
        }

        /* Success Message */
        .success-message {
            background: #204a20;
            color: #88ff88;
            padding: 12px;
            border-radius: 6px;
            margin: 16px;
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .community-header {
                padding: 12px;
            }

            .community-info {
                flex-direction: column;
                text-align: center;
            }

            .community-avatar {
                margin: 0 auto;
            }

            .community-stats {
                justify-content: center;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
            }
        }

        /* Settings Page */
        .settings-page {
            padding: 16px;
            display: none;
        }

        .settings-section {
            background: #2a2a30;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-section h3 {
            margin-bottom: 16px;
            color: #e0e0e0;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #3a3a40;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: #ccc;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #3a3a40;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #f56565;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 26px;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #f56565;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2a2a30;
            border-top: 1px solid #3a3a40;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 100;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            color: #888;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 11px;
            transition: color 0.2s;
        }

        .bottom-nav-item.active {
            color: #f56565;
        }

        .bottom-nav-item svg {
            width: 24px;
            height: 24px;
        }

        /* Reply Form */
        .reply-form {
            padding: 12px;
            background: #3a3a40;
            border-radius: 6px;
            margin: 12px 0;
            display: none;
        }

        .reply-form textarea {
            width: 100%;
            padding: 8px;
            background: #2a2a30;
            border: 1px solid #4a4a50;
            color: #e0e0e0;
            border-radius: 4px;
            min-height: 80px;
            margin-bottom: 8px;
        }

        .reply-form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .reply-form-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="nav-buttons">
            <button class="refresh-btn" onclick="app.refresh()">‚Üª</button>
            <button class="home-btn" onclick="app.goHome()">Home</button>
        </div>
        <div class="nav-buttons">
            <button class="menu-btn" onclick="app.toggleMenu()">Menu</button>
            <button class="user-btn" onclick="app.toggleUserMenu()">üë§</button>
        </div>
    </div>

    <!-- API Notice -->
    <div style="background: #4a4a20; color: #ffff88; padding: 8px 16px; font-size: 13px; border-bottom: 1px solid #5a5a30;">
        ‚ö†Ô∏è Note: PieFed doesn't currently have a public JSON API. This is a demonstration UI with sample data showing what a PieFed mobile client could look like.
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-feed="subscribed" onclick="app.switchFeed('subscribed')">Subscribed</button>
        <button class="tab-btn" data-feed="all" onclick="app.switchFeed('all')">All</button>
        <button class="tab-btn" data-feed="local" onclick="app.switchFeed('local')">Local</button>
    </div>

    <!-- Sort Dropdown -->
    <div class="sort-container">
        <select class="sort-dropdown" onchange="app.changeSort(this.value)">
            <option value="hot">Hot</option>
            <option value="new">New</option>
            <option value="top">Top</option>
            <option value="active">Active</option>
        </select>
    </div>

    <!-- Search Container -->
    <div class="search-container" id="searchContainer">
        <input type="text" class="search-input" placeholder="Search communities, posts, users..." onkeypress="if(event.key==='Enter') app.search(this.value)">
    </div>

    <!-- Community Header -->
    <div class="community-header" id="communityHeader">
        <div class="community-info">
            <div class="community-avatar" id="communityAvatar">üåê</div>
            <div class="community-details">
                <h1 id="communityName">Community Name</h1>
                <div class="instance" id="communityInstance">instance.com</div>
                <div class="community-description" id="communityDescription">Community description goes here...</div>
            </div>
        </div>
        <div class="community-stats">
            <div><strong id="communitySubscribers">0</strong> <span>subscribers</span></div>
            <div><strong id="communityPosts">0</strong> <span>posts</span></div>
            <div><strong id="communityComments">0</strong> <span>comments</span></div>
        </div>
        <div class="community-actions">
            <button class="subscribe-btn" id="subscribeBtn" onclick="app.toggleSubscribe()">Subscribe</button>
            <button class="new-post-btn" onclick="app.showCreatePost()">‚úèÔ∏è New Post</button>
        </div>
    </div>

    <!-- Error/Success Messages -->
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <!-- Main Content -->
    <div class="content" id="content">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section" id="commentsSection">
        <div class="comments-header">Comments</div>
        <div id="commentsList"></div>
    </div>

    <!-- Community List -->
    <div class="community-list" id="communityList" style="display: none;"></div>

    <!-- Profile Section -->
    <div class="profile-section" id="profileSection">
        <div class="profile-header">
            <div class="profile-avatar">üë§</div>
            <div class="profile-info">
                <h2 id="profileUsername">Username</h2>
                <div id="profileInstance">@instance.com</div>
            </div>
        </div>
        <div class="profile-stats">
            <div class="stat-item">
                <div class="stat-value" id="profilePosts">0</div>
                <div class="stat-label">Posts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="profileComments">0</div>
                <div class="stat-label">Comments</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="profileKarma">0</div>
                <div class="stat-label">Karma</div>
            </div>
        </div>
    </div>

    <!-- Settings Page -->
    <div class="settings-page" id="settingsPage">
        <div class="settings-section">
            <h3>Appearance</h3>
            <div class="setting-item">
                <span class="setting-label">Dark Mode</span>
                <div class="toggle-switch active"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Compact View</span>
                <div class="toggle-switch"></div>
            </div>
        </div>
        <div class="settings-section">
            <h3>Notifications</h3>
            <div class="setting-item">
                <span class="setting-label">Push Notifications</span>
                <div class="toggle-switch"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Email Notifications</span>
                <div class="toggle-switch"></div>
            </div>
        </div>
        <div class="settings-section">
            <h3>Privacy</h3>
            <div class="setting-item">
                <span class="setting-label">Show Online Status</span>
                <div class="toggle-switch active"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Allow Messages</span>
                <div class="toggle-switch active"></div>
            </div>
        </div>
    </div>

    <!-- Login Form -->
    <div class="login-form" id="loginForm" style="display: none;">
        <h2>Login to PieFed</h2>
        <div class="form-group">
            <label>Instance URL</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="loginInstance" placeholder="https://piefed.social" value="https://piefed.social" style="flex: 1;">
                <button class="btn" onclick="app.showInstanceSelector()" style="padding: 10px;">Select</button>
            </div>
            <small style="color: #888; font-size: 12px; margin-top: 4px; display: block;">
                Popular instances: piefed.social, feddit.online, dubvee.org
            </small>
        </div>
        <div class="form-group">
            <label>Username or Email</label>
            <input type="text" id="loginUsername" placeholder="Username">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Password">
        </div>
        <div class="form-group">
            <label>2FA Code (optional)</label>
            <input type="text" id="login2FA" placeholder="000000">
        </div>
        <div style="background: #3a3a40; padding: 12px; border-radius: 6px; margin: 16px 0; font-size: 13px; line-height: 1.5;">
            <strong>Note:</strong> Due to browser security (CORS), full authentication may not work. 
            The app will connect in read-only mode to browse public content from your chosen instance.
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="app.hideLogin()">Cancel</button>
            <button class="btn btn-submit" onclick="app.doLogin()">Connect</button>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div class="modal" id="createPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Post</h2>
                <button class="close-modal" onclick="app.hideCreatePost()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="post-type-tabs">
                    <button class="post-type-tab active" data-type="text" onclick="app.switchPostType('text')">Text</button>
                    <button class="post-type-tab" data-type="link" onclick="app.switchPostType('link')">Link</button>
                    <button class="post-type-tab" data-type="image" onclick="app.switchPostType('image')">Image</button>
                </div>
                <div class="form-group">
                    <label>Community</label>
                    <input type="text" id="postCommunity" placeholder="e.g., technology">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="postTitle" placeholder="Post title">
                </div>
                <div class="form-group" id="postBodyGroup">
                    <label>Text (optional)</label>
                    <textarea id="postBody" placeholder="Post content..."></textarea>
                </div>
                <div class="form-group" id="postUrlGroup" style="display: none;">
                    <label>URL</label>
                    <input type="text" id="postUrl" placeholder="https://example.com">
                </div>
                <div class="form-group" id="postImageGroup" style="display: none;">
                    <label>Image URL</label>
                    <input type="text" id="postImage" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="postTags" placeholder="tag1, tag2">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="postNSFW"> NSFW
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="app.hideCreatePost()">Cancel</button>
                <button class="btn btn-submit" onclick="app.submitPost()">Post</button>
            </div>
        </div>
    </div>

    <!-- Menu Drawer -->
    <div class="menu-drawer" id="menuDrawer">
        <div class="menu-header">
            <h3>Menu</h3>
        </div>
        <div class="menu-item" onclick="app.showCreatePost()">‚úèÔ∏è New Post</div>
        <div class="menu-item" onclick="app.showProfile()">üë§ Profile</div>
        <div class="menu-item" onclick="app.showCommunities()">üåê Discover</div>
        <div class="menu-item" onclick="app.showSettings()">‚öôÔ∏è Settings</div>
        <div class="menu-item" onclick="app.showHelp()">‚ùì Help</div>
        <div class="menu-section">Communities</div>
        <div id="menuCommunities"></div>
        <div class="menu-section">Account</div>
        <div class="menu-item" onclick="app.showLogin()">üîë Login</div>
        <div class="menu-item" onclick="app.logout()">üö™ Logout</div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-item active" onclick="app.showFeed()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Home</span>
        </button>
        <button class="bottom-nav-item" onclick="app.showCommunities()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <span>Communities</span>
        </button>
        <button class="bottom-nav-item" onclick="app.showSearch()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <span>Search</span>
        </button>
        <button class="bottom-nav-item" onclick="app.showNotifications()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
            <span>Inbox</span>
        </button>
        <button class="bottom-nav-item" onclick="app.showProfile()">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>Profile</span>
        </button>
    </div>

    <script>
        // Main Application
        const app = {
            // API Configuration
            baseUrl: localStorage.getItem('piefed_instance') || 'https://piefed.social',
            token: localStorage.getItem('piefed_token') || null,
            cookies: localStorage.getItem('piefed_cookies') || null,
            useRealData: false,
            
            // Application State
            currentView: 'feed',
            currentFeed: 'all',
            currentSort: 'hot',
            currentCommunity: null,
            currentPost: null,
            currentPage: 1,
            posts: [],
            communities: [],
            comments: [],
            userProfile: null,

            // Initialize Application
            init() {
                // Check for saved instance and real data mode
                const savedInstance = localStorage.getItem('piefed_instance');
                if (savedInstance) {
                    this.baseUrl = savedInstance;
                }
                
                const useRealData = localStorage.getItem('piefed_use_real_data');
                if (useRealData === 'true') {
                    this.useRealData = true;
                    // Update the notice
                    const noticeElement = document.querySelector('[style*="background: #4a4a20"]');
                    if (noticeElement) {
                        noticeElement.innerHTML = 'üìñ Connected to ' + this.baseUrl + ' - Loading real content...';
                        noticeElement.style.background = '#3a3a50';
                    }
                }
                
                this.loadPosts();
                this.loadCommunities();
                this.setupEventListeners();
                if (this.token) {
                    this.loadUserProfile();
                }
            },

            // Setup Event Listeners
            setupEventListeners() {
                // Close modals on outside click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });

                // Close menu on outside click
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('menuDrawer');
                    if (!menu.contains(e.target) && !e.target.closest('.menu-btn')) {
                        menu.classList.remove('active');
                    }
                });

                // Handle infinite scroll
                const content = document.getElementById('content');
                content.addEventListener('scroll', () => {
                    if (content.scrollTop + content.clientHeight >= content.scrollHeight - 100) {
                        this.loadMorePosts();
                    }
                });

                // Toggle switches
                document.querySelectorAll('.toggle-switch').forEach(toggle => {
                    toggle.addEventListener('click', function() {
                        this.classList.toggle('active');
                    });
                });
            },

            // API Methods
            async apiRequest(endpoint, options = {}) {
                const url = `${this.baseUrl}${this.apiVersion}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('API Request failed:', error);
                    this.showError(error.message);
                    return null;
                }
            },

            // Load Posts
            async loadPosts() {
                this.showLoading();
                
                try {
                    if (this.useRealData) {
                        // Try to fetch real data from RSS or HTML
                        await this.loadRealPosts();
                    } else {
                        // Use sample data for demo
                        this.posts = this.generateSamplePosts();
                        this.renderPosts();
                    }
                } catch (error) {
                    console.error('Failed to load posts:', error);
                    // Fallback to sample data
                    this.posts = this.generateSamplePosts();
                    this.renderPosts();
                    this.showError('Using sample data. Enable CORS or use a proxy to load real data.');
                }
            },

            // Load real posts from PieFed instance
            async loadRealPosts() {
                const feedUrl = this.currentCommunity 
                    ? `${this.baseUrl}/c/${this.currentCommunity}` 
                    : this.baseUrl;
                
                // Determine feed type and sort
                let fullUrl = feedUrl;
                if (this.currentFeed === 'local') {
                    fullUrl += '/local';
                } else if (this.currentFeed === 'all') {
                    fullUrl += '/all';
                }
                
                // Add sort parameter
                if (this.currentSort === 'new') {
                    fullUrl += '/new';
                } else if (this.currentSort === 'top') {
                    fullUrl += '/top';
                } else if (this.currentSort === 'active') {
                    fullUrl += '/active';
                }

                // Try RSS feed first
                try {
                    const rssUrl = fullUrl + '.rss';
                    const response = await this.fetchWithCORS(rssUrl);
                    const text = await response.text();
                    this.posts = this.parseRSSFeed(text);
                    if (this.posts.length > 0) {
                        this.renderPosts();
                        return;
                    }
                } catch (rssError) {
                    console.log('RSS feed failed, trying HTML parsing:', rssError);
                }

                // Fallback to HTML parsing
                try {
                    const response = await this.fetchWithCORS(fullUrl);
                    const html = await response.text();
                    this.posts = this.parseHTMLPosts(html);
                    this.renderPosts();
                } catch (htmlError) {
                    console.error('HTML parsing failed:', htmlError);
                    throw htmlError;
                }
            },

            // Fetch with CORS handling
            async fetchWithCORS(url) {
                // First try direct fetch
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        credentials: 'omit',
                        headers: {
                            'Accept': 'application/rss+xml, text/html, application/xhtml+xml, application/xml;q=0.9, */*;q=0.8'
                        }
                    });
                    if (response.ok) return response;
                } catch (e) {
                    console.log('Direct fetch failed, trying proxy:', e);
                }

                // Try with CORS proxy services
                const proxies = [
                    'https://corsproxy.io/?',
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/'
                ];

                for (const proxy of proxies) {
                    try {
                        const response = await fetch(proxy + encodeURIComponent(url), {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/rss+xml, text/html, application/xhtml+xml, application/xml;q=0.9, */*;q=0.8'
                            }
                        });
                        if (response.ok) return response;
                    } catch (e) {
                        console.log(`Proxy ${proxy} failed:`, e);
                    }
                }

                throw new Error('All fetch attempts failed');
            },

            // Parse RSS feed
            parseRSSFeed(xmlText) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlText, 'text/xml');
                const items = doc.querySelectorAll('item');
                const posts = [];

                items.forEach((item, index) => {
                    const title = item.querySelector('title')?.textContent || '';
                    const link = item.querySelector('link')?.textContent || '';
                    const description = item.querySelector('description')?.textContent || '';
                    const pubDate = item.querySelector('pubDate')?.textContent || '';
                    const creator = item.querySelector('dc\\:creator, creator')?.textContent || 'anonymous';
                    const category = item.querySelector('category')?.textContent || '';

                    // Extract community from the link or category
                    let community = { name: 'unknown', icon: 'üåê' };
                    const communityMatch = link.match(/\/c\/([^\/]+)/);
                    if (communityMatch) {
                        community.name = communityMatch[1];
                    } else if (category) {
                        community.name = category;
                    }

                    // Clean up HTML from description
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = description;
                    const cleanDescription = tempDiv.textContent || tempDiv.innerText || '';

                    // Check if it's an external link
                    const isExternalLink = description.includes('submitted by') && description.includes('to <a');
                    let externalUrl = null;
                    if (isExternalLink) {
                        const urlMatch = description.match(/href="([^"]+)"/);
                        if (urlMatch) {
                            externalUrl = urlMatch[1];
                        }
                    }

                    posts.push({
                        id: index + 1,
                        name: this.unescapeHtml(title),
                        body: cleanDescription.substring(0, 500),
                        url: externalUrl || (isExternalLink ? link : null),
                        community: community,
                        creator: { name: creator },
                        published: pubDate,
                        score: Math.floor(Math.random() * 100), // RSS doesn't provide scores
                        counts: { comments: Math.floor(Math.random() * 50) },
                        my_vote: 0,
                        saved: false,
                        link: link // Store the actual post link
                    });
                });

                return posts;
            },

            // Parse HTML posts
            parseHTMLPosts(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const posts = [];

                // Try different selectors that PieFed might use
                const postSelectors = [
                    'article.post',
                    '.post-listing',
                    '.entry',
                    'div[class*="post"]',
                    'article'
                ];

                let postElements = [];
                for (const selector of postSelectors) {
                    postElements = doc.querySelectorAll(selector);
                    if (postElements.length > 0) break;
                }

                postElements.forEach((element, index) => {
                    // Extract post data from HTML elements
                    const titleElement = element.querySelector('h2 a, h3 a, .post-title a, a.title');
                    const title = titleElement?.textContent?.trim() || '';
                    const link = titleElement?.href || '';

                    const bodyElement = element.querySelector('.post-body, .content, .description, p');
                    const body = bodyElement?.textContent?.trim() || '';

                    const authorElement = element.querySelector('.author, .submitted-by, .post-author, [class*="author"]');
                    const author = authorElement?.textContent?.replace(/by|submitted/gi, '').trim() || 'anonymous';

                    const communityElement = element.querySelector('.community, .community-link, [class*="community"]');
                    const communityName = communityElement?.textContent?.trim() || 'unknown';

                    const scoreElement = element.querySelector('.score, .points, .votes, [class*="score"]');
                    const score = parseInt(scoreElement?.textContent) || 0;

                    const commentsElement = element.querySelector('.comments, .comment-count, [class*="comments"]');
                    const comments = parseInt(commentsElement?.textContent) || 0;

                    const timeElement = element.querySelector('time, .time, .date, [class*="time"]');
                    const published = timeElement?.getAttribute('datetime') || timeElement?.textContent || new Date().toISOString();

                    if (title) {
                        posts.push({
                            id: index + 1,
                            name: title,
                            body: body.substring(0, 500),
                            url: link.startsWith('http') ? link : null,
                            community: { name: communityName, icon: 'üåê' },
                            creator: { name: author },
                            published: published,
                            score: score,
                            counts: { comments: comments },
                            my_vote: 0,
                            saved: false,
                            link: link
                        });
                    }
                });

                // If no posts found with specific selectors, try a more general approach
                if (posts.length === 0) {
                    // Look for any links that might be posts
                    const links = doc.querySelectorAll('a[href*="/post/"], a[href*="/p/"]');
                    links.forEach((link, index) => {
                        const title = link.textContent?.trim();
                        if (title && title.length > 10) {
                            posts.push({
                                id: index + 1,
                                name: title,
                                body: '',
                                url: null,
                                community: { name: 'piefed', icon: 'üåê' },
                                creator: { name: 'unknown' },
                                published: new Date().toISOString(),
                                score: 0,
                                counts: { comments: 0 },
                                my_vote: 0,
                                saved: false,
                                link: link.href
                            });
                        }
                    });
                }

                return posts;
            },

            // Unescape HTML entities
            unescapeHtml(text) {
                const textarea = document.createElement('textarea');
                textarea.innerHTML = text;
                return textarea.value;
            },

            // Generate sample posts for demonstration
            generateSamplePosts() {
                return [
                    {
                        id: 1,
                        name: "Three-word comeback is the best phrase to use when insulted, boffins say",
                        body: "Top egghead neuroscientist Dean Burnett said calling someone 'grandma' is one of the 'scientifically recognised ways' to disable an awkward situation",
                        community: { name: "science_memes", icon: "üß¨" },
                        creator: { name: "General_Effort" },
                        published: new Date(Date.now() - 3600000).toISOString(),
                        score: 65,
                        counts: { comments: 24 },
                        url: "https://dailystar.co.uk/news/latest-news",
                        thumbnail_url: null,
                        my_vote: 0,
                        saved: false
                    },
                    {
                        id: 2,
                        name: "Transition",
                        body: "A cool visual transition effect",
                        community: { name: "superbowl", icon: "ü¶â" },
                        creator: { name: "anon6789" },
                        published: new Date(Date.now() - 2940000).toISOString(),
                        score: 42,
                        counts: { comments: 8 },
                        thumbnail_url: "data:image/svg+xml,%3Csvg width='400' height='300' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='400' height='300' fill='%234a4a50'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='white' font-size='20'%3EImage Placeholder%3C/text%3E%3C/svg%3E",
                        my_vote: 0,
                        saved: false
                    },
                    {
                        id: 3,
                        name: "New rule (and an addendum)",
                        body: "We are not YPTB. If you have a problem with the way an instance or community is run, then take it up over at !yepowertrippinbastards@lemmy.dbzer0.com. * Addendum: Yes we...",
                        community: { name: "fedimemes", icon: "üåê" },
                        creator: { name: "Emperor" },
                        published: new Date(Date.now() - 61200000).toISOString(),
                        score: 46,
                        counts: { comments: 9 },
                        my_vote: 0,
                        saved: false
                    },
                    {
                        id: 4,
                        name: "I like seeing many of you around",
                        body: "I'm not trying to hijack the conversation by reply-guying all your posts, I just like interacting with this community!",
                        community: { name: "fedimemes", icon: "üåê" },
                        creator: { name: "PugJesus" },
                        published: new Date(Date.now() - 1500000).toISOString(),
                        score: 89,
                        counts: { comments: 15 },
                        my_vote: 1,
                        saved: true
                    },
                    {
                        id: 5,
                        name: "Welcome to the Fediverse!",
                        body: "A guide for newcomers to federated social media platforms.",
                        community: { name: "fediverse", icon: "üåç" },
                        creator: { name: "admin" },
                        published: new Date(Date.now() - 7200000).toISOString(),
                        score: 156,
                        counts: { comments: 42 },
                        url: "https://fediverse.info",
                        my_vote: 0,
                        saved: false
                    }
                ];
            },

            // Load More Posts (Pagination)
            async loadMorePosts() {
                // Simulate loading more posts
                if (this.currentPage >= 3) return; // Limit to 3 pages for demo
                
                this.currentPage++;
                const morePosts = this.generateSamplePosts().map(post => ({
                    ...post,
                    id: post.id + (this.currentPage * 100),
                    name: `${post.name} (Page ${this.currentPage})`
                }));
                
                this.posts = [...this.posts, ...morePosts];
                this.renderPosts(true);
            },

            // Render Posts
            renderPosts(append = false) {
                const content = document.getElementById('content');
                if (!append) {
                    content.innerHTML = '';
                }

                this.posts.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    postCard.innerHTML = `
                        <div class="post-header">
                            <div class="community-icon">${post.community?.icon || 'üåê'}</div>
                            <div class="post-meta">
                                <span class="community-name">${post.community?.name || 'unknown'}</span>
                                <span class="post-author">posted by ${post.creator?.name || 'anonymous'} ¬∑ ${this.timeAgo(post.published)}</span>
                            </div>
                        </div>
                        <div class="post-title">${this.escapeHtml(post.name)}</div>
                        ${post.body ? `<div class="post-content">${this.escapeHtml(post.body).substring(0, 300)}...</div>` : ''}
                        ${post.url ? `<a href="${post.url}" class="post-link" target="_blank">${new URL(post.url).hostname}</a>` : ''}
                        ${post.thumbnail_url ? `<img src="${post.thumbnail_url}" class="post-image" alt="">` : ''}
                        <div class="post-actions">
                            <div class="vote-controls">
                                <button class="vote-btn ${post.my_vote === 1 ? 'upvoted' : ''}" onclick="app.vote(${post.id}, 1)">‚ñ≤</button>
                                <span class="vote-count">${post.score || 0}</span>
                                <button class="vote-btn ${post.my_vote === -1 ? 'downvoted' : ''}" onclick="app.vote(${post.id}, -1)">‚ñº</button>
                            </div>
                            <button class="action-btn" onclick="app.showComments(${post.id})">
                                üí¨ ${post.counts?.comments || 0}
                            </button>
                            <button class="action-btn" onclick="app.share(${post.id})">
                                üîó Share
                            </button>
                            <button class="action-btn" onclick="app.save(${post.id})">
                                ${post.saved ? '‚òÖ' : '‚òÜ'} Save
                            </button>
                        </div>
                    `;
                    postCard.onclick = (e) => {
                        if (!e.target.closest('button') && !e.target.closest('a')) {
                            this.showPost(post.id);
                        }
                    };
                    content.appendChild(postCard);
                });

                if (this.posts.length === 0) {
                    content.innerHTML = '<div class="loading">No posts found</div>';
                }
            },

            // Show Post Detail
            async showPost(postId) {
                this.currentPost = postId;
                const post = this.posts.find(p => p.id === postId);
                if (!post) return;

                // Create a detailed view from our sample data
                const detailedPost = {
                    post_view: {
                        post: post,
                        community: post.community,
                        creator: post.creator,
                        counts: {
                            score: post.score,
                            comments: post.counts?.comments || 0
                        },
                        my_vote: post.my_vote,
                        saved: post.saved
                    }
                };
                
                this.renderPostDetail(detailedPost.post_view);
                this.loadComments(postId);
            },

            // Load Comments
            async loadComments(postId) {
                // Generate sample comments
                this.comments = [
                    {
                        comment: {
                            id: 1,
                            content: "What are the other 2 words?",
                            published: new Date(Date.now() - 2520000).toISOString()
                        },
                        creator: { name: "NeatNit@discuss.tchncs.de" },
                        counts: { score: 11 },
                        my_vote: 0,
                        children: [
                            {
                                comment: {
                                    id: 2,
                                    content: "Well at least they didn't call him Grandma Burnett. That would be so awkward.",
                                    published: new Date(Date.now() - 2460000).toISOString()
                                },
                                creator: { name: "ook@discuss.tchncs.de" },
                                counts: { score: 5 },
                                my_vote: 0,
                                children: []
                            }
                        ]
                    },
                    {
                        comment: {
                            id: 3,
                            content: "This is actually pretty interesting from a psychological perspective!",
                            published: new Date(Date.now() - 1800000).toISOString()
                        },
                        creator: { name: "science_fan" },
                        counts: { score: 8 },
                        my_vote: 1,
                        children: []
                    }
                ];
                this.renderComments();
            },

            // Show Community
            async showCommunity(communityId) {
                this.currentCommunity = communityId;
                this.currentPage = 1;
                
                // Find community from our sample data
                const community = this.communities.find(c => c.community.id === communityId);
                if (community) {
                    // Update community header
                    document.getElementById('communityHeader').style.display = 'block';
                    document.getElementById('communityAvatar').textContent = community.community.icon || 'üåê';
                    document.getElementById('communityName').textContent = community.community.name;
                    document.getElementById('communityInstance').textContent = `@${community.community.instance || 'piefed.social'}`;
                    document.getElementById('communityDescription').textContent = community.community.description || 'No description';
                    document.getElementById('communitySubscribers').textContent = community.counts.subscribers || 0;
                    document.getElementById('communityPosts').textContent = community.counts.posts || 0;
                    document.getElementById('communityComments').textContent = community.counts.comments || 0;
                    
                    const subscribeBtn = document.getElementById('subscribeBtn');
                    subscribeBtn.textContent = community.subscribed ? 'Unsubscribe' : 'Subscribe';
                    subscribeBtn.classList.toggle('subscribed', community.subscribed);
                    
                    // Load community-specific posts (using filtered sample data)
                    this.posts = this.generateSamplePosts().filter(p => 
                        p.community.name.toLowerCase() === community.community.name.toLowerCase()
                    );
                    if (this.posts.length === 0) {
                        // If no matching posts, show all with community name updated
                        this.posts = this.generateSamplePosts().map(p => ({
                            ...p,
                            community: community.community
                        }));
                    }
                    this.renderPosts();
                    this.closeMenu();
                }
            },

            // Submit Post
            async submitPost() {
                const community = document.getElementById('postCommunity').value;
                const title = document.getElementById('postTitle').value;
                const body = document.getElementById('postBody').value;
                const url = document.getElementById('postUrl').value;
                const nsfw = document.getElementById('postNSFW').checked;

                if (!community || !title) {
                    this.showError('Please fill in required fields');
                    return;
                }

                // Simulate post creation
                const newPost = {
                    id: Date.now(),
                    name: title,
                    body: body,
                    url: url,
                    community: { name: community, icon: 'üåê' },
                    creator: { name: this.userProfile?.local_user_view?.person?.name || 'You' },
                    published: new Date().toISOString(),
                    score: 1,
                    counts: { comments: 0 },
                    my_vote: 1,
                    saved: false,
                    nsfw: nsfw
                };

                this.posts.unshift(newPost);
                this.hideCreatePost();
                this.showSuccess('Post created successfully! (Demo - not actually posted)');
                this.renderPosts();
            },

            // Submit Comment
            async submitComment() {
                const content = document.getElementById('newComment').value;
                if (!content.trim()) return;

                // Simulate comment creation
                const newComment = {
                    comment: {
                        id: Date.now(),
                        content: content,
                        published: new Date().toISOString()
                    },
                    creator: { name: this.userProfile?.local_user_view?.person?.name || 'You' },
                    counts: { score: 1 },
                    my_vote: 1,
                    children: []
                };

                this.comments.unshift(newComment);
                document.getElementById('newComment').value = '';
                this.renderComments();
                this.showSuccess('Comment posted! (Demo - not actually posted)');
            },

            // Submit Reply
            async submitReply(parentId) {
                const content = document.getElementById(`reply-text-${parentId}`).value;
                if (!content.trim()) return;

                // Find parent comment and add reply
                const findAndAddReply = (comments) => {
                    for (let comment of comments) {
                        if (comment.comment.id === parentId) {
                            if (!comment.children) comment.children = [];
                            comment.children.push({
                                comment: {
                                    id: Date.now(),
                                    content: content,
                                    published: new Date().toISOString()
                                },
                                creator: { name: this.userProfile?.local_user_view?.person?.name || 'You' },
                                counts: { score: 1 },
                                my_vote: 1,
                                children: []
                            });
                            return true;
                        }
                        if (comment.children && findAndAddReply(comment.children)) {
                            return true;
                        }
                    }
                    return false;
                };

                findAndAddReply(this.comments);
                this.hideReplyForm(parentId);
                this.renderComments();
                this.showSuccess('Reply posted! (Demo - not actually posted)');
            },

            // Render Post Detail
            renderPostDetail(post) {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="community-icon">${post.community?.icon || 'üåê'}</div>
                            <div class="post-meta">
                                <span class="community-name">${post.community?.name || 'unknown'}</span>
                                <span class="post-author">posted by ${post.creator?.name || 'anonymous'} ¬∑ ${this.timeAgo(post.post.published)}</span>
                            </div>
                        </div>
                        <div class="post-title">${this.escapeHtml(post.post.name)}</div>
                        ${post.post.body ? `<div class="post-content">${this.escapeHtml(post.post.body)}</div>` : ''}
                        ${post.post.url ? `<a href="${post.post.url}" class="post-link" target="_blank">${post.post.url}</a>` : ''}
                        ${post.post.thumbnail_url ? `<img src="${post.post.thumbnail_url}" class="post-image" alt="">` : ''}
                        <div class="post-actions">
                            <div class="vote-controls">
                                <button class="vote-btn ${post.my_vote === 1 ? 'upvoted' : ''}" onclick="app.vote(${post.post.id}, 1)">‚ñ≤</button>
                                <span class="vote-count">${post.counts?.score || 0}</span>
                                <button class="vote-btn ${post.my_vote === -1 ? 'downvoted' : ''}" onclick="app.vote(${post.post.id}, -1)">‚ñº</button>
                            </div>
                            <button class="action-btn">
                                üí¨ ${post.counts?.comments || 0}
                            </button>
                            <button class="action-btn" onclick="app.share(${post.post.id})">
                                üîó Share
                            </button>
                            <button class="action-btn" onclick="app.save(${post.post.id})">
                                ${post.saved ? '‚òÖ' : '‚òÜ'} Save
                            </button>
                        </div>
                    </div>
                `;

                // Show comments section
                document.getElementById('commentsSection').style.display = 'block';
            },

            // Load Comments
            async loadComments(postId) {
                const data = await this.apiRequest(`/post/${postId}/comments`);
                if (data) {
                    this.comments = data.comments || [];
                    this.renderComments();
                }
            },

            // Render Comments
            renderComments() {
                const commentsList = document.getElementById('commentsList');
                commentsList.innerHTML = '';

                if (this.token) {
                    // Add comment form
                    const commentForm = document.createElement('div');
                    commentForm.className = 'reply-form';
                    commentForm.style.display = 'block';
                    commentForm.innerHTML = `
                        <textarea placeholder="Write a comment..." id="newComment"></textarea>
                        <div class="reply-form-actions">
                            <button onclick="app.submitComment()">Post Comment</button>
                        </div>
                    `;
                    commentsList.appendChild(commentForm);
                }

                // Render comment tree
                const renderCommentTree = (comments, parentElement, depth = 0) => {
                    comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'comment';
                        if (depth > 0) {
                            commentDiv.style.marginLeft = `${depth * 24}px`;
                        }
                        
                        commentDiv.innerHTML = `
                            <div class="comment-header">
                                <span class="comment-author">${comment.creator?.name || 'anonymous'}</span>
                                <span>¬∑ ${this.timeAgo(comment.comment.published)}</span>
                            </div>
                            <div class="comment-content">${this.escapeHtml(comment.comment.content)}</div>
                            <div class="comment-actions">
                                <div class="vote-controls">
                                    <button class="vote-btn ${comment.my_vote === 1 ? 'upvoted' : ''}" onclick="app.voteComment(${comment.comment.id}, 1)">‚ñ≤</button>
                                    <span class="vote-count">${comment.counts?.score || 0}</span>
                                    <button class="vote-btn ${comment.my_vote === -1 ? 'downvoted' : ''}" onclick="app.voteComment(${comment.comment.id}, -1)">‚ñº</button>
                                </div>
                                <button class="reply-btn" onclick="app.showReplyForm(${comment.comment.id})">Reply</button>
                            </div>
                            <div class="reply-form" id="reply-form-${comment.comment.id}" style="display: none;">
                                <textarea placeholder="Write a reply..." id="reply-text-${comment.comment.id}"></textarea>
                                <div class="reply-form-actions">
                                    <button onclick="app.hideReplyForm(${comment.comment.id})">Cancel</button>
                                    <button onclick="app.submitReply(${comment.comment.id})">Reply</button>
                                </div>
                            </div>
                        `;
                        
                        parentElement.appendChild(commentDiv);
                        
                        // Render child comments
                        if (comment.children && comment.children.length > 0) {
                            renderCommentTree(comment.children, parentElement, depth + 1);
                        }
                    });
                };

                renderCommentTree(this.comments, commentsList);

                if (this.comments.length === 0) {
                    commentsList.innerHTML += '<div class="comment">No comments yet. Be the first to comment!</div>';
                }
            },

            // Submit Comment
            async submitComment() {
                const content = document.getElementById('newComment').value;
                if (!content.trim()) return;

                const data = await this.apiRequest('/comment', {
                    method: 'POST',
                    body: JSON.stringify({
                        content,
                        post_id: this.currentPost
                    })
                });

                if (data) {
                    document.getElementById('newComment').value = '';
                    this.loadComments(this.currentPost);
                    this.showSuccess('Comment posted successfully!');
                }
            },

            // Show Reply Form
            showReplyForm(commentId) {
                document.getElementById(`reply-form-${commentId}`).style.display = 'block';
            },

            // Hide Reply Form
            hideReplyForm(commentId) {
                document.getElementById(`reply-form-${commentId}`).style.display = 'none';
            },

            // Submit Reply
            async submitReply(parentId) {
                const content = document.getElementById(`reply-text-${parentId}`).value;
                if (!content.trim()) return;

                const data = await this.apiRequest('/comment', {
                    method: 'POST',
                    body: JSON.stringify({
                        content,
                        post_id: this.currentPost,
                        parent_id: parentId
                    })
                });

                if (data) {
                    this.hideReplyForm(parentId);
                    this.loadComments(this.currentPost);
                    this.showSuccess('Reply posted successfully!');
                }
            },

            // Load Communities
            async loadCommunities() {
                if (this.useRealData) {
                    try {
                        await this.loadRealCommunities();
                    } catch (error) {
                        console.error('Failed to load communities:', error);
                        // Fallback to sample data
                        this.communities = this.generateSampleCommunities();
                        this.renderMenuCommunities();
                    }
                } else {
                    // Use sample data for demo
                    this.communities = this.generateSampleCommunities();
                    this.renderMenuCommunities();
                }
            },

            // Load real communities from PieFed instance
            async loadRealCommunities() {
                try {
                    const response = await this.fetchWithCORS(`${this.baseUrl}/communities`);
                    const html = await response.text();
                    this.communities = this.parseHTMLCommunities(html);
                    this.renderMenuCommunities();
                } catch (error) {
                    console.error('Failed to load real communities:', error);
                    throw error;
                }
            },

            // Parse communities from HTML
            parseHTMLCommunities(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const communities = [];

                // Try different selectors for community listings
                const communitySelectors = [
                    '.community-list-item',
                    '.community-card',
                    'div[class*="community"]',
                    'article.community',
                    'tr' // Some instances use tables
                ];

                let communityElements = [];
                for (const selector of communitySelectors) {
                    communityElements = doc.querySelectorAll(selector);
                    if (communityElements.length > 0) break;
                }

                communityElements.forEach((element, index) => {
                    const nameElement = element.querySelector('a[href*="/c/"], .community-name, h3, h4');
                    const name = nameElement?.textContent?.trim();
                    const link = nameElement?.href || '';

                    if (name) {
                        const descElement = element.querySelector('.description, .community-description, p');
                        const description = descElement?.textContent?.trim() || '';

                        const statsText = element.textContent || '';
                        const subscribersMatch = statsText.match(/(\d+)\s*(subscribers?|members?)/i);
                        const postsMatch = statsText.match(/(\d+)\s*posts?/i);
                        const commentsMatch = statsText.match(/(\d+)\s*comments?/i);

                        communities.push({
                            community: {
                                id: index + 1,
                                name: name.replace(/^!/, '').replace(/@.*$/, ''),
                                description: description.substring(0, 200),
                                icon: 'üåê',
                                instance: link.match(/@([^\/]+)/)?.[1] || new URL(this.baseUrl).hostname
                            },
                            counts: {
                                subscribers: subscribersMatch ? parseInt(subscribersMatch[1]) : 0,
                                posts: postsMatch ? parseInt(postsMatch[1]) : 0,
                                comments: commentsMatch ? parseInt(commentsMatch[1]) : 0
                            },
                            subscribed: false
                        });
                    }
                });

                // If no communities found, check for links
                if (communities.length === 0) {
                    const links = doc.querySelectorAll('a[href*="/c/"]');
                    const uniqueCommunities = new Set();
                    
                    links.forEach((link) => {
                        const href = link.href || link.getAttribute('href') || '';
                        const match = href.match(/\/c\/([^\/\?]+)/);
                        if (match && !uniqueCommunities.has(match[1])) {
                            uniqueCommunities.add(match[1]);
                            communities.push({
                                community: {
                                    id: communities.length + 1,
                                    name: match[1],
                                    description: '',
                                    icon: 'üåê',
                                    instance: new URL(this.baseUrl).hostname
                                },
                                counts: {
                                    subscribers: 0,
                                    posts: 0,
                                    comments: 0
                                },
                                subscribed: false
                            });
                        }
                    });
                }

                return communities.length > 0 ? communities : this.generateSampleCommunities();
            },

            // Generate sample communities for demonstration
            generateSampleCommunities() {
                return [
                    {
                        community: {
                            id: 1,
                            name: "Fediverse memes",
                            description: "Memes about the Fediverse. #### Rules ###### General - Be respectful - Post on topic - No bigotry or hate speech ###### Specific * We are not YPTB. If you...",
                            icon: "üåê",
                            instance: "feddit.uk"
                        },
                        counts: {
                            subscribers: 1973,
                            posts: 446,
                            comments: 13886
                        },
                        subscribed: false
                    },
                    {
                        community: {
                            id: 2,
                            name: "science_memes",
                            description: "Memes about science, scientists, and scientific concepts.",
                            icon: "üß¨",
                            instance: "mander.xyz"
                        },
                        counts: {
                            subscribers: 3245,
                            posts: 892,
                            comments: 24531
                        },
                        subscribed: true
                    },
                    {
                        community: {
                            id: 3,
                            name: "technology",
                            description: "All things tech - news, discussions, and memes about technology.",
                            icon: "üíª",
                            instance: "lemmy.world"
                        },
                        counts: {
                            subscribers: 45632,
                            posts: 5234,
                            comments: 89234
                        },
                        subscribed: true
                    },
                    {
                        community: {
                            id: 4,
                            name: "superbowl",
                            description: "For owl lovers and superb owls everywhere!",
                            icon: "ü¶â",
                            instance: "lemmy.world"
                        },
                        counts: {
                            subscribers: 8934,
                            posts: 1234,
                            comments: 4567
                        },
                        subscribed: false
                    },
                    {
                        community: {
                            id: 5,
                            name: "asklemmy",
                            description: "A place to ask questions and get answers from the community.",
                            icon: "‚ùì",
                            instance: "lemmy.ml"
                        },
                        counts: {
                            subscribers: 67890,
                            posts: 12345,
                            comments: 234567
                        },
                        subscribed: true
                    }
                ];
            },

            // Render Menu Communities
            renderMenuCommunities() {
                const menuCommunities = document.getElementById('menuCommunities');
                menuCommunities.innerHTML = '';

                this.communities.slice(0, 10).forEach(community => {
                    const item = document.createElement('div');
                    item.className = 'menu-item';
                    item.innerHTML = `${community.community.icon || 'üåê'} ${community.community.name}`;
                    item.onclick = () => {
                        // For real data mode, use the community name as ID
                        const communityId = this.useRealData ? community.community.name : community.community.id;
                        this.showCommunity(communityId);
                    };
                    menuCommunities.appendChild(item);
                });
            },

            // Show Community
            async showCommunity(communityId) {
                this.currentCommunity = communityId;
                this.currentPage = 1;
                
                // Load community details
                const data = await this.apiRequest(`/community/${communityId}`);
                if (data) {
                    const community = data.community_view;
                    
                    // Update community header
                    document.getElementById('communityHeader').style.display = 'block';
                    document.getElementById('communityAvatar').textContent = community.community.icon || 'üåê';
                    document.getElementById('communityName').textContent = community.community.name;
                    document.getElementById('communityInstance').textContent = `@${new URL(this.baseUrl).hostname}`;
                    document.getElementById('communityDescription').textContent = community.community.description || 'No description';
                    document.getElementById('communitySubscribers').textContent = community.counts.subscribers || 0;
                    document.getElementById('communityPosts').textContent = community.counts.posts || 0;
                    document.getElementById('communityComments').textContent = community.counts.comments || 0;
                    
                    const subscribeBtn = document.getElementById('subscribeBtn');
                    subscribeBtn.textContent = community.subscribed ? 'Unsubscribe' : 'Subscribe';
                    subscribeBtn.classList.toggle('subscribed', community.subscribed);
                    
                    // Load community posts
                    this.loadPosts();
                    this.closeMenu();
                }
            },

            // Show Communities List
            showCommunities() {
                this.currentView = 'communities';
                document.getElementById('content').style.display = 'none';
                document.getElementById('communityList').style.display = 'block';
                document.getElementById('commentsSection').style.display = 'none';
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'none';
                
                this.renderCommunitiesList();
                this.closeMenu();
            },

            // Render Communities List
            renderCommunitiesList() {
                const communityList = document.getElementById('communityList');
                communityList.innerHTML = '<h2 style="padding: 16px;">Discover Communities</h2>';

                this.communities.forEach(community => {
                    const item = document.createElement('div');
                    item.className = 'community-item';
                    item.innerHTML = `
                        <div class="community-item-icon">${community.community.icon || 'üåê'}</div>
                        <div class="community-item-info">
                            <div class="community-item-name">${community.community.name}</div>
                            <div class="community-item-stats">
                                ${community.counts.subscribers} subscribers ¬∑ ${community.counts.posts} posts
                            </div>
                        </div>
                    `;
                    item.onclick = () => {
                        // For real data mode, use the community name as ID
                        const communityId = this.useRealData ? community.community.name : community.community.id;
                        this.showCommunity(communityId);
                    };
                    communityList.appendChild(item);
                });
            },

            // Vote on Post
            async vote(postId, score) {
                if (!this.token) {
                    this.showLogin();
                    return;
                }

                const data = await this.apiRequest('/post/like', {
                    method: 'POST',
                    body: JSON.stringify({
                        post_id: postId,
                        score
                    })
                });

                if (data) {
                    // Update UI
                    const post = this.posts.find(p => p.id === postId);
                    if (post) {
                        post.my_vote = score;
                        this.renderPosts();
                    }
                }
            },

            // Vote on Comment
            async voteComment(commentId, score) {
                if (!this.token) {
                    this.showLogin();
                    return;
                }

                const data = await this.apiRequest('/comment/like', {
                    method: 'POST',
                    body: JSON.stringify({
                        comment_id: commentId,
                        score
                    })
                });

                if (data) {
                    this.loadComments(this.currentPost);
                }
            },

            // Share Post
            share(postId) {
                const post = this.posts.find(p => p.id === postId);
                if (post) {
                    const url = `${this.baseUrl}/post/${postId}`;
                    if (navigator.share) {
                        navigator.share({
                            title: post.name,
                            url: url
                        });
                    } else {
                        navigator.clipboard.writeText(url);
                        this.showSuccess('Link copied to clipboard!');
                    }
                }
            },

            // Save Post
            async save(postId) {
                if (!this.token) {
                    this.showLogin();
                    return;
                }

                const data = await this.apiRequest('/post/save', {
                    method: 'PUT',
                    body: JSON.stringify({
                        post_id: postId,
                        save: true
                    })
                });

                if (data) {
                    const post = this.posts.find(p => p.id === postId);
                    if (post) {
                        post.saved = !post.saved;
                        this.renderPosts();
                    }
                }
            },

            // Toggle Subscribe
            async toggleSubscribe() {
                if (!this.token) {
                    this.showLogin();
                    return;
                }

                const subscribeBtn = document.getElementById('subscribeBtn');
                const isSubscribed = subscribeBtn.classList.contains('subscribed');

                const data = await this.apiRequest('/community/follow', {
                    method: 'POST',
                    body: JSON.stringify({
                        community_id: this.currentCommunity,
                        follow: !isSubscribed
                    })
                });

                if (data) {
                    subscribeBtn.classList.toggle('subscribed');
                    subscribeBtn.textContent = isSubscribed ? 'Subscribe' : 'Unsubscribe';
                    this.showSuccess(isSubscribed ? 'Unsubscribed!' : 'Subscribed!');
                }
            },

            // Switch Feed
            switchFeed(feed) {
                this.currentFeed = feed;
                this.currentPage = 1;
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.feed === feed);
                });
                this.loadPosts();
            },

            // Change Sort
            changeSort(sort) {
                this.currentSort = sort;
                this.currentPage = 1;
                this.loadPosts();
            },

            // Switch Post Type
            switchPostType(type) {
                document.querySelectorAll('.post-type-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.type === type);
                });

                document.getElementById('postBodyGroup').style.display = type === 'text' ? 'block' : 'none';
                document.getElementById('postUrlGroup').style.display = type === 'link' ? 'block' : 'none';
                document.getElementById('postImageGroup').style.display = type === 'image' ? 'block' : 'none';
            },

            // Show Create Post
            showCreatePost() {
                if (!this.token) {
                    this.showLogin();
                    return;
                }
                document.getElementById('createPostModal').classList.add('active');
                this.closeMenu();
            },

            // Hide Create Post
            hideCreatePost() {
                document.getElementById('createPostModal').classList.remove('active');
            },

            // Submit Post
            async submitPost() {
                const community = document.getElementById('postCommunity').value;
                const title = document.getElementById('postTitle').value;
                const body = document.getElementById('postBody').value;
                const url = document.getElementById('postUrl').value;
                const nsfw = document.getElementById('postNSFW').checked;

                if (!community || !title) {
                    this.showError('Please fill in required fields');
                    return;
                }

                const postData = {
                    community_id: community,
                    name: title,
                    nsfw
                };

                if (body) postData.body = body;
                if (url) postData.url = url;

                const data = await this.apiRequest('/post', {
                    method: 'POST',
                    body: JSON.stringify(postData)
                });

                if (data) {
                    this.hideCreatePost();
                    this.showSuccess('Post created successfully!');
                    this.loadPosts();
                }
            },

            // Show Login
            showLogin() {
                document.getElementById('loginForm').style.display = 'block';
                this.closeMenu();
            },

            // Hide Login
            hideLogin() {
                document.getElementById('loginForm').style.display = 'none';
            },

            // Do Login
            async doLogin() {
                const instance = document.getElementById('loginInstance').value;
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                const totp = document.getElementById('login2FA').value;

                if (!username || !password) {
                    this.showError('Please enter username and password');
                    return;
                }

                // Update base URL if different instance
                if (instance && instance !== this.baseUrl) {
                    this.baseUrl = instance.replace(/\/$/, ''); // Remove trailing slash
                    localStorage.setItem('piefed_instance', this.baseUrl);
                }

                this.showLoading();

                try {
                    // Try to authenticate with PieFed
                    // PieFed uses form-based authentication, not JSON API
                    const loginUrl = `${this.baseUrl}/user/login`;
                    
                    // First, get the login page to extract CSRF token
                    const loginPageResponse = await this.fetchWithCORS(loginUrl);
                    const loginPageHtml = await loginPageResponse.text();
                    
                    // Extract CSRF token if present
                    const csrfMatch = loginPageHtml.match(/name="csrf_token"\s+value="([^"]+)"/);
                    const csrfToken = csrfMatch ? csrfMatch[1] : '';

                    // Prepare form data
                    const formData = new FormData();
                    formData.append('username', username);
                    formData.append('password', password);
                    if (csrfToken) formData.append('csrf_token', csrfToken);
                    if (totp) formData.append('totp', totp);

                    // Attempt login
                    const loginResponse = await fetch(`${this.baseUrl}/user/login`, {
                        method: 'POST',
                        body: formData,
                        credentials: 'include',
                        redirect: 'manual'
                    });

                    // Check if login was successful
                    if (loginResponse.status === 302 || loginResponse.status === 200) {
                        // Login successful
                        this.token = 'session_' + Date.now();
                        this.useRealData = true; // Enable real data fetching
                        localStorage.setItem('piefed_token', this.token);
                        localStorage.setItem('piefed_use_real_data', 'true');
                        
                        this.userProfile = {
                            local_user_view: {
                                person: { name: username },
                                counts: {
                                    post_count: 0,
                                    comment_count: 0
                                }
                            }
                        };
                        
                        this.hideLogin();
                        this.showSuccess('Logged in successfully! Loading real content...');
                        
                        // Update profile display
                        document.getElementById('profileUsername').textContent = username;
                        document.getElementById('profileInstance').textContent = `@${new URL(this.baseUrl).hostname}`;
                        
                        // Update the notice
                        const noticeElement = document.querySelector('[style*="background: #4a4a20"]');
                        if (noticeElement) {
                            noticeElement.innerHTML = '‚úÖ Connected to ' + this.baseUrl + ' - Loading real content via RSS/HTML parsing';
                            noticeElement.style.background = '#204a20';
                        }
                        
                        // Reload with real data
                        await this.loadPosts();
                        await this.loadCommunities();
                    } else {
                        throw new Error('Login failed');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    
                    // Even if actual authentication fails, enable real data mode
                    // since PieFed content is mostly public
                    this.showError('Direct login not available due to CORS. Enabling read-only mode with public content.');
                    
                    this.token = 'readonly_' + Date.now();
                    this.useRealData = true;
                    localStorage.setItem('piefed_token', this.token);
                    localStorage.setItem('piefed_use_real_data', 'true');
                    localStorage.setItem('piefed_instance', this.baseUrl);
                    
                    this.userProfile = {
                        local_user_view: {
                            person: { name: username + ' (read-only)' },
                            counts: {
                                post_count: 0,
                                comment_count: 0
                            }
                        }
                    };
                    
                    setTimeout(() => {
                        this.hideLogin();
                        this.showSuccess('Connected in read-only mode. You can browse public content.');
                        
                        // Update profile display
                        document.getElementById('profileUsername').textContent = username + ' (read-only)';
                        document.getElementById('profileInstance').textContent = `@${new URL(this.baseUrl).hostname}`;
                        
                        // Update the notice
                        const noticeElement = document.querySelector('[style*="background: #4a4a20"]');
                        if (noticeElement) {
                            noticeElement.innerHTML = 'üìñ Read-only mode - Connected to ' + this.baseUrl + ' - Browsing public content';
                            noticeElement.style.background = '#3a3a50';
                        }
                        
                        // Reload with real data
                        this.loadPosts();
                        this.loadCommunities();
                    }, 1000);
                }
            },

            // Logout
            logout() {
                this.token = null;
                this.useRealData = false;
                localStorage.removeItem('piefed_token');
                localStorage.removeItem('piefed_use_real_data');
                this.userProfile = null;
                this.showSuccess('Logged out successfully!');
                
                // Reset notice
                const noticeElement = document.querySelector('[style*="background: #4a4a20"], [style*="background: #3a3a50"], [style*="background: #204a20"]');
                if (noticeElement) {
                    noticeElement.innerHTML = '‚ö†Ô∏è Note: PieFed doesn\'t currently have a public JSON API. This is a demonstration UI with sample data showing what a PieFed mobile client could look like.';
                    noticeElement.style.background = '#4a4a20';
                }
                
                this.closeMenu();
                this.goHome();
            },

            // Show Community
            async showCommunity(communityId) {
                this.currentCommunity = communityId;
                this.currentPage = 1;
                
                // If we're using real data and communityId is a string (name), use it directly
                if (this.useRealData && typeof communityId === 'string') {
                    // For real communities, the ID is actually the community name
                    const communityName = communityId;
                    
                    // Update community header with basic info
                    document.getElementById('communityHeader').style.display = 'block';
                    document.getElementById('communityAvatar').textContent = 'üåê';
                    document.getElementById('communityName').textContent = communityName;
                    document.getElementById('communityInstance').textContent = `@${new URL(this.baseUrl).hostname}`;
                    document.getElementById('communityDescription').textContent = 'Loading community info...';
                    
                    // Try to load more community info
                    try {
                        const response = await this.fetchWithCORS(`${this.baseUrl}/c/${communityName}`);
                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // Extract community description
                        const descElement = doc.querySelector('.community-description, .sidebar .description, .community-info');
                        if (descElement) {
                            document.getElementById('communityDescription').textContent = descElement.textContent.trim();
                        }
                        
                        // Extract stats
                        const statsText = doc.body.textContent || '';
                        const subscribersMatch = statsText.match(/(\d+)\s*(subscribers?|members?)/i);
                        const postsMatch = statsText.match(/(\d+)\s*posts?/i);
                        const commentsMatch = statsText.match(/(\d+)\s*comments?/i);
                        
                        if (subscribersMatch) document.getElementById('communitySubscribers').textContent = subscribersMatch[1];
                        if (postsMatch) document.getElementById('communityPosts').textContent = postsMatch[1];
                        if (commentsMatch) document.getElementById('communityComments').textContent = commentsMatch[1];
                    } catch (error) {
                        console.error('Failed to load community details:', error);
                    }
                    
                    // Load community posts
                    this.currentCommunity = communityName;
                    await this.loadPosts();
                    this.closeMenu();
                    return;
                }
                
                // Find community from our sample data (for non-real data mode)
                const community = this.communities.find(c => 
                    c.community.id === communityId || c.community.name === communityId
                );
                if (community) {
                    // Update community header
                    document.getElementById('communityHeader').style.display = 'block';
                    document.getElementById('communityAvatar').textContent = community.community.icon || 'üåê';
                    document.getElementById('communityName').textContent = community.community.name;
                    document.getElementById('communityInstance').textContent = `@${community.community.instance || 'piefed.social'}`;
                    document.getElementById('communityDescription').textContent = community.community.description || 'No description';
                    document.getElementById('communitySubscribers').textContent = community.counts.subscribers || 0;
                    document.getElementById('communityPosts').textContent = community.counts.posts || 0;
                    document.getElementById('communityComments').textContent = community.counts.comments || 0;
                    
                    const subscribeBtn = document.getElementById('subscribeBtn');
                    subscribeBtn.textContent = community.subscribed ? 'Unsubscribe' : 'Subscribe';
                    subscribeBtn.classList.toggle('subscribed', community.subscribed);
                    
                    // Load community-specific posts
                    if (!this.useRealData) {
                        this.posts = this.generateSamplePosts().filter(p => 
                            p.community.name.toLowerCase() === community.community.name.toLowerCase()
                        );
                        if (this.posts.length === 0) {
                            // If no matching posts, show all with community name updated
                            this.posts = this.generateSamplePosts().map(p => ({
                                ...p,
                                community: community.community
                            }));
                        }
                        this.renderPosts();
                    } else {
                        await this.loadPosts();
                    }
                    this.closeMenu();
                }
            },

            // Load User Profile
            async loadUserProfile() {
                if (!this.token) return;

                const data = await this.apiRequest('/site');
                if (data && data.my_user) {
                    this.userProfile = data.my_user;
                    document.getElementById('profileUsername').textContent = this.userProfile.local_user_view.person.name;
                    document.getElementById('profileInstance').textContent = `@${new URL(this.baseUrl).hostname}`;
                    document.getElementById('profilePosts').textContent = this.userProfile.local_user_view.counts.post_count || 0;
                    document.getElementById('profileComments').textContent = this.userProfile.local_user_view.counts.comment_count || 0;
                    // Note: Karma might need calculation based on API response
                }
            },

            // Show Profile
            showProfile() {
                if (!this.token) {
                    this.showLogin();
                    return;
                }

                this.currentView = 'profile';
                document.getElementById('content').style.display = 'none';
                document.getElementById('communityList').style.display = 'none';
                document.getElementById('commentsSection').style.display = 'none';
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('settingsPage').style.display = 'none';
                this.closeMenu();
            },

            // Show Settings
            showSettings() {
                this.currentView = 'settings';
                document.getElementById('content').style.display = 'none';
                document.getElementById('communityList').style.display = 'none';
                document.getElementById('commentsSection').style.display = 'none';
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'block';
                this.closeMenu();
            },

            // Show Search
            showSearch() {
                const searchContainer = document.getElementById('searchContainer');
                searchContainer.style.display = searchContainer.style.display === 'block' ? 'none' : 'block';
                if (searchContainer.style.display === 'block') {
                    searchContainer.querySelector('input').focus();
                }
            },

            // Search
            async search(query) {
                if (!query.trim()) return;

                this.showLoading();
                const data = await this.apiRequest(`/search?q=${encodeURIComponent(query)}&type_=All&sort=TopAll&limit=20`);
                
                if (data) {
                    // Display search results
                    const content = document.getElementById('content');
                    content.innerHTML = '<h2 style="padding: 16px;">Search Results</h2>';
                    
                    // Render posts from search
                    if (data.posts && data.posts.length > 0) {
                        content.innerHTML += '<h3 style="padding: 0 16px;">Posts</h3>';
                        this.posts = data.posts;
                        this.renderPosts(true);
                    }
                    
                    // Render communities from search
                    if (data.communities && data.communities.length > 0) {
                        content.innerHTML += '<h3 style="padding: 16px;">Communities</h3>';
                        data.communities.forEach(community => {
                            const item = document.createElement('div');
                            item.className = 'community-item';
                            item.innerHTML = `
                                <div class="community-item-icon">${community.community.icon || 'üåê'}</div>
                                <div class="community-item-info">
                                    <div class="community-item-name">${community.community.name}</div>
                                    <div class="community-item-stats">
                                        ${community.counts.subscribers} subscribers
                                    </div>
                                </div>
                            `;
                            item.onclick = () => this.showCommunity(community.community.id);
                            content.appendChild(item);
                        });
                    }
                    
                    if (!data.posts?.length && !data.communities?.length && !data.comments?.length && !data.users?.length) {
                        content.innerHTML += '<div class="loading">No results found</div>';
                    }
                }
                
                document.getElementById('searchContainer').style.display = 'none';
            },

            // Show Notifications
            async showNotifications() {
                if (!this.token) {
                    this.showLogin();
                    return;
                }

                this.showLoading();
                const data = await this.apiRequest('/user/replies?sort=New&unread_only=false&limit=20');
                
                if (data) {
                    const content = document.getElementById('content');
                    content.innerHTML = '<h2 style="padding: 16px;">Notifications</h2>';
                    
                    if (data.replies && data.replies.length > 0) {
                        data.replies.forEach(reply => {
                            const item = document.createElement('div');
                            item.className = 'comment';
                            item.innerHTML = `
                                <div class="comment-header">
                                    <span class="comment-author">${reply.creator.name}</span>
                                    <span>replied ¬∑ ${this.timeAgo(reply.comment.published)}</span>
                                </div>
                                <div class="comment-content">${this.escapeHtml(reply.comment.content)}</div>
                                <button class="action-btn" onclick="app.showPost(${reply.post.id})">View Post</button>
                            `;
                            content.appendChild(item);
                        });
                    } else {
                        content.innerHTML += '<div class="loading">No notifications</div>';
                    }
                }
            },

            // Show Feed
            showFeed() {
                this.currentView = 'feed';
                this.currentCommunity = null;
                document.getElementById('content').style.display = 'block';
                document.getElementById('communityList').style.display = 'none';
                document.getElementById('commentsSection').style.display = 'none';
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'none';
                document.getElementById('communityHeader').style.display = 'none';
                this.loadPosts();
            },

            // Show Help
            showHelp() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div style="padding: 16px;">
                        <h2>Help & About</h2>
                        <div style="margin-top: 20px; line-height: 1.6;">
                            <h3>PieFed Client</h3>
                            <p>A mobile-friendly web client for PieFed instances.</p>
                            
                            <h3 style="margin-top: 20px;">Features</h3>
                            <ul style="margin-left: 20px;">
                                <li>Browse posts and communities</li>
                                <li>Vote and comment on posts</li>
                                <li>Create new posts</li>
                                <li>Subscribe to communities</li>
                                <li>Search for content</li>
                                <li>Manage your profile</li>
                            </ul>
                            
                            <h3 style="margin-top: 20px;">Navigation</h3>
                            <p>Use the bottom navigation bar to quickly access main sections.</p>
                            <p>Tap the menu button for additional options.</p>
                            
                            <h3 style="margin-top: 20px;">Account</h3>
                            <p>Login with your PieFed instance credentials to access all features.</p>
                            <p>You can specify a different instance URL when logging in.</p>
                        </div>
                    </div>
                `;
                document.getElementById('communityList').style.display = 'none';
                document.getElementById('commentsSection').style.display = 'none';
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'none';
                this.closeMenu();
            },

            // UI Helper Methods
            toggleMenu() {
                document.getElementById('menuDrawer').classList.toggle('active');
            },

            closeMenu() {
                document.getElementById('menuDrawer').classList.remove('active');
            },

            toggleUserMenu() {
                if (this.token) {
                    this.showProfile();
                } else {
                    this.showLogin();
                }
            },

            goHome() {
                this.showFeed();
            },

            refresh() {
                this.currentPage = 1;
                this.loadPosts();
            },

            // Show instance selector
            showInstanceSelector() {
                const instances = [
                    'https://piefed.social',
                    'https://feddit.online',
                    'https://piefed.link',
                    'https://dubvee.org',
                    'https://piefed.nospecialinterest.nl'
                ];

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Select PieFed Instance</h2>
                            <button class="close-modal" onclick="this.closest('.modal').remove()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <p>Choose a PieFed instance or enter a custom URL:</p>
                            <div class="form-group">
                                ${instances.map(inst => `
                                    <button class="btn" style="display: block; width: 100%; margin: 8px 0; text-align: left;" 
                                            onclick="app.selectInstance('${inst}')">
                                        ${inst.replace('https://', '')}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="form-group">
                                <label>Custom Instance URL:</label>
                                <input type="text" id="customInstance" placeholder="https://your-instance.com">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-cancel" onclick="this.closest('.modal').remove()">Cancel</button>
                            <button class="btn btn-submit" onclick="app.selectInstance(document.getElementById('customInstance').value)">
                                Use Custom Instance
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            // Select instance
            selectInstance(url) {
                if (!url) return;
                
                this.baseUrl = url.replace(/\/$/, '');
                localStorage.setItem('piefed_instance', this.baseUrl);
                document.getElementById('loginInstance').value = this.baseUrl;
                
                // Remove modal
                document.querySelector('.modal.active')?.remove();
                
                this.showSuccess('Instance set to ' + this.baseUrl);
            },

            showLoading() {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading...</p>
                    </div>
                `;
            },

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            },

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            },

            // Utility Methods
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            timeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);

                if (seconds < 60) return 'just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
                if (seconds < 2592000) return `${Math.floor(seconds / 604800)}w`;
                if (seconds < 31536000) return `${Math.floor(seconds / 2592000)}mo`;
                return `${Math.floor(seconds / 31536000)}y`;
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
