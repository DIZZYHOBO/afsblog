<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèòÔ∏è</text></svg>">
    <title>Blog Feed - Communities</title>
    <!-- External Libraries for Media and Markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/DOMPurify/3.0.7/purify.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.4;
        }

        .header {
            background-color: #1a1a1b;
            padding: 12px 16px;
            border-bottom: 1px solid #343536;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #ff4500;
            cursor: pointer;
        }

        .auth-section {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            background: #0079d3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #1484d6;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #0079d3;
            color: #0079d3;
        }

        .btn-secondary:hover {
            background: #0079d3;
            color: white;
        }

        .btn-community {
            background: #ff4500;
            color: white;
        }

        .btn-community:hover {
            background: #ff6b35;
        }

        .btn-admin {
            background: #e11d48;
            color: white;
            font-size: 11px;
        }

        .btn-admin:hover {
            background: #be123c;
        }

        .admin-badge {
            background: #e11d48;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 4px;
        }

        .nav-menu {
            display: flex;
            background: #1a1a1b;
            margin: 12px 0;
            border-radius: 20px;
            overflow: hidden;
        }

        .nav-menu button {
            flex: 1;
            background: transparent;
            color: #818384;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-menu button.active {
            background: #272729;
            color: #fff;
        }

        /* Community specific styles */
        .community-card {
            background: #1a1a1b;
            margin: 8px 0;
            border-radius: 12px;
            border: 1px solid #343536;
            padding: 16px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .community-card:hover {
            border-color: #ff4500;
        }

        .community-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .community-info h3 {
            color: #ff4500;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .community-name {
            color: #818384;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .community-description {
            color: #d7dadc;
            font-size: 14px;
            line-height: 1.4;
        }

        .community-stats {
            display: flex;
            gap: 16px;
            color: #818384;
            font-size: 12px;
        }

        .community-badge {
            background: #ff4500;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .post-community {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .post-community-link {
            color: #ff4500;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(255, 69, 0, 0.1);
        }

        .post-community-link:hover {
            background: rgba(255, 69, 0, 0.2);
        }

        /* Admin Panel Styles */
        .admin-panel {
            background: #1a1a1b;
            border: 1px solid #e11d48;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .admin-panel-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            color: #e11d48;
            font-weight: bold;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .admin-stat-card {
            background: #272729;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .admin-stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #e11d48;
        }

        .admin-stat-label {
            font-size: 12px;
            color: #818384;
            margin-top: 4px;
        }

        .admin-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .admin-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #343536;
        }

        .admin-section h4 {
            color: #e11d48;
            margin-bottom: 12px;
        }

        .user-card {
            background: #272729;
            border: 1px solid #343536;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .user-card.pending {
            border-color: #f59e0b;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .user-info {
            color: #d7dadc;
            font-size: 14px;
        }

        .user-actions {
            display: flex;
            gap: 4px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .btn-approve {
            background: #059669;
        }

        .btn-reject, .btn-delete {
            background: #dc2626;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
        }

        .modal-content {
            background: #1a1a1b;
            margin: 20px;
            margin-top: 60px;
            border-radius: 8px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #343536;
        }

        .close-btn {
            background: none;
            border: none;
            color: #818384;
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #d7dadc;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            background: #272729;
            border: 1px solid #343536;
            border-radius: 4px;
            padding: 12px;
            color: #d7dadc;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group small {
            color: #818384;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        /* Feed container styles */
        .feed-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 16px;
        }

        @media (min-width: 769px) {
            .feed-container {
                max-width: 500px;
                padding: 0 20px;
            }
        }

        @media (min-width: 1200px) {
            .feed-container {
                max-width: 550px;
                padding: 0 40px;
            }
        }

        .post-card {
            background: #1a1a1b;
            margin: 8px 0;
            border-radius: 12px;
            border: 1px solid #343536;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .post-card.private {
            border-left: 4px solid #ff4500;
        }

        .post-header {
            background: #272729;
            padding: 12px 16px;
            border-bottom: 1px solid #343536;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .post-header .username {
            color: #0079d3;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .post-header .username:hover {
            text-decoration: underline;
        }

        .post-header .timestamp {
            color: #818384;
            font-size: 12px;
            margin-left: auto;
        }

        .private-badge {
            background: #ff4500;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .post-body {
            padding: 16px;
        }

        .post-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 12px;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .post-content {
            color: #d7dadc;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .post-actions {
            background: #272729;
            border-top: 1px solid #343536;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: #818384;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            flex: 1;
            transition: all 0.2s ease;
            min-width: 0;
            position: relative;
        }

        .action-btn:hover {
            background: #343536;
            color: #fff;
        }

        .action-btn:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 20px;
            width: 1px;
            background: #343536;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #818384;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #818384;
        }

        .error-message {
            background: #b91c1c;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .success-message {
            background: #059669;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        /* Page specific styles */
        .page-header {
            background: #1a1a1b;
            padding: 12px 16px;
            border-bottom: 1px solid #343536;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .back-btn {
            background: none;
            border: none;
            color: #818384;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .back-btn:hover {
            background: #272729;
            color: #fff;
        }

        .page-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .community-page {
            display: none;
        }

        .community-detail-header {
            background: #1a1a1b;
            padding: 20px;
            border: 1px solid #343536;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .community-detail-header h1 {
            color: #ff4500;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .community-detail-header .description {
            color: #d7dadc;
            margin-bottom: 12px;
        }

        .community-detail-stats {
            display: flex;
            gap: 20px;
            color: #818384;
            font-size: 14px;
        }

        /* Compose button */
        .compose-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #ff4500;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 50;
        }

        .compose-btn.community {
            background: #0079d3;
        }

        /* Profile avatar styles */
        .profile-avatar-small {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ff4500, #ff6b35);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            overflow: hidden;
            margin-right: 6px;
            vertical-align: middle;
        }

        /* User info */
        .user-info-display {
            color: #d7dadc;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .user-info-display:hover {
            background: #272729;
        }

        /* Media Rendering Styles */
        .post-media {
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #343536;
        }

        .post-image {
            width: 100%;
            max-height: 500px;
            object-fit: cover;
            display: block;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .post-image:hover {
            transform: scale(1.02);
        }

        .post-video {
            width: 100%;
            max-height: 400px;
            background: #000;
        }

        .post-embed {
            width: 100%;
            min-height: 300px;
            border: none;
            border-radius: 8px;
        }

        .youtube-embed {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            overflow: hidden;
            border-radius: 8px;
        }

        .youtube-embed iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .media-link {
            display: block;
            color: #0079d3;
            text-decoration: none;
            padding: 12px;
            background: rgba(0, 121, 211, 0.1);
            border: 1px solid #0079d3;
            border-radius: 8px;
            margin: 12px 0;
            transition: all 0.2s ease;
        }

        .media-link:hover {
            background: rgba(0, 121, 211, 0.2);
            text-decoration: underline;
        }

        .media-link-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .media-link-url {
            font-size: 12px;
            color: #818384;
            word-break: break-all;
        }

        /* Markdown Rendering Styles */
        .markdown-content {
            color: #d7dadc;
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            color: #fff;
            margin: 16px 0 8px 0;
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 1.8em;
            border-bottom: 1px solid #343536;
            padding-bottom: 8px;
        }

        .markdown-content h2 {
            font-size: 1.5em;
        }

        .markdown-content h3 {
            font-size: 1.3em;
        }

        .markdown-content p {
            margin: 12px 0;
        }

        .markdown-content a {
            color: #0079d3;
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content blockquote {
            border-left: 4px solid #ff4500;
            padding-left: 16px;
            margin: 16px 0;
            color: #818384;
            font-style: italic;
        }

        .markdown-content ul,
        .markdown-content ol {
            padding-left: 24px;
            margin: 12px 0;
        }

        .markdown-content li {
            margin: 4px 0;
        }

        .markdown-content code {
            background: #272729;
            color: #ff6b35;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: #1a1a1b;
            border: 1px solid #343536;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .markdown-content pre code {
            background: none;
            color: inherit;
            padding: 0;
            font-size: 0.85em;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            border: 1px solid #343536;
            border-radius: 8px;
            overflow: hidden;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid #343536;
            padding: 8px 12px;
            text-align: left;
        }

        .markdown-content th {
            background: #272729;
            font-weight: 600;
            color: #fff;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #343536;
            margin: 24px 0;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }

        .image-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .image-modal-close:hover {
            color: #ff4500;
        }

        /* Media Upload Styles */
        .media-upload-area {
            border: 2px dashed #343536;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #272729;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .media-upload-area:hover {
            border-color: #ff4500;
            background: rgba(255, 69, 0, 0.1);
        }

        .media-upload-area.dragover {
            border-color: #ff4500;
            background: rgba(255, 69, 0, 0.2);
        }

        .media-preview {
            margin: 12px 0;
            text-align: center;
        }

        .media-preview img,
        .media-preview video {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }

        .media-remove-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
        }

        /* Post Type Toggle */
        .post-type-toggle {
            display: flex;
            background: #272729;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .post-type-btn {
            flex: 1;
            background: transparent;
            color: #818384;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .post-type-btn.active {
            background: #ff4500;
            color: white;
        }

        .post-type-btn:hover:not(.active) {
            background: #343536;
            color: #d7dadc;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="showFeed()">üèòÔ∏è Communities</div>
            <div class="auth-section" id="authSection">
                <!-- Auth buttons will be inserted here -->
            </div>
        </div>
    </header>

    <div class="nav-menu" id="navMenu" style="display: none;">
        <button id="feedBtn" class="active" onclick="showFeed()">Feed</button>
        <button id="communitiesBtn" onclick="showCommunities()">Communities</button>
        <button id="privateBtn" onclick="showPrivateFeed()">Private</button>
        <button id="adminBtn" style="display: none;" onclick="showAdminPanel()">Admin</button>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel" style="display: none;">
        <div class="admin-panel-header">
            <span>üîß Admin Panel</span>
        </div>
        
        <div class="admin-stats" id="adminStats">
            <div class="admin-stat-card">
                <div class="admin-stat-number" id="totalUsers">0</div>
                <div class="admin-stat-label">Total Users</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-number" id="pendingUsers">0</div>
                <div class="admin-stat-label">Pending Users</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-number" id="totalPosts">0</div>
                <div class="admin-stat-label">Total Posts</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-number" id="totalCommunities">0</div>
                <div class="admin-stat-label">Communities</div>
            </div>
        </div>

        <div class="admin-actions">
            <button class="btn btn-admin" onclick="loadPendingUsers()">Pending Users</button>
            <button class="btn btn-admin" onclick="loadAllUsers()">All Users</button>
            <button class="btn btn-admin" onclick="loadAdminCommunities()">Manage Communities</button>
            <button class="btn btn-admin" onclick="refreshAdminStats()">Refresh Stats</button>
        </div>

        <!-- Pending Users Section -->
        <div id="pendingUsersSection" class="admin-section" style="display: none;">
            <h4>Pending User Approvals</h4>
            <div id="pendingUsersList"></div>
        </div>

        <!-- All Users Section -->
        <div id="allUsersSection" class="admin-section" style="display: none;">
            <h4>All Users</h4>
            <div id="allUsersList"></div>
        </div>

        <!-- Communities Management Section -->
        <div id="adminCommunitiesSection" class="admin-section" style="display: none;">
            <h4>Community Management</h4>
            <div id="adminCommunitiesList"></div>
        </div>
    </div>

    <!-- Main Feed -->
    <main id="mainFeed" class="main-feed">
        <div class="feed-container">
            <div id="feed" class="loading">
                Loading...
            </div>
        </div>
    </main>

    <!-- Communities List -->
    <main id="communitiesPage" class="community-page">
        <div class="page-header">
            <div class="page-title">Communities</div>
            <button class="btn btn-community" id="createCommunityBtn" onclick="openModal('createCommunityModal')" style="display: none;">Create Community</button>
        </div>
        <div class="feed-container">
            <div id="communitiesList" class="loading">
                Loading communities...
            </div>
        </div>
    </main>

    <!-- Community Detail Page -->
    <main id="communityPage" class="community-page">
        <div class="page-header">
            <button class="back-btn" onclick="showCommunities()">‚Üê</button>
            <div class="page-title" id="communityPageTitle">Community</div>
        </div>
        <div class="feed-container">
            <div id="communityDetail" class="loading">
                Loading community...
            </div>
            <div id="communityPosts" class="loading">
                Loading posts...
            </div>
        </div>
    </main>

    <button class="compose-btn" id="composeBtn" style="display: none;" onclick="openModal('composeModal')">+</button>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="authTitle">Sign Up</h3>
                <button class="close-btn" onclick="closeModal('authModal')">&times;</button>
            </div>
            <div id="authError"></div>
            <form id="authForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required minlength="3" maxlength="20">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="bio">Bio (Optional)</label>
                    <textarea id="bio" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                </div>
                <button type="submit" class="btn" id="authSubmitBtn">Sign Up</button>
            </form>
            <p style="margin-top: 12px; color: #818384; font-size: 14px;">
                <span id="authToggleText">Already have an account?</span>
                <button type="button" class="btn-secondary" id="authToggleBtn" onclick="toggleAuthMode()">Sign In</button>
            </p>
        </div>
    </div>

    <!-- Create Community Modal -->
    <div class="modal" id="createCommunityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Community</h3>
                <button class="close-btn" onclick="closeModal('createCommunityModal')">&times;</button>
            </div>
            <div id="createCommunityError"></div>
            <form id="createCommunityForm">
                <div class="form-group">
                    <label for="communityName">Community Name</label>
                    <input type="text" id="communityName" required minlength="3" maxlength="25" pattern="[a-z0-9_]+" placeholder="programming">
                    <small>3-25 characters, lowercase, letters, numbers, and underscores only</small>
                </div>
                <div class="form-group">
                    <label for="communityDisplayName">Display Name</label>
                    <input type="text" id="communityDisplayName" required maxlength="50" placeholder="Programming">
                </div>
                <div class="form-group">
                    <label for="communityDescription">Description</label>
                    <textarea id="communityDescription" maxlength="500" placeholder="A community for programming discussions and help"></textarea>
                </div>
                <button type="submit" class="btn btn-community" id="createCommunitySubmitBtn">Create Community</button>
            </form>
        </div>
    </div>

    <!-- Compose Modal -->
    <div class="modal" id="composeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Post</h3>
                <button class="close-btn" onclick="closeModal('composeModal')">&times;</button>
            </div>
            <div id="composeError"></div>
            <form id="composeForm">
                <div class="form-group">
                    <label for="postCommunity">Community (Optional)</label>
                    <select id="postCommunity">
                        <option value="">General Feed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Post Type</label>
                    <div class="post-type-toggle">
                        <button type="button" class="post-type-btn active" onclick="setPostType('text')">Text Post</button>
                        <button type="button" class="post-type-btn" onclick="setPostType('link')">Link/Media</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="postTitle">Title</label>
                    <input type="text" id="postTitle" required maxlength="200">
                </div>

                <!-- Text Post Fields -->
                <div id="textPostFields">
                    <div class="form-group">
                        <label for="postContent">Content</label>
                        <textarea id="postContent" required placeholder="Share your thoughts... (Markdown supported)" maxlength="10000"></textarea>
                        <small>Supports Markdown formatting, including **bold**, *italic*, `code`, links, images, and more!</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Media Upload (Optional)</label>
                        <div class="media-upload-area" id="mediaUpload" onclick="document.getElementById('mediaFile').click()">
                            <input type="file" id="mediaFile" accept="image/*,video/*" style="display: none;" onchange="handleMediaUpload(event)">
                            <div id="mediaUploadText">
                                üìé Click to upload image or video<br>
                                <small>Or drag and drop files here</small>
                            </div>
                        </div>
                        <div id="mediaPreview" class="media-preview" style="display: none;"></div>
                    </div>
                </div>

                <!-- Link Post Fields -->
                <div id="linkPostFields" style="display: none;">
                    <div class="form-group">
                        <label for="postUrl">URL</label>
                        <input type="url" id="postUrl" placeholder="https://example.com">
                        <small>YouTube, images, videos, and other media will be embedded automatically</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="postDescription">Description (Optional)</label>
                        <textarea id="postDescription" placeholder="Describe this link..." maxlength="2000"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <input type="checkbox" id="isPrivate" style="width: auto; margin-right: 8px;">
                    <label for="isPrivate" style="display: inline;">Private post (only you can see this)</label>
                </div>
                <button type="submit" class="btn" id="composeSubmitBtn">Post</button>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>

    <script>
        // App state
        let currentUser = null;
        let currentPage = 'feed'; // 'feed', 'communities', 'community', 'private'
        let communities = [];
        let posts = [];
        let currentCommunity = null;
        let isLoading = false;
        let adminData = null;
        let currentPostType = 'text';
        let uploadedMedia = null;

        // Initialize Markdown renderer with custom settings
        let markdownRenderer;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            // Configure marked.js for markdown rendering
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
            
            // Custom renderer for enhanced features
            markdownRenderer = new marked.Renderer();
            
            // Custom link renderer to handle media embeds
            markdownRenderer.link = function(href, title, text) {
                const mediaHtml = renderMediaFromUrl(href);
                if (mediaHtml) return mediaHtml;
                
                return `<a href="${href}" target="_blank" rel="noopener noreferrer" ${title ? `title="${title}"` : ''}>${text}</a>`;
            };
            
            // Custom image renderer
            markdownRenderer.image = function(href, title, text) {
                return `<img src="${href}" alt="${text}" ${title ? `title="${title}"` : ''} onclick="openImageModal('${href}')" style="cursor: pointer;">`;
            };

            await loadUser();
            await loadCommunities();
            await loadPosts();
            updateUI();
            setupEventListeners();
            
            // Load admin stats if user is admin
            if (currentUser?.profile?.isAdmin) {
                await loadAdminStats();
            }
        });

        function setupEventListeners() {
            // Auth form
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            
            // Create community form
            document.getElementById('createCommunityForm').addEventListener('submit', handleCreateCommunity);
            
            // Compose form
            document.getElementById('composeForm').addEventListener('submit', handleCreatePost);
            
            // Media upload drag and drop
            const mediaUpload = document.getElementById('mediaUpload');
            mediaUpload.addEventListener('dragover', handleDragOver);
            mediaUpload.addEventListener('drop', handleDrop);
            mediaUpload.addEventListener('dragleave', handleDragLeave);
        }

        // Media handling functions
        function setPostType(type) {
            currentPostType = type;
            
            // Update button states
            document.querySelectorAll('.post-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide relevant fields
            const textFields = document.getElementById('textPostFields');
            const linkFields = document.getElementById('linkPostFields');
            
            if (type === 'text') {
                textFields.style.display = 'block';
                linkFields.style.display = 'none';
                document.getElementById('postContent').required = true;
                document.getElementById('postUrl').required = false;
            } else {
                textFields.style.display = 'none';
                linkFields.style.display = 'block';
                document.getElementById('postContent').required = false;
                document.getElementById('postUrl').required = true;
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleMediaFile(files[0]);
            }
        }

        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleMediaFile(file);
            }
        }

        function handleMediaFile(file) {
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                showError('composeError', 'Please select an image or video file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showError('composeError', 'File size must be less than 10MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedMedia = {
                    type: file.type.startsWith('image/') ? 'image' : 'video',
                    data: e.target.result,
                    name: file.name
                };
                showMediaPreview();
            };
            reader.readAsDataURL(file);
        }

        function showMediaPreview() {
            const preview = document.getElementById('mediaPreview');
            const uploadText = document.getElementById('mediaUploadText');
            
            if (uploadedMedia) {
                const mediaElement = uploadedMedia.type === 'image' 
                    ? `<img src="${uploadedMedia.data}" alt="Preview">`
                    : `<video src="${uploadedMedia.data}" controls></video>`;
                
                preview.innerHTML = `
                    ${mediaElement}
                    <br>
                    <button type="button" class="media-remove-btn" onclick="removeMedia()">Remove</button>
                `;
                preview.style.display = 'block';
                uploadText.innerHTML = '‚úì Media uploaded';
            }
        }

        function removeMedia() {
            uploadedMedia = null;
            const preview = document.getElementById('mediaPreview');
            const uploadText = document.getElementById('mediaUploadText');
            
            preview.style.display = 'none';
            uploadText.innerHTML = `
                üìé Click to upload image or video<br>
                <small>Or drag and drop files here</small>
            `;
            document.getElementById('mediaFile').value = '';
        }

        // Media rendering functions
        function renderMediaFromUrl(url) {
            if (!url) return null;

            // YouTube video
            const youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
            if (youtubeMatch) {
                const videoId = youtubeMatch[1];
                return `
                    <div class="youtube-embed">
                        <iframe src="https://www.youtube.com/embed/${videoId}" 
                                allowfullscreen></iframe>
                    </div>
                `;
            }

            // Vimeo video
            const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch) {
                const videoId = vimeoMatch[1];
                return `
                    <div class="youtube-embed">
                        <iframe src="https://player.vimeo.com/video/${videoId}" 
                                allowfullscreen></iframe>
                    </div>
                `;
            }

            // Direct image links
            if (url.match(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)) {
                return `<img src="${url}" class="post-image" onclick="openImageModal('${url}')" alt="Image">`;
            }

            // Direct video links
            if (url.match(/\.(mp4|webm|ogg|mov)(\?.*)?$/i)) {
                return `<video src="${url}" class="post-video" controls></video>`;
            }

            // Twitter/X posts
            const twitterMatch = url.match(/(?:twitter\.com|x\.com)\/\w+\/status\/(\d+)/);
            if (twitterMatch) {
                return `
                    <div class="media-link">
                        <div class="media-link-title">üê¶ Twitter/X Post</div>
                        <div class="media-link-url">${url}</div>
                    </div>
                `;
            }

            // Generic link with preview
            return null; // Let default link rendering handle it
        }

        function renderPostContent(post) {
            let contentHtml = '';

            // Handle different post types
            if (post.type === 'link' && post.url) {
                const mediaHtml = renderMediaFromUrl(post.url);
                if (mediaHtml) {
                    contentHtml += `<div class="post-media">${mediaHtml}</div>`;
                } else {
                    contentHtml += `
                        <a href="${post.url}" target="_blank" rel="noopener noreferrer" class="media-link">
                            <div class="media-link-title">üîó ${post.url}</div>
                            <div class="media-link-url">${post.url}</div>
                        </a>
                    `;
                }
                
                if (post.description) {
                    contentHtml += `<div class="markdown-content">${renderMarkdown(post.description)}</div>`;
                }
            } else if (post.content) {
                contentHtml += `<div class="markdown-content">${renderMarkdown(post.content)}</div>`;
            }

            // Handle embedded media from text posts
            if (post.media) {
                if (post.media.type === 'image') {
                    contentHtml += `
                        <div class="post-media">
                            <img src="${post.media.data}" class="post-image" onclick="openImageModal('${post.media.data}')" alt="Uploaded image">
                        </div>
                    `;
                } else if (post.media.type === 'video') {
                    contentHtml += `
                        <div class="post-media">
                            <video src="${post.media.data}" class="post-video" controls></video>
                        </div>
                    `;
                }
            }

            return contentHtml;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            
            try {
                // Render markdown with custom renderer
                const html = marked.parse(text, { renderer: markdownRenderer });
                
                // Sanitize the HTML to prevent XSS attacks
                return DOMPurify.sanitize(html);
            } catch (error) {
                console.error('Markdown rendering error:', error);
                return escapeHtml(text);
            }
        }

        // Image modal functions
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = src;
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Netlify Blobs API implementation
        const blobAPI = {
            async get(key) {
                try {
                    const response = await fetch(`/.netlify/functions/blobs?key=${encodeURIComponent(key)}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) return null;
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    return result.data;
                } catch (error) {
                    console.error('Error getting blob:', error);
                    return null;
                }
            },
            
            async set(key, value) {
                try {
                    const response = await fetch('/.netlify/functions/blobs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key, value })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error setting blob:', error);
                    throw error;
                }
            },
            
            async list(prefix = '') {
                try {
                    const response = await fetch(`/.netlify/functions/blobs?list=true&prefix=${encodeURIComponent(prefix)}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    return result.keys || [];
                } catch (error) {
                    console.error('Error listing blobs:', error);
                    return [];
                }
            },
            
            async delete(key) {
                try {
                    const response = await fetch('/.netlify/functions/blobs', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error deleting blob:', error);
                    throw error;
                }
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUser();
            await loadCommunities();
            await loadPosts();
            updateUI();
            setupEventListeners();
            
            // Load admin stats if user is admin
            if (currentUser?.profile?.isAdmin) {
                await loadAdminStats();
            }
        });

        function setupEventListeners() {
            // Auth form
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            
            // Create community form
            document.getElementById('createCommunityForm').addEventListener('submit', handleCreateCommunity);
            
            // Compose form
            document.getElementById('composeForm').addEventListener('submit', handleCreatePost);
        }

        async function loadUser() {
            try {
                const userData = await blobAPI.get('current_user');
                if (userData) {
                    currentUser = userData;
                    const fullProfile = await blobAPI.get(`user_${userData.username}`);
                    if (fullProfile) {
                        currentUser.profile = fullProfile;
                    }
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        async function loadCommunities() {
            try {
                const communityKeys = await blobAPI.list('community_');
                const communityPromises = communityKeys.map(async (key) => {
                    try {
                        return await blobAPI.get(key);
                    } catch (error) {
                        console.error(`Error loading community ${key}:`, error);
                        return null;
                    }
                });
                
                const loadedCommunities = await Promise.all(communityPromises);
                communities = loadedCommunities
                    .filter(Boolean)
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Update community dropdown in compose modal
                updateCommunityDropdown();
                
            } catch (error) {
                console.error('Error loading communities:', error);
                communities = [];
            }
        }

        async function loadPosts() {
            try {
                if (!isLoading) {
                    isLoading = true;
                    updateFeedContent('<div class="loading">Loading...</div>');
                }
                
                const postKeys = await blobAPI.list('post_');
                const postPromises = postKeys.map(async (key) => {
                    try {
                        return await blobAPI.get(key);
                    } catch (error) {
                        console.error(`Error loading post ${key}:`, error);
                        return null;
                    }
                });
                
                const loadedPosts = await Promise.all(postPromises);
                posts = loadedPosts
                    .filter(Boolean)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
            } catch (error) {
                console.error('Error loading posts:', error);
                posts = [];
            } finally {
                isLoading = false;
            }
        }

        // Admin Functions
        async function loadAdminStats() {
            try {
                const userKeys = await blobAPI.list('user_');
                const pendingUserKeys = await blobAPI.list('pending_user_');
                const postKeys = await blobAPI.list('post_');
                const communityKeys = await blobAPI.list('community_');

                document.getElementById('totalUsers').textContent = userKeys.length;
                document.getElementById('pendingUsers').textContent = pendingUserKeys.length;
                document.getElementById('totalPosts').textContent = postKeys.length;
                document.getElementById('totalCommunities').textContent = communityKeys.length;
            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        async function loadPendingUsers() {
            try {
                const pendingUserKeys = await blobAPI.list('pending_user_');
                const pendingPromises = pendingUserKeys.map(key => blobAPI.get(key));
                const pendingUsers = (await Promise.all(pendingPromises)).filter(Boolean);

                const container = document.getElementById('pendingUsersList');
                const section = document.getElementById('pendingUsersSection');

                if (pendingUsers.length === 0) {
                    container.innerHTML = '<p style="color: #818384;">No pending users</p>';
                } else {
                    container.innerHTML = pendingUsers.map(user => `
                        <div class="user-card pending">
                            <div class="user-card-header">
                                <div>
                                    <strong>${escapeHtml(user.username)}</strong>
                                    <div class="user-info">${escapeHtml(user.bio || 'No bio provided')}</div>
                                    <div class="user-info" style="font-size: 12px; color: #818384;">
                                        Registered: ${formatDate(user.createdAt)}
                                    </div>
                                </div>
                                <div class="user-actions">
                                    <button class="btn btn-approve btn-small" onclick="approveUser('${user.username}')">
                                        Approve
                                    </button>
                                    <button class="btn btn-reject btn-small" onclick="rejectUser('${user.username}')">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                section.style.display = 'block';
                document.getElementById('allUsersSection').style.display = 'none';
                document.getElementById('adminCommunitiesSection').style.display = 'none';
            } catch (error) {
                console.error('Error loading pending users:', error);
            }
        }

        async function loadAllUsers() {
            try {
                const userKeys = await blobAPI.list('user_');
                const userPromises = userKeys.map(key => blobAPI.get(key));
                const users = (await Promise.all(userPromises)).filter(Boolean);

                const container = document.getElementById('allUsersList');
                const section = document.getElementById('allUsersSection');

                if (users.length === 0) {
                    container.innerHTML = '<p style="color: #818384;">No users found</p>';
                } else {
                    container.innerHTML = users.map(user => {
                        const userPosts = posts.filter(p => p.author === user.username).length;
                        return `
                            <div class="user-card">
                                <div class="user-card-header">
                                    <div>
                                        <strong>${escapeHtml(user.username)}</strong>
                                        ${user.isAdmin ? '<span class="admin-badge">Admin</span>' : ''}
                                        <div class="user-info">${escapeHtml(user.bio || 'No bio provided')}</div>
                                        <div class="user-info" style="font-size: 12px; color: #818384;">
                                            Posts: ${userPosts} | Joined: ${formatDate(user.createdAt)}
                                        </div>
                                    </div>
                                    <div class="user-actions">
                                        ${!user.isAdmin && user.username !== currentUser?.username ? `
                                            <button class="btn btn-delete btn-small" onclick="deleteUser('${user.username}')">
                                                Delete
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                section.style.display = 'block';
                document.getElementById('pendingUsersSection').style.display = 'none';
                document.getElementById('adminCommunitiesSection').style.display = 'none';
            } catch (error) {
                console.error('Error loading all users:', error);
            }
        }

        async function loadAdminCommunities() {
            try {
                const container = document.getElementById('adminCommunitiesList');
                const section = document.getElementById('adminCommunitiesSection');

                if (communities.length === 0) {
                    container.innerHTML = '<p style="color: #818384;">No communities found</p>';
                } else {
                    container.innerHTML = communities.map(community => {
                        const communityPosts = posts.filter(p => p.communityName === community.name).length;
                        return `
                            <div class="user-card">
                                <div class="user-card-header">
                                    <div>
                                        <strong>${escapeHtml(community.displayName)}</strong>
                                        <div class="user-info">c/${escapeHtml(community.name)}</div>
                                        <div class="user-info">${escapeHtml(community.description || 'No description')}</div>
                                        <div class="user-info" style="font-size: 12px; color: #818384;">
                                            Posts: ${communityPosts} | Members: ${community.members?.length || 0} | 
                                            Created by: ${escapeHtml(community.createdBy)} | ${formatDate(community.createdAt)}
                                        </div>
                                    </div>
                                    <div class="user-actions">
                                        <button class="btn btn-delete btn-small" onclick="deleteCommunity('${community.name}')">
                                            Delete Community
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                section.style.display = 'block';
                document.getElementById('pendingUsersSection').style.display = 'none';
                document.getElementById('allUsersSection').style.display = 'none';
            } catch (error) {
                console.error('Error loading admin communities:', error);
            }
        }

        async function approveUser(username) {
            if (!confirm(`Approve user "${username}"?`)) return;

            try {
                const pendingUser = await blobAPI.get(`pending_user_${username}`);
                if (!pendingUser) {
                    showError('general', 'Pending user not found');
                    return;
                }

                // Create approved user
                const approvedUser = {
                    username: pendingUser.username,
                    password: pendingUser.password,
                    bio: pendingUser.bio,
                    createdAt: pendingUser.createdAt,
                    approvedAt: new Date().toISOString(),
                    isAdmin: false
                };

                await blobAPI.set(`user_${username}`, approvedUser);
                await blobAPI.delete(`pending_user_${username}`);

                showSuccessMessage(`User "${username}" approved successfully!`);
                await loadAdminStats();
                await loadPendingUsers();
            } catch (error) {
                console.error('Error approving user:', error);
                showError('general', 'Failed to approve user');
            }
        }

        async function rejectUser(username) {
            if (!confirm(`Reject and delete user "${username}"? This cannot be undone.`)) return;

            try {
                await blobAPI.delete(`pending_user_${username}`);
                showSuccessMessage(`User "${username}" rejected and removed.`);
                await loadAdminStats();
                await loadPendingUsers();
            } catch (error) {
                console.error('Error rejecting user:', error);
                showError('general', 'Failed to reject user');
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Delete user "${username}" and all their posts? This cannot be undone.`)) return;

            try {
                // Delete user
                await blobAPI.delete(`user_${username}`);

                // Delete user's posts
                const userPostKeys = posts.filter(p => p.author === username).map(p => p.id);
                for (const postId of userPostKeys) {
                    await blobAPI.delete(postId);
                }

                // Update local data
                posts = posts.filter(p => p.author !== username);

                showSuccessMessage(`User "${username}" and all their posts deleted.`);
                await loadAdminStats();
                await loadAllUsers();
                updateUI();
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('general', 'Failed to delete user');
            }
        }

        async function deleteCommunity(communityName) {
            if (!confirm(`Delete community "${communityName}" and all its posts? This cannot be undone.`)) return;

            try {
                // Delete community
                await blobAPI.delete(`community_${communityName}`);

                // Delete community posts
                const communityPostKeys = posts.filter(p => p.communityName === communityName).map(p => p.id);
                for (const postId of communityPostKeys) {
                    await blobAPI.delete(postId);
                }

                // Update local data
                communities = communities.filter(c => c.name !== communityName);
                posts = posts.filter(p => p.communityName !== communityName);

                showSuccessMessage(`Community "${communityName}" and all its posts deleted.`);
                await loadAdminStats();
                await loadAdminCommunities();
                updateCommunityDropdown();
                updateUI();
            } catch (error) {
                console.error('Error deleting community:', error);
                showError('general', 'Failed to delete community');
            }
        }

        function refreshAdminStats() {
            loadAdminStats();
            showSuccessMessage('Admin stats refreshed!');
        }

        function showAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            const isVisible = adminPanel.style.display !== 'none';
            adminPanel.style.display = isVisible ? 'none' : 'block';

            // Hide admin sections when toggling panel
            if (isVisible) {
                document.getElementById('pendingUsersSection').style.display = 'none';
                document.getElementById('allUsersSection').style.display = 'none';
                document.getElementById('adminCommunitiesSection').style.display = 'none';
            }
        }

        function updateUI() {
            updateAuthSection();
            updateNavMenu();
            updateComposeButton();
            
            if (currentPage === 'feed') {
                renderFeed();
            } else if (currentPage === 'communities') {
                renderCommunities();
            } else if (currentPage === 'community') {
                renderCommunityPage();
            } else if (currentPage === 'private') {
                renderPrivateFeed();
            }
        }

        function updateAuthSection() {
            const authSection = document.getElementById('authSection');
            
            if (currentUser) {
                authSection.innerHTML = `
                    <span class="user-info-display">
                        <div class="profile-avatar-small">${currentUser.username.charAt(0).toUpperCase()}</div>
                        @${escapeHtml(currentUser.username)}
                        ${currentUser.profile?.isAdmin ? '<span class="admin-badge">Admin</span>' : ''}
                    </span>
                    ${currentUser.profile?.isAdmin ? '<button class="btn btn-admin" onclick="showAdminPanel()">Admin</button>' : ''}
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                `;
            } else {
                authSection.innerHTML = `
                    <button class="btn btn-secondary" onclick="openAuthModal('signin')">Sign In</button>
                    <button class="btn" onclick="openAuthModal('signup')">Sign Up</button>
                `;
            }
        }

        function updateNavMenu() {
            const navMenu = document.getElementById('navMenu');
            const adminBtn = document.getElementById('adminBtn');
            
            navMenu.style.display = currentUser ? 'flex' : 'none';
            adminBtn.style.display = (currentUser?.profile?.isAdmin) ? 'block' : 'none';
            
            // Update active button
            document.querySelectorAll('.nav-menu button').forEach(btn => btn.classList.remove('active'));
            if (currentPage === 'feed') {
                document.getElementById('feedBtn').classList.add('active');
            } else if (currentPage === 'communities' || currentPage === 'community') {
                document.getElementById('communitiesBtn').classList.add('active');
            } else if (currentPage === 'private') {
                document.getElementById('privateBtn').classList.add('active');
            }
        }

        function updateComposeButton() {
            const composeBtn = document.getElementById('composeBtn');
            composeBtn.style.display = currentUser ? 'block' : 'none';
            
            // Change button style based on current page
            if (currentPage === 'community') {
                composeBtn.classList.add('community');
            } else {
                composeBtn.classList.remove('community');
            }
        }

        function updateCommunityDropdown() {
            const select = document.getElementById('postCommunity');
            select.innerHTML = '<option value="">General Feed</option>';
            
            communities.forEach(community => {
                const option = document.createElement('option');
                option.value = community.name;
                option.textContent = community.displayName;
                select.appendChild(option);
            });
        }

        // Page navigation functions
        function showFeed() {
            currentPage = 'feed';
            hideAllPages();
            document.getElementById('mainFeed').style.display = 'block';
            updateUI();
        }

        function showCommunities() {
            currentPage = 'communities';
            hideAllPages();
            document.getElementById('communitiesPage').style.display = 'block';
            updateUI();
        }

        function showCommunity(communityName) {
            currentPage = 'community';
            currentCommunity = communityName;
            hideAllPages();
            document.getElementById('communityPage').style.display = 'block';
            document.getElementById('communityPageTitle').textContent = communities.find(c => c.name === communityName)?.displayName || communityName;
            updateUI();
            
            // Pre-select community in compose modal
            document.getElementById('postCommunity').value = communityName;
        }

        function showPrivateFeed() {
            currentPage = 'private';
            hideAllPages();
            document.getElementById('mainFeed').style.display = 'block';
            updateUI();
        }

        function hideAllPages() {
            document.getElementById('mainFeed').style.display = 'none';
            document.getElementById('communitiesPage').style.display = 'none';
            document.getElementById('communityPage').style.display = 'none';
        }

        // Feed rendering functions
        function renderFeed() {
            const filteredPosts = posts.filter(post => !post.isPrivate);
            updateFeedContent(renderPostList(filteredPosts, 'No public posts yet!'));
        }

        function renderPrivateFeed() {
            const filteredPosts = posts.filter(post => post.isPrivate && post.author === currentUser?.username);
            updateFeedContent(renderPostList(filteredPosts, 'No private posts yet!'));
        }

        function renderCommunities() {
            const communitiesList = document.getElementById('communitiesList');
            const createBtn = document.getElementById('createCommunityBtn');
            
            createBtn.style.display = currentUser ? 'block' : 'none';
            
            if (communities.length === 0) {
                communitiesList.innerHTML = `
                    <div class="empty-state">
                        <p>No communities yet!</p>
                        ${currentUser ? '<p>Be the first to create one.</p>' : '<p>Sign in to create communities.</p>'}
                    </div>
                `;
                return;
            }

            const communitiesHTML = communities.map(community => {
                const postCount = posts.filter(post => post.communityName === community.name && !post.isPrivate).length;
                
                return `
                    <div class="community-card" onclick="showCommunity('${community.name}')">
                        <div class="community-header">
                            <div class="community-info">
                                <h3>${escapeHtml(community.displayName)}</h3>
                                <div class="community-name">c/${escapeHtml(community.name)}</div>
                                ${community.description ? `<div class="community-description">${escapeHtml(community.description)}</div>` : ''}
                            </div>
                            ${community.isPrivate ? '<div class="community-badge">Private</div>' : ''}
                        </div>
                        <div class="community-stats">
                            <span>${postCount} posts</span>
                            <span>${community.members?.length || 1} members</span>
                            <span>Created ${formatDate(community.createdAt)}</span>
                        </div>
                    </div>
                `;
            }).join('');

            communitiesList.innerHTML = communitiesHTML;
        }

        function renderCommunityPage() {
            if (!currentCommunity) return;
            
            const community = communities.find(c => c.name === currentCommunity);
            if (!community) return;

            const communityDetail = document.getElementById('communityDetail');
            const postCount = posts.filter(post => post.communityName === community.name && !post.isPrivate).length;
            
            communityDetail.innerHTML = `
                <div class="community-detail-header">
                    <h1>${escapeHtml(community.displayName)}</h1>
                    <div class="community-name">c/${escapeHtml(community.name)}</div>
                    ${community.description ? `<div class="description">${escapeHtml(community.description)}</div>` : ''}
                    <div class="community-detail-stats">
                        <span>${postCount} posts</span>
                        <span>${community.members?.length || 1} members</span>
                        <span>Created by @${escapeHtml(community.createdBy)}</span>
                        <span>${formatDate(community.createdAt)}</span>
                    </div>
                </div>
            `;

            const communityPosts = posts.filter(post => post.communityName === community.name && !post.isPrivate);
            document.getElementById('communityPosts').innerHTML = renderPostList(communityPosts, 'No posts in this community yet!');
        }

        function renderPostList(postList, emptyMessage) {
            if (postList.length === 0) {
                return `<div class="empty-state"><p>${emptyMessage}</p></div>`;
            }

            return postList.map(post => {
                const community = communities.find(c => c.name === post.communityName);
                
                return `
                    <div class="post-card ${post.isPrivate ? 'private' : ''}">
                        <div class="post-header">
                            <span class="username">
                                <div class="profile-avatar-small">${post.author.charAt(0).toUpperCase()}</div>
                                @${escapeHtml(post.author)}
                            </span>
                            ${post.isPrivate ? '<span class="private-badge">Private</span>' : ''}
                            ${post.type === 'link' ? '<span class="private-badge" style="background: #0079d3;">Link</span>' : ''}
                            <span class="timestamp">${formatTimestamp(post.timestamp)}</span>
                        </div>
                        
                        <div class="post-body">
                            ${post.communityName && community ? `
                                <div class="post-community">
                                    <a href="#" class="post-community-link" onclick="showCommunity('${post.communityName}'); return false;">
                                        c/${escapeHtml(community.displayName)}
                                    </a>
                                </div>
                            ` : ''}
                            <h3 class="post-title">${escapeHtml(post.title)}</h3>
                            ${renderPostContent(post)}
                        </div>
                        
                        <div class="post-actions">
                            <button class="action-btn">
                                <span>‚¨ÜÔ∏è</span>
                                <span>Vote</span>
                            </button>
                            <button class="action-btn">
                                <span>üí¨</span>
                                <span>${post.replies ? post.replies.length : 0}</span>
                            </button>
                            ${currentUser && (currentUser.username === post.author || currentUser.profile?.isAdmin) ? `
                                <button class="action-btn" onclick="deletePost('${post.id}')">
                                    <span>üóëÔ∏è</span>
                                    <span>Delete</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateFeedContent(html) {
            document.getElementById('feed').innerHTML = html;
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openAuthModal(mode) {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const toggleText = document.getElementById('authToggleText');
            const toggleBtn = document.getElementById('authToggleBtn');
            const submitBtn = document.getElementById('authSubmitBtn');
            const form = document.getElementById('authForm');
            
            document.getElementById('authError').innerHTML = '';
            
            if (mode === 'signup') {
                title.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleBtn.textContent = 'Sign In';
                submitBtn.textContent = 'Sign Up';
                form.dataset.mode = 'signup';
            } else {
                title.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                toggleBtn.textContent = 'Sign Up';
                submitBtn.textContent = 'Sign In';
                form.dataset.mode = 'signin';
            }
            
            modal.style.display = 'block';
        }

        function toggleAuthMode() {
            const form = document.getElementById('authForm');
            const currentMode = form.dataset.mode;
            openAuthModal(currentMode === 'signup' ? 'signin' : 'signup');
        }

        // Auth functions
        async function handleAuth(e) {
            e.preventDefault();
            const form = e.target;
            const mode = form.dataset.mode;
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const bio = document.getElementById('bio').value.trim();
            const errorDiv = document.getElementById('authError');
            const submitBtn = document.getElementById('authSubmitBtn');

            errorDiv.innerHTML = '';
            
            if (username.length < 3) {
                showError('authError', 'Username must be at least 3 characters long');
                return;
            }
            
            if (password.length < 6) {
                showError('authError', 'Password must be at least 6 characters long');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Loading...';

                if (mode === 'signup') {
                    const existingUser = await blobAPI.get(`user_${username}`);
                    const pendingUser = await blobAPI.get(`pending_user_${username}`);
                    
                    if (existingUser || pendingUser) {
                        showError('authError', 'Username already exists or is pending approval!');
                        return;
                    }
                    
                    const newPendingUser = { 
                        username, 
                        password,
                        bio: bio || `Hello! I'm ${username}`,
                        createdAt: new Date().toISOString(),
                        status: 'pending',
                        isAdmin: false
                    };
                    
                    await blobAPI.set(`pending_user_${username}`, newPendingUser);
                    
                    closeModal('authModal');
                    showSuccessMessage('Account created! Waiting for admin approval.');
                    
                } else {
                    const user = await blobAPI.get(`user_${username}`);
                    
                    if (!user) {
                        const pendingUser = await blobAPI.get(`pending_user_${username}`);
                        if (pendingUser) {
                            showError('authError', 'Your account is still pending admin approval.');
                        } else {
                            showError('authError', 'Invalid username or password');
                        }
                        return;
                    }
                    
                    if (user.password !== password) {
                        showError('authError', 'Invalid username or password');
                        return;
                    }
                    
                    currentUser = { username, profile: user };
                    await blobAPI.set('current_user', currentUser);
                    
                    closeModal('authModal');
                    updateUI();
                    showSuccessMessage('Welcome back!');

                    // Load admin stats if user is admin
                    if (user.isAdmin) {
                        await loadAdminStats();
                    }
                }
                
                form.reset();
                
            } catch (error) {
                console.error('Auth error:', error);
                showError('authError', 'Something went wrong. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = mode === 'signup' ? 'Sign Up' : 'Sign In';
            }
        }

        async function logout() {
            try {
                currentUser = null;
                await blobAPI.delete('current_user');
                
                // Hide admin panel
                document.getElementById('adminPanel').style.display = 'none';
                
                showFeed();
                updateUI();
                showSuccessMessage('Logged out successfully!');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Community functions
        async function handleCreateCommunity(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showError('createCommunityError', 'Please sign in to create a community');
                return;
            }
            
            const name = document.getElementById('communityName').value.trim().toLowerCase();
            const displayName = document.getElementById('communityDisplayName').value.trim();
            const description = document.getElementById('communityDescription').value.trim();
            const submitBtn = document.getElementById('createCommunitySubmitBtn');
            const errorDiv = document.getElementById('createCommunityError');
            
            errorDiv.innerHTML = '';
            
            // Validation
            if (!/^[a-z0-9_]{3,25}$/.test(name)) {
                showError('createCommunityError', 'Community name must be 3-25 characters, lowercase, alphanumeric and underscores only');
                return;
            }

            if (!displayName || displayName.length > 50) {
                showError('createCommunityError', 'Display name is required and must be 50 characters or less');
                return;
            }

            if (description.length > 500) {
                showError('createCommunityError', 'Description must be 500 characters or less');
                return;
            }

            // Check if community already exists
            const existingCommunity = await blobAPI.get(`community_${name}`);
            if (existingCommunity) {
                showError('createCommunityError', 'Community name already exists');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating...';
                
                const community = {
                    name,
                    displayName,
                    description,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString(),
                    isPrivate: false,
                    moderators: [currentUser.username],
                    members: [currentUser.username],
                    rules: []
                };
                
                await blobAPI.set(`community_${name}`, community);
                communities.unshift(community);
                
                closeModal('createCommunityModal');
                document.getElementById('createCommunityForm').reset();
                
                updateCommunityDropdown();
                renderCommunities();
                
                // Update admin stats if user is admin
                if (currentUser.profile?.isAdmin) {
                    await loadAdminStats();
                }
                
                showSuccessMessage(`Community "${displayName}" created successfully!`);
                
            } catch (error) {
                console.error('Error creating community:', error);
                showError('createCommunityError', 'Failed to create community. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Community';
            }
        }

        // Post functions
        async function handleCreatePost(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showError('composeError', 'Please sign in to create a post');
                return;
            }
            
            const title = document.getElementById('postTitle').value.trim();
            const communityName = document.getElementById('postCommunity').value;
            const isPrivate = document.getElementById('isPrivate').checked;
            const submitBtn = document.getElementById('composeSubmitBtn');
            const errorDiv = document.getElementById('composeError');
            
            let content = '';
            let url = '';
            let description = '';
            
            if (currentPostType === 'text') {
                content = document.getElementById('postContent').value.trim();
                if (!content && !uploadedMedia) {
                    showError('composeError', 'Please provide content or upload media');
                    return;
                }
            } else {
                url = document.getElementById('postUrl').value.trim();
                description = document.getElementById('postDescription').value.trim();
                if (!url) {
                    showError('composeError', 'Please provide a URL');
                    return;
                }
                
                try {
                    new URL(url);
                } catch {
                    showError('composeError', 'Please provide a valid URL');
                    return;
                }
            }
            
            errorDiv.innerHTML = '';
            
            if (!title) {
                showError('composeError', 'Please provide a title');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Posting...';
                
                const post = {
                    id: `post_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: currentPostType,
                    title,
                    author: currentUser.username,
                    timestamp: new Date().toISOString(),
                    isPrivate,
                    communityName: communityName || null,
                    replies: []
                };

                if (currentPostType === 'text') {
                    if (content) post.content = content;
                    if (uploadedMedia) post.media = uploadedMedia;
                } else {
                    post.url = url;
                    if (description) post.description = description;
                }
                
                await blobAPI.set(post.id, post);
                posts.unshift(post);
                
                closeModal('composeModal');
                document.getElementById('composeForm').reset();
                
                // Reset post type and media
                currentPostType = 'text';
                uploadedMedia = null;
                setPostType('text');
                removeMedia();
                
                updateUI();
                
                // Update admin stats if user is admin
                if (currentUser.profile?.isAdmin) {
                    await loadAdminStats();
                }
                
                showSuccessMessage('Post created successfully!');
                
            } catch (error) {
                console.error('Error creating post:', error);
                showError('composeError', 'Failed to create post. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Post';
            }
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }
            
            try {
                await blobAPI.delete(postId);
                posts = posts.filter(p => p.id !== postId);
                updateUI();
                
                // Update admin stats if user is admin
                if (currentUser.profile?.isAdmin) {
                    await loadAdminStats();
                }
                
                showSuccessMessage('Post deleted successfully!');
            } catch (error) {
                console.error('Error deleting post:', error);
                showError('general', 'Failed to delete post. Please try again.');
            }
        }

        // Utility functions
        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '80px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd';
            return date.toLocaleDateString();
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short' 
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Initialize app - moved to after all function definitions
        document.addEventListener('DOMContentLoaded', async () => {
            // Configure marked.js for markdown rendering
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
            
            // Custom renderer for enhanced features
            markdownRenderer = new marked.Renderer();
            
            // Custom link renderer to handle media embeds
            markdownRenderer.link = function(href, title, text) {
                const mediaHtml = renderMediaFromUrl(href);
                if (mediaHtml) return mediaHtml;
                
                return `<a href="${href}" target="_blank" rel="noopener noreferrer" ${title ? `title="${title}"` : ''}>${text}</a>`;
            };
            
            // Custom image renderer
            markdownRenderer.image = function(href, title, text) {
                return `<img src="${href}" alt="${text}" ${title ? `title="${title}"` : ''} onclick="openImageModal('${href}')" style="cursor: pointer;">`;
            };

            await loadUser();
            await loadCommunities();
            await loadPosts();
            updateUI();
            setupEventListeners();
            
            // Load admin stats if user is admin
            if (currentUser?.profile?.isAdmin) {
                await loadAdminStats();
            }
        });
    </script>
</body>
</html>
