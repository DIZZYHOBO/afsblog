<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèòÔ∏è</text></svg>">
    <title>Blog Feed - Communities</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.4;
        }

        .header {
            background-color: #1a1a1b;
            padding: 12px 16px;
            border-bottom: 1px solid #343536;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #ff4500;
            cursor: pointer;
        }

        .auth-section {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: #0079d3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #1484d6;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #0079d3;
            color: #0079d3;
        }

        .btn-secondary:hover {
            background: #0079d3;
            color: white;
        }

        .btn-community {
            background: #ff4500;
            color: white;
        }

        .btn-community:hover {
            background: #ff6b35;
        }

        .nav-menu {
            display: flex;
            background: #1a1a1b;
            margin: 12px 0;
            border-radius: 20px;
            overflow: hidden;
        }

        .nav-menu button {
            flex: 1;
            background: transparent;
            color: #818384;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-menu button.active {
            background: #272729;
            color: #fff;
        }

        /* Community specific styles */
        .community-card {
            background: #1a1a1b;
            margin: 8px 0;
            border-radius: 12px;
            border: 1px solid #343536;
            padding: 16px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .community-card:hover {
            border-color: #ff4500;
        }

        .community-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .community-info h3 {
            color: #ff4500;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .community-name {
            color: #818384;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .community-description {
            color: #d7dadc;
            font-size: 14px;
            line-height: 1.4;
        }

        .community-stats {
            display: flex;
            gap: 16px;
            color: #818384;
            font-size: 12px;
        }

        .community-badge {
            background: #ff4500;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .post-community {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .post-community-link {
            color: #ff4500;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(255, 69, 0, 0.1);
        }

        .post-community-link:hover {
            background: rgba(255, 69, 0, 0.2);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
        }

        .modal-content {
            background: #1a1a1b;
            margin: 20px;
            margin-top: 60px;
            border-radius: 8px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #343536;
        }

        .close-btn {
            background: none;
            border: none;
            color: #818384;
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #d7dadc;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            background: #272729;
            border: 1px solid #343536;
            border-radius: 4px;
            padding: 12px;
            color: #d7dadc;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group small {
            color: #818384;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        /* Feed container styles */
        .feed-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 16px;
        }

        @media (min-width: 769px) {
            .feed-container {
                max-width: 500px;
                padding: 0 20px;
            }
        }

        @media (min-width: 1200px) {
            .feed-container {
                max-width: 550px;
                padding: 0 40px;
            }
        }

        .post-card {
            background: #1a1a1b;
            margin: 8px 0;
            border-radius: 12px;
            border: 1px solid #343536;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .post-card.private {
            border-left: 4px solid #ff4500;
        }

        .post-header {
            background: #272729;
            padding: 12px 16px;
            border-bottom: 1px solid #343536;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .post-header .username {
            color: #0079d3;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .post-header .username:hover {
            text-decoration: underline;
        }

        .post-header .timestamp {
            color: #818384;
            font-size: 12px;
            margin-left: auto;
        }

        .private-badge {
            background: #ff4500;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .post-body {
            padding: 16px;
        }

        .post-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 12px;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .post-content {
            color: #d7dadc;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .post-actions {
            background: #272729;
            border-top: 1px solid #343536;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: #818384;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            flex: 1;
            transition: all 0.2s ease;
            min-width: 0;
            position: relative;
        }

        .action-btn:hover {
            background: #343536;
            color: #fff;
        }

        .action-btn:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 20px;
            width: 1px;
            background: #343536;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #818384;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #818384;
        }

        .error-message {
            background: #b91c1c;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .success-message {
            background: #059669;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        /* Page specific styles */
        .page-header {
            background: #1a1a1b;
            padding: 12px 16px;
            border-bottom: 1px solid #343536;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .back-btn {
            background: none;
            border: none;
            color: #818384;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .back-btn:hover {
            background: #272729;
            color: #fff;
        }

        .page-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .community-page {
            display: none;
        }

        .community-detail-header {
            background: #1a1a1b;
            padding: 20px;
            border: 1px solid #343536;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .community-detail-header h1 {
            color: #ff4500;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .community-detail-header .description {
            color: #d7dadc;
            margin-bottom: 12px;
        }

        .community-detail-stats {
            display: flex;
            gap: 20px;
            color: #818384;
            font-size: 14px;
        }

        /* Compose button */
        .compose-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #ff4500;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 50;
        }

        .compose-btn.community {
            background: #0079d3;
        }

        /* Profile avatar styles */
        .profile-avatar-small {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ff4500, #ff6b35);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            overflow: hidden;
            margin-right: 6px;
            vertical-align: middle;
        }

        /* User info */
        .user-info {
            color: #d7dadc;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .user-info:hover {
            background: #272729;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="showFeed()">üèòÔ∏è Communities</div>
            <div class="auth-section" id="authSection">
                <!-- Auth buttons will be inserted here -->
            </div>
        </div>
    </header>

    <div class="nav-menu" id="navMenu" style="display: none;">
        <button id="feedBtn" class="active" onclick="showFeed()">Feed</button>
        <button id="communitiesBtn" onclick="showCommunities()">Communities</button>
        <button id="privateBtn" onclick="showPrivateFeed()">Private</button>
    </div>

    <!-- Main Feed -->
    <main id="mainFeed" class="main-feed">
        <div class="feed-container">
            <div id="feed" class="loading">
                Loading...
            </div>
        </div>
    </main>

    <!-- Communities List -->
    <main id="communitiesPage" class="community-page">
        <div class="page-header">
            <div class="page-title">Communities</div>
            <button class="btn btn-community" id="createCommunityBtn" onclick="openModal('createCommunityModal')" style="display: none;">Create Community</button>
        </div>
        <div class="feed-container">
            <div id="communitiesList" class="loading">
                Loading communities...
            </div>
        </div>
    </main>

    <!-- Community Detail Page -->
    <main id="communityPage" class="community-page">
        <div class="page-header">
            <button class="back-btn" onclick="showCommunities()">‚Üê</button>
            <div class="page-title" id="communityPageTitle">Community</div>
        </div>
        <div class="feed-container">
            <div id="communityDetail" class="loading">
                Loading community...
            </div>
            <div id="communityPosts" class="loading">
                Loading posts...
            </div>
        </div>
    </main>

    <button class="compose-btn" id="composeBtn" style="display: none;" onclick="openModal('composeModal')">+</button>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="authTitle">Sign Up</h3>
                <button class="close-btn" onclick="closeModal('authModal')">&times;</button>
            </div>
            <div id="authError"></div>
            <form id="authForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required minlength="3" maxlength="20">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="bio">Bio (Optional)</label>
                    <textarea id="bio" placeholder="Tell us about yourself..." maxlength="500"></textarea>
                </div>
                <button type="submit" class="btn" id="authSubmitBtn">Sign Up</button>
            </form>
            <p style="margin-top: 12px; color: #818384; font-size: 14px;">
                <span id="authToggleText">Already have an account?</span>
                <button type="button" class="btn-secondary" id="authToggleBtn" onclick="toggleAuthMode()">Sign In</button>
            </p>
        </div>
    </div>

    <!-- Create Community Modal -->
    <div class="modal" id="createCommunityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Community</h3>
                <button class="close-btn" onclick="closeModal('createCommunityModal')">&times;</button>
            </div>
            <div id="createCommunityError"></div>
            <form id="createCommunityForm">
                <div class="form-group">
                    <label for="communityName">Community Name</label>
                    <input type="text" id="communityName" required minlength="3" maxlength="25" pattern="[a-z0-9_]+" placeholder="programming">
                    <small>3-25 characters, lowercase, letters, numbers, and underscores only</small>
                </div>
                <div class="form-group">
                    <label for="communityDisplayName">Display Name</label>
                    <input type="text" id="communityDisplayName" required maxlength="50" placeholder="Programming">
                </div>
                <div class="form-group">
                    <label for="communityDescription">Description</label>
                    <textarea id="communityDescription" maxlength="500" placeholder="A community for programming discussions and help"></textarea>
                </div>
                <button type="submit" class="btn btn-community" id="createCommunitySubmitBtn">Create Community</button>
            </form>
        </div>
    </div>

    <!-- Compose Modal -->
    <div class="modal" id="composeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Post</h3>
                <button class="close-btn" onclick="closeModal('composeModal')">&times;</button>
            </div>
            <div id="composeError"></div>
            <form id="composeForm">
                <div class="form-group">
                    <label for="postCommunity">Community (Optional)</label>
                    <select id="postCommunity">
                        <option value="">General Feed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="postTitle">Title</label>
                    <input type="text" id="postTitle" required maxlength="200">
                </div>
                <div class="form-group">
                    <label for="postContent">Content</label>
                    <textarea id="postContent" required placeholder="Share your thoughts..." maxlength="10000"></textarea>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="isPrivate" style="width: auto; margin-right: 8px;">
                    <label for="isPrivate" style="display: inline;">Private post (only you can see this)</label>
                </div>
                <button type="submit" class="btn" id="composeSubmitBtn">Post</button>
            </form>
        </div>
    </div>

    <script>
        // App state
        let currentUser = null;
        let currentPage = 'feed'; // 'feed', 'communities', 'community', 'private'
        let communities = [];
        let posts = [];
        let currentCommunity = null;
        let isLoading = false;

        // Netlify Blobs API implementation
        const blobAPI = {
            async get(key) {
                try {
                    const response = await fetch(`/.netlify/functions/blobs?key=${encodeURIComponent(key)}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) return null;
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    return result.data;
                } catch (error) {
                    console.error('Error getting blob:', error);
                    return null;
                }
            },
            
            async set(key, value) {
                try {
                    const response = await fetch('/.netlify/functions/blobs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key, value })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error setting blob:', error);
                    throw error;
                }
            },
            
            async list(prefix = '') {
                try {
                    const response = await fetch(`/.netlify/functions/blobs?list=true&prefix=${encodeURIComponent(prefix)}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    return result.keys || [];
                } catch (error) {
                    console.error('Error listing blobs:', error);
                    return [];
                }
            },
            
            async delete(key) {
                try {
                    const response = await fetch('/.netlify/functions/blobs', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Error deleting blob:', error);
                    throw error;
                }
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUser();
            await loadCommunities();
            await loadPosts();
            updateUI();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Auth form
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            
            // Create community form
            document.getElementById('createCommunityForm').addEventListener('submit', handleCreateCommunity);
            
            // Compose form
            document.getElementById('composeForm').addEventListener('submit', handleCreatePost);
        }

        async function loadUser() {
            try {
                const userData = await blobAPI.get('current_user');
                if (userData) {
                    currentUser = userData;
                    const fullProfile = await blobAPI.get(`user_${userData.username}`);
                    if (fullProfile) {
                        currentUser.profile = fullProfile;
                    }
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        async function loadCommunities() {
            try {
                const communityKeys = await blobAPI.list('community_');
                const communityPromises = communityKeys.map(async (key) => {
                    try {
                        return await blobAPI.get(key);
                    } catch (error) {
                        console.error(`Error loading community ${key}:`, error);
                        return null;
                    }
                });
                
                const loadedCommunities = await Promise.all(communityPromises);
                communities = loadedCommunities
                    .filter(Boolean)
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Update community dropdown in compose modal
                updateCommunityDropdown();
                
            } catch (error) {
                console.error('Error loading communities:', error);
                communities = [];
            }
        }

        async function loadPosts() {
            try {
                if (!isLoading) {
                    isLoading = true;
                    updateFeedContent('<div class="loading">Loading...</div>');
                }
                
                const postKeys = await blobAPI.list('post_');
                const postPromises = postKeys.map(async (key) => {
                    try {
                        return await blobAPI.get(key);
                    } catch (error) {
                        console.error(`Error loading post ${key}:`, error);
                        return null;
                    }
                });
                
                const loadedPosts = await Promise.all(postPromises);
                posts = loadedPosts
                    .filter(Boolean)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
            } catch (error) {
                console.error('Error loading posts:', error);
                posts = [];
            } finally {
                isLoading = false;
            }
        }

        function updateUI() {
            updateAuthSection();
            updateNavMenu();
            updateComposeButton();
            
            if (currentPage === 'feed') {
                renderFeed();
            } else if (currentPage === 'communities') {
                renderCommunities();
            } else if (currentPage === 'community') {
                renderCommunityPage();
            } else if (currentPage === 'private') {
                renderPrivateFeed();
            }
        }

        function updateAuthSection() {
            const authSection = document.getElementById('authSection');
            
            if (currentUser) {
                authSection.innerHTML = `
                    <span class="user-info">
                        <div class="profile-avatar-small">${currentUser.username.charAt(0).toUpperCase()}</div>
                        @${escapeHtml(currentUser.username)}
                    </span>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                `;
            } else {
                authSection.innerHTML = `
                    <button class="btn btn-secondary" onclick="openAuthModal('signin')">Sign In</button>
                    <button class="btn" onclick="openAuthModal('signup')">Sign Up</button>
                `;
            }
        }

        function updateNavMenu() {
            const navMenu = document.getElementById('navMenu');
            navMenu.style.display = currentUser ? 'flex' : 'none';
            
            // Update active button
            document.querySelectorAll('.nav-menu button').forEach(btn => btn.classList.remove('active'));
            if (currentPage === 'feed') {
                document.getElementById('feedBtn').classList.add('active');
            } else if (currentPage === 'communities' || currentPage === 'community') {
                document.getElementById('communitiesBtn').classList.add('active');
            } else if (currentPage === 'private') {
                document.getElementById('privateBtn').classList.add('active');
            }
        }

        function updateComposeButton() {
            const composeBtn = document.getElementById('composeBtn');
            composeBtn.style.display = currentUser ? 'block' : 'none';
            
            // Change button style based on current page
            if (currentPage === 'community') {
                composeBtn.classList.add('community');
            } else {
                composeBtn.classList.remove('community');
            }
        }

        function updateCommunityDropdown() {
            const select = document.getElementById('postCommunity');
            select.innerHTML = '<option value="">General Feed</option>';
            
            communities.forEach(community => {
                const option = document.createElement('option');
                option.value = community.name;
                option.textContent = community.displayName;
                select.appendChild(option);
            });
        }

        // Page navigation functions
        function showFeed() {
            currentPage = 'feed';
            hideAllPages();
            document.getElementById('mainFeed').style.display = 'block';
            updateUI();
        }

        function showCommunities() {
            currentPage = 'communities';
            hideAllPages();
            document.getElementById('communitiesPage').style.display = 'block';
            updateUI();
        }

        function showCommunity(communityName) {
            currentPage = 'community';
            currentCommunity = communityName;
            hideAllPages();
            document.getElementById('communityPage').style.display = 'block';
            document.getElementById('communityPageTitle').textContent = communities.find(c => c.name === communityName)?.displayName || communityName;
            updateUI();
            
            // Pre-select community in compose modal
            document.getElementById('postCommunity').value = communityName;
        }

        function showPrivateFeed() {
            currentPage = 'private';
            hideAllPages();
            document.getElementById('mainFeed').style.display = 'block';
            updateUI();
        }

        function hideAllPages() {
            document.getElementById('mainFeed').style.display = 'none';
            document.getElementById('communitiesPage').style.display = 'none';
            document.getElementById('communityPage').style.display = 'none';
        }

        // Feed rendering functions
        function renderFeed() {
            const filteredPosts = posts.filter(post => !post.isPrivate);
            updateFeedContent(renderPostList(filteredPosts, 'No public posts yet!'));
        }

        function renderPrivateFeed() {
            const filteredPosts = posts.filter(post => post.isPrivate && post.author === currentUser?.username);
            updateFeedContent(renderPostList(filteredPosts, 'No private posts yet!'));
        }

        function renderCommunities() {
            const communitiesList = document.getElementById('communitiesList');
            const createBtn = document.getElementById('createCommunityBtn');
            
            createBtn.style.display = currentUser ? 'block' : 'none';
            
            if (communities.length === 0) {
                communitiesList.innerHTML = `
                    <div class="empty-state">
                        <p>No communities yet!</p>
                        ${currentUser ? '<p>Be the first to create one.</p>' : '<p>Sign in to create communities.</p>'}
                    </div>
                `;
                return;
            }

            const communitiesHTML = communities.map(community => {
                const postCount = posts.filter(post => post.communityName === community.name && !post.isPrivate).length;
                
                return `
                    <div class="community-card" onclick="showCommunity('${community.name}')">
                        <div class="community-header">
                            <div class="community-info">
                                <h3>${escapeHtml(community.displayName)}</h3>
                                <div class="community-name">c/${escapeHtml(community.name)}</div>
                                ${community.description ? `<div class="community-description">${escapeHtml(community.description)}</div>` : ''}
                            </div>
                            ${community.isPrivate ? '<div class="community-badge">Private</div>' : ''}
                        </div>
                        <div class="community-stats">
                            <span>${postCount} posts</span>
                            <span>${community.members?.length || 1} members</span>
                            <span>Created ${formatDate(community.createdAt)}</span>
                        </div>
                    </div>
                `;
            }).join('');

            communitiesList.innerHTML = communitiesHTML;
        }

        function renderCommunityPage() {
            if (!currentCommunity) return;
            
            const community = communities.find(c => c.name === currentCommunity);
            if (!community) return;

            const communityDetail = document.getElementById('communityDetail');
            const postCount = posts.filter(post => post.communityName === community.name && !post.isPrivate).length;
            
            communityDetail.innerHTML = `
                <div class="community-detail-header">
                    <h1>${escapeHtml(community.displayName)}</h1>
                    <div class="community-name">c/${escapeHtml(community.name)}</div>
                    ${community.description ? `<div class="description">${escapeHtml(community.description)}</div>` : ''}
                    <div class="community-detail-stats">
                        <span>${postCount} posts</span>
                        <span>${community.members?.length || 1} members</span>
                        <span>Created by @${escapeHtml(community.createdBy)}</span>
                        <span>${formatDate(community.createdAt)}</span>
                    </div>
                </div>
            `;

            const communityPosts = posts.filter(post => post.communityName === community.name && !post.isPrivate);
            document.getElementById('communityPosts').innerHTML = renderPostList(communityPosts, 'No posts in this community yet!');
        }

        function renderPostList(postList, emptyMessage) {
            if (postList.length === 0) {
                return `<div class="empty-state"><p>${emptyMessage}</p></div>`;
            }

            return postList.map(post => {
                const community = communities.find(c => c.name === post.communityName);
                
                return `
                    <div class="post-card ${post.isPrivate ? 'private' : ''}">
                        <div class="post-header">
                            <span class="username">
                                <div class="profile-avatar-small">${post.author.charAt(0).toUpperCase()}</div>
                                @${escapeHtml(post.author)}
                            </span>
                            ${post.isPrivate ? '<span class="private-badge">Private</span>' : ''}
                            <span class="timestamp">${formatTimestamp(post.timestamp)}</span>
                        </div>
                        
                        <div class="post-body">
                            ${post.communityName && community ? `
                                <div class="post-community">
                                    <a href="#" class="post-community-link" onclick="showCommunity('${post.communityName}'); return false;">
                                        c/${escapeHtml(community.displayName)}
                                    </a>
                                </div>
                            ` : ''}
                            <h3 class="post-title">${escapeHtml(post.title)}</h3>
                            <div class="post-content">${escapeHtml(post.content || '').substring(0, 300)}${post.content && post.content.length > 300 ? '...' : ''}</div>
                        </div>
                        
                        <div class="post-actions">
                            <button class="action-btn">
                                <span>‚¨ÜÔ∏è</span>
                                <span>Vote</span>
                            </button>
                            <button class="action-btn">
                                <span>üí¨</span>
                                <span>${post.replies ? post.replies.length : 0}</span>
                            </button>
                            ${currentUser && currentUser.username === post.author ? `
                                <button class="action-btn" onclick="deletePost('${post.id}')">
                                    <span>üóëÔ∏è</span>
                                    <span>Delete</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateFeedContent(html) {
            document.getElementById('feed').innerHTML = html;
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openAuthModal(mode) {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const toggleText = document.getElementById('authToggleText');
            const toggleBtn = document.getElementById('authToggleBtn');
            const submitBtn = document.getElementById('authSubmitBtn');
            const form = document.getElementById('authForm');
            
            document.getElementById('authError').innerHTML = '';
            
            if (mode === 'signup') {
                title.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleBtn.textContent = 'Sign In';
                submitBtn.textContent = 'Sign Up';
                form.dataset.mode = 'signup';
            } else {
                title.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                toggleBtn.textContent = 'Sign Up';
                submitBtn.textContent = 'Sign In';
                form.dataset.mode = 'signin';
            }
            
            modal.style.display = 'block';
        }

        function toggleAuthMode() {
            const form = document.getElementById('authForm');
            const currentMode = form.dataset.mode;
            openAuthModal(currentMode === 'signup' ? 'signin' : 'signup');
        }

        // Auth functions
        async function handleAuth(e) {
            e.preventDefault();
            const form = e.target;
            const mode = form.dataset.mode;
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const bio = document.getElementById('bio').value.trim();
            const errorDiv = document.getElementById('authError');
            const submitBtn = document.getElementById('authSubmitBtn');

            errorDiv.innerHTML = '';
            
            if (username.length < 3) {
                showError('authError', 'Username must be at least 3 characters long');
                return;
            }
            
            if (password.length < 6) {
                showError('authError', 'Password must be at least 6 characters long');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Loading...';

                if (mode === 'signup') {
                    const existingUser = await blobAPI.get(`user_${username}`);
                    const pendingUser = await blobAPI.get(`pending_user_${username}`);
                    
                    if (existingUser || pendingUser) {
                        showError('authError', 'Username already exists or is pending approval!');
                        return;
                    }
                    
                    const newPendingUser = { 
                        username, 
                        password,
                        bio: bio || `Hello! I'm ${username}`,
                        createdAt: new Date().toISOString(),
                        status: 'pending',
                        isAdmin: false
                    };
                    
                    await blobAPI.set(`pending_user_${username}`, newPendingUser);
                    
                    closeModal('authModal');
                    showSuccessMessage('Account created! Waiting for admin approval.');
                    
                } else {
                    const user = await blobAPI.get(`user_${username}`);
                    
                    if (!user) {
                        const pendingUser = await blobAPI.get(`pending_user_${username}`);
                        if (pendingUser) {
                            showError('authError', 'Your account is still pending admin approval.');
                        } else {
                            showError('authError', 'Invalid username or password');
                        }
                        return;
                    }
                    
                    if (user.password !== password) {
                        showError('authError', 'Invalid username or password');
                        return;
                    }
                    
                    currentUser = { username, profile: user };
                    await blobAPI.set('current_user', currentUser);
                    
                    closeModal('authModal');
                    updateUI();
                    showSuccessMessage('Welcome back!');
                }
                
                form.reset();
                
            } catch (error) {
                console.error('Auth error:', error);
                showError('authError', 'Something went wrong. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = mode === 'signup' ? 'Sign Up' : 'Sign In';
            }
        }

        async function logout() {
            try {
                currentUser = null;
                await blobAPI.delete('current_user');
                showFeed();
                updateUI();
                showSuccessMessage('Logged out successfully!');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Community functions
        async function handleCreateCommunity(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showError('createCommunityError', 'Please sign in to create a community');
                return;
            }
            
            const name = document.getElementById('communityName').value.trim().toLowerCase();
            const displayName = document.getElementById('communityDisplayName').value.trim();
            const description = document.getElementById('communityDescription').value.trim();
            const submitBtn = document.getElementById('createCommunitySubmitBtn');
            const errorDiv = document.getElementById('createCommunityError');
            
            errorDiv.innerHTML = '';
            
            // Validation
            if (!/^[a-z0-9_]{3,25}$/.test(name)) {
                showError('createCommunityError', 'Community name must be 3-25 characters, lowercase, alphanumeric and underscores only');
                return;
            }

            if (!displayName || displayName.length > 50) {
                showError('createCommunityError', 'Display name is required and must be 50 characters or less');
                return;
            }

            if (description.length > 500) {
                showError('createCommunityError', 'Description must be 500 characters or less');
                return;
            }

            // Check if community already exists
            const existingCommunity = await blobAPI.get(`community_${name}`);
            if (existingCommunity) {
                showError('createCommunityError', 'Community name already exists');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating...';
                
                const community = {
                    name,
                    displayName,
                    description,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString(),
                    isPrivate: false,
                    moderators: [currentUser.username],
                    members: [currentUser.username],
                    rules: []
                };
                
                await blobAPI.set(`community_${name}`, community);
                communities.unshift(community);
                
                closeModal('createCommunityModal');
                document.getElementById('createCommunityForm').reset();
                
                updateCommunityDropdown();
                renderCommunities();
                showSuccessMessage(`Community "${displayName}" created successfully!`);
                
            } catch (error) {
                console.error('Error creating community:', error);
                showError('createCommunityError', 'Failed to create community. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Community';
            }
        }

        // Post functions
        async function handleCreatePost(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showError('composeError', 'Please sign in to create a post');
                return;
            }
            
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const communityName = document.getElementById('postCommunity').value;
            const isPrivate = document.getElementById('isPrivate').checked;
            const submitBtn = document.getElementById('composeSubmitBtn');
            const errorDiv = document.getElementById('composeError');
            
            errorDiv.innerHTML = '';
            
            if (!title || !content) {
                showError('composeError', 'Please fill in both title and content');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Posting...';
                
                const post = {
                    id: `post_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    title,
                    content,
                    author: currentUser.username,
                    timestamp: new Date().toISOString(),
                    isPrivate,
                    communityName: communityName || null,
                    replies: []
                };
                
                await blobAPI.set(post.id, post);
                posts.unshift(post);
                
                closeModal('composeModal');
                document.getElementById('composeForm').reset();
                
                updateUI();
                showSuccessMessage('Post created successfully!');
                
            } catch (error) {
                console.error('Error creating post:', error);
                showError('composeError', 'Failed to create post. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Post';
            }
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }
            
            try {
                await blobAPI.delete(postId);
                posts = posts.filter(p => p.id !== postId);
                updateUI();
                showSuccessMessage('Post deleted successfully!');
            } catch (error) {
                console.error('Error deleting post:', error);
                showError('general', 'Failed to delete post. Please try again.');
            }
        }

        // Utility functions
        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '80px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd';
            return date.toLocaleDateString();
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short' 
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>
